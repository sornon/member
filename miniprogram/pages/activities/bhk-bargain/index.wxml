<custom-nav title="" theme="transparent"></custom-nav>
<view class="bhk-hero" style="margin-top: -{{navHeight}}px;">
  <image class="bhk-hero__image" src="{{heroImage}}" mode="aspectFill"></image>
  <view class="bhk-hero__mask"></view>
</view>

<view class="bhk-page">
  <block wx:if="{{loading}}">
    <view class="bhk-card bhk-state">活动情报加载中...</view>
  </block>
  <block wx:elif="{{!activity}}">
    <view class="bhk-card bhk-state bhk-state--error">
      {{singlePageMode ? '查看活动详情点击右下角，前往小程序' : '活动暂不可用，请稍后再试'}}
    </view>
  </block>
  <block wx:else>
    <view class="bhk-banner">
      <view class="bhk-banner__mask"></view>
      <view class="bhk-banner__content">
        <view wx:if="{{ticketOwned}}" class="bhk-banner__badge">已获得通行证</view>
        <view class="bhk-banner__title">{{activity.title || '感恩节 · BHK56 品鉴会'}}</view>
        <view class="bhk-banner__subtitle">顶级雪茄 · 限量 {{bargain.stock || stockRemaining || 0}} 席 · 感恩节回馈</view>
        <view class="bhk-banner__pill-row">
          <view class="bhk-banner__pill" style="width: 230rpx;">剩余时间：{{countdown}}</view>
          <view class="bhk-banner__pill bhk-banner__pill--accent">余票：{{stockRemaining}}/{{bargain.stock}}</view>
        </view>
        <view class="bhk-banner__pill-row">
          <view class="bhk-banner__pill bhk-banner__pill--link" bindtap="handleOpenLocation">地点：{{mapLocation.address || activity.location || '查看地图'}}
          </view>
        </view>
        <view class="bhk-banner__pill-row" wx:if="{{ticketOwned}}">
          <view class="bhk-banner__pill bhk-banner__pill--notice">
            门票购买成功，请在
            <text class="bhk-banner__link" bindtap="navigateToRights">权益</text>
            中查看
          </view>
        </view>
      </view>
    </view>

    <view class="bhk-card bhk-price-card">
      <view class="bhk-price-card__row">
        <text class="bhk-price-card__original">原价 ¥{{basePrice}}</text>
        <text class="bhk-price-card__current {{floorReached ? 'bhk-price-card__current--floor' : ''}}">{{floorReached ? '价格触底' : '当前票价'}} ¥{{currentPrice}}</text>
      </view>
      <view class="bhk-price-card__hint">
      </view>
      <view class="bhk-price-card__progress">已减 ¥{{totalDiscount}}</view>
      <view class="bhk-price-card__perks" wx:if="{{perks.length}}">
        <view class="bhk-price-card__perk" wx:for="{{perks}}" wx:key="perk">{{item}}</view>
      </view>
    </view>

    <view class="bhk-card bhk-turntable">
      <view class="bhk-turntable__header">
        <view class="bhk-turntable__header-left">
          <view class="bhk-banner__member">
            <view class="bhk-banner__avatar-wrapper">
              <image class="bhk-banner__avatar" src="{{(member && member.avatarUrl) || defaultAvatar}}" mode="cover"></image>
              <image wx:if="{{member && member.avatarFrame}}" class="bhk-banner__avatar-frame" src="{{member.avatarFrame}}" mode="scaleToFill"></image>
            </view>
            <view class="bhk-banner__member-info">
              <view class="bhk-banner__member-name">{{member ? (member.nickName || '无名仙友') : '无名仙友'}}</view>
              <view class="bhk-banner__member-tags">
                <image
                  wx:if="{{memberTitleImage}}"
                  class="bhk-banner__member-tag bhk-banner__member-tag--image"
                  src="{{memberTitleImage}}"
                  mode="heightFix"
                ></image>
                <view wx:else class="bhk-banner__member-tag">{{memberTitleName || '称号待佩戴'}}</view>
              </view>
            </view>
          </view>
        </view>
        <view class="bhk-turntable__header-right">
          <view class="bhk-turntable__summary">
            <text class="bhk-turntable__label">剩余砍价次数</text>
            <text class="bhk-turntable__value">{{remainingSpins}}</text>
          </view>
          <view class="bhk-turntable__reward" wx:if="{{realmReward}}">
            <view class="bhk-turntable__reward-text">{{realmReward.realmName || '境界奖励'}}</view>
            <view class="bhk-turntable__reward-pill {{divineHandReady ? 'bhk-turntable__reward-pill--glow' : ''}}">
              <text wx:if="{{realmReward.type === 'divine' && divineHandReady}}">神之一手已激活</text>
              <text wx:elif="{{realmReward.type === 'divine' && realmReward.used}}">神之一手已使用</text>
              <text wx:elif="{{realmReward.type === 'divine'}}">神之一手待触发</text>
              <text wx:elif="{{realmReward.type === 'boost'}}">剩余 {{realmReward.remaining}} / {{realmReward.total}} 次</text>
              <text wx:else>未解锁</text>
            </view>
          </view>
        </view>
      </view>
      <view class="bhk-turntable__wheel">
        <view class="bhk-turntable__segments">
          <block wx:for="{{displaySegments}}" wx:key="index">
            <view class="bhk-turntable__segment {{activeSegmentIndex === index ? 'bhk-turntable__segment--active' : ''}}">
              {{item.label}}
            </view>
          </block>
        </view>
        <button class="bhk-turntable__button" type="primary" loading="{{spinning}}" disabled="{{spinning || (!divineHandReady && remainingSpins <= 0)}}" bindtap="handleSpin">
          {{spinning ? '砍价中...' : (divineHandReady ? '直击底价' : '开始砍价')}}
        </button>
      </view>
    </view>

    <view class="bhk-card bhk-share">
      <view class="bhk-section-title">分享助力</view>
      <view class="bhk-share__desc">“被助力”<text style="color:skyblue;">次数不限</text>，但“助力他人”只有<text style="color: tomato;">1</text>次，请斟酌使用，使用后双方各得1次砍价数。</view>
      <view class="bhk-share__helpers" wx:if="{{shareContext && shareContext.helpers && shareContext.helpers.length}}">
        <view class="bhk-share__helper" wx:for="{{shareContext.helpers}}" wx:key="id">
          <view class="bhk-share__role">{{item.role || '助力者'}}</view>
          <view class="bhk-share__member">
            <view class="bhk-share__avatar-wrapper">
              <image class="bhk-share__avatar" src="{{item.avatar || defaultAvatar}}" mode="cover"></image>
              <image
                wx:if="{{item.avatarFrame}}"
                class="bhk-share__avatar-frame"
                src="{{item.avatarFrame}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="bhk-share__member-info">
              <view class="bhk-share__member-name">{{item.nickname || '神秘会员'}}</view>
              <view class="bhk-share__member-tags">
                <image
                  wx:if="{{item.titleImage}}"
                  class="bhk-share__member-tag bhk-share__member-tag--image"
                  src="{{item.titleImage}}"
                  mode="heightFix"
                ></image>
                <view wx:else class="bhk-share__member-tag">{{item.titleName || '称号待佩戴'}}</view>
              </view>
            </view>
          </view>
          <view class="bhk-share__action" wx:if="{{index === 0}}">
            <button
              wx:if="{{shareContext.canAssist && !shareContext.assisted}}"
              class="bhk-share__assist-button"
              type="primary"
              size="mini"
              bindtap="handleAssist"
            >
              助力
            </button>
            <view wx:elif="{{shareContext.assisted}}" class="bhk-share__assist-text">已助力</view>
          </view>
          <view wx:else class="bhk-share__action"></view>
        </view>
      </view>
      <view class="bhk-share__actions">
        <button class="bhk-share__button" type="primary" open-type="share">分享给好友</button>
        <button
          class="bhk-share__button"
          type="default"
          bindtap="handleShareToTimeline"
          disabled="{{!shareTimelineSupported}}"
        >
          晒到朋友圈
        </button>
      </view>
      <view wx:if="{{shareTimelineMessage}}" class="bhk-share__hint">{{shareTimelineMessage}}</view>
    </view>

    <view class="bhk-card bhk-info">
      <view class="bhk-section-title">礼遇与规则</view>
      <view class="bhk-info__list">
        <view class="bhk-info__item">持"感恩节活动"会员权益任意时间到店使用。</view>
        <view class="bhk-info__item">软饮畅饮，伴手礼 BHK56 雪茄一支。</view>
        <view class="bhk-info__item">余票与倒计时实时更新，售罄即止。</view>
        <view class="bhk-info__item">票券不可转售或退款。</view>
        <view class="bhk-info__item">购票消费可同时提升修为和灵石。</view>
        <view class="bhk-info__item">本次活动是修仙晋升的<text style="color:tomato;">大好机会，不容错过！</text></view>
      </view>
    </view>
  </block>
</view>

<view class="bhk-footer" wx:if="{{activity}}">
  <view class="bhk-footer__price">¥{{currentPrice}}</view>
  <view class="bhk-footer__note">{{ticketOwned ? '已持通行证，可在权益中查看' : '仅剩' + stockRemaining + '张'}}</view>
  <button class="bhk-footer__button" type="primary" disabled="{{stockRemaining <= 0 || ticketOwned}}" bindtap="handlePurchase">{{ticketOwned ? '已购票' : '立即购票'}}</button>
</view>

<view class="bhk-overlay" wx:if="{{resultOverlay}}">
  <view class="bhk-overlay__card">
    <view class="bhk-overlay__title">{{resultOverlay.message}}</view>
    <view class="bhk-overlay__amount">-¥{{resultOverlay.amount}}</view>
    <button class="bhk-overlay__button" type="primary" bindtap="closeResultOverlay">知道了</button>
  </view>
</view>
