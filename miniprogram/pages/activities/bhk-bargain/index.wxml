<custom-nav title="感恩节 · BHK56 限量品鉴" theme="dark"></custom-nav>
<view class="bhk-page">
  <block wx:if="{{loading}}">
    <view class="bhk-card bhk-state">活动情报加载中...</view>
  </block>
  <block wx:elif="{{!activity}}">
    <view class="bhk-card bhk-state bhk-state--error">活动暂不可用，请稍后再试</view>
  </block>
  <block wx:else>
    <view class="bhk-banner" style="background-image: url({{heroImage}});">
      <view class="bhk-banner__mask"></view>
      <view class="bhk-banner__content">
        <view class="bhk-banner__title">{{activity.title || '感恩节 · BHK56 品鉴会'}}</view>
        <view class="bhk-banner__subtitle">顶级雪茄 · 限量 15 席 · 感恩节回馈</view>
        <view class="bhk-banner__pill-row">
          <view class="bhk-banner__pill" style="width: 230rpx;">剩余时间：{{countdown}}</view>
          <view class="bhk-banner__pill bhk-banner__pill--accent">余票：{{stockRemaining}}/{{bargain.stock}}</view>
        </view>
        <view class="bhk-banner__pill-row">
          <view class="bhk-banner__pill bhk-banner__pill--link" bindtap="handleOpenLocation">地点：{{mapLocation.address || activity.location || '查看地图'}}
          </view>
        </view>
      </view>
    </view>

    <view class="bhk-card bhk-price-card">
      <view class="bhk-price-card__row">
        <text class="bhk-price-card__original">原价 ¥{{basePrice}}</text>
        <text class="bhk-price-card__current {{floorReached ? 'bhk-price-card__current--floor' : ''}}">{{floorReached ? '价格触底' : '当前票价'}} ¥{{currentPrice}}</text>
      </view>
      <view class="bhk-price-card__hint">
      </view>
      <view class="bhk-price-card__progress">已减 ¥{{totalDiscount}}</view>
      <view class="bhk-price-card__perks" wx:if="{{perks.length}}">
        <view class="bhk-price-card__perk" wx:for="{{perks}}" wx:key="perk">{{item}}</view>
      </view>
    </view>

    <view class="bhk-card bhk-turntable">
      <view class="bhk-turntable__header">
        <view class="bhk-turntable__header-left">
          <view class="bhk-banner__member">
            <view class="bhk-banner__avatar-wrapper">
              <image class="bhk-banner__avatar" src="{{(member && member.avatarUrl) || defaultAvatar}}" mode="cover"></image>
              <image wx:if="{{member && member.avatarFrame}}" class="bhk-banner__avatar-frame" src="{{member.avatarFrame}}" mode="scaleToFill"></image>
            </view>
            <view class="bhk-banner__member-info">
              <view class="bhk-banner__member-name">{{member ? (member.nickName || '无名仙友') : '无名仙友'}}</view>
              <view class="bhk-banner__member-tags">
                <image
                  wx:if="{{memberTitleImage}}"
                  class="bhk-banner__member-tag bhk-banner__member-tag--image"
                  src="{{memberTitleImage}}"
                  mode="heightFix"
                ></image>
                <view wx:else class="bhk-banner__member-tag">{{memberTitleName || '称号待佩戴'}}</view>
              </view>
            </view>
          </view>
        </view>
        <view class="bhk-turntable__header-right">
          <view class="bhk-turntable__summary">
            <text class="bhk-turntable__label">剩余砍价次数</text>
            <text class="bhk-turntable__value">{{remainingSpins}}</text>
          </view>
          <view class="bhk-turntable__reward" wx:if="{{realmReward}}">
            <view class="bhk-turntable__reward-text">{{realmReward.realmName || '境界奖励'}}</view>
            <view class="bhk-turntable__reward-pill {{divineHandReady ? 'bhk-turntable__reward-pill--glow' : ''}}">
              <text wx:if="{{realmReward.type === 'divine' && divineHandReady}}">神之一手已激活</text>
              <text wx:elif="{{realmReward.type === 'divine' && realmReward.used}}">神之一手已使用</text>
              <text wx:elif="{{realmReward.type === 'divine'}}">神之一手待触发</text>
              <text wx:elif="{{realmReward.type === 'boost'}}">剩余 {{realmReward.remaining}} / {{realmReward.total}} 次</text>
              <text wx:else>未解锁</text>
            </view>
          </view>
        </view>
      </view>
      <view class="bhk-turntable__wheel">
        <view class="bhk-turntable__segments">
          <block wx:for="{{displaySegments}}" wx:key="index">
            <view class="bhk-turntable__segment {{activeSegmentIndex === index ? 'bhk-turntable__segment--active' : ''}}">
              {{item.label}}
            </view>
          </block>
        </view>
        <button class="bhk-turntable__button" type="primary" loading="{{spinning}}" disabled="{{spinning || (!divineHandReady && remainingSpins <= 0)}}" bindtap="handleSpin">
          {{spinning ? '砍价中...' : (divineHandReady ? '直击底价' : '开始砍价')}}
        </button>
      </view>
    </view>

    <view class="bhk-card bhk-share">
      <view class="bhk-section-title">分享助力</view>
      <view class="bhk-share__desc">每人只有一次助力他人的机会，请斟酌使用，使用后双方各得1次砍价数，接受助力次数不限。</view>
      <view class="bhk-share__helpers" wx:if="{{shareContext && shareContext.helpers && shareContext.helpers.length}}">
        <view class="bhk-share__helper" wx:for="{{shareContext.helpers}}" wx:key="id">
          <view class="bhk-share__role">{{item.role || '助力者'}}</view>
          <view class="bhk-share__member">
            <view class="bhk-share__avatar-wrapper">
              <image class="bhk-share__avatar" src="{{item.avatar || defaultAvatar}}" mode="cover"></image>
              <image
                wx:if="{{item.avatarFrame}}"
                class="bhk-share__avatar-frame"
                src="{{item.avatarFrame}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="bhk-share__member-info">
              <view class="bhk-share__member-name">{{item.nickname || '神秘会员'}}</view>
              <view class="bhk-share__member-tags">
                <image
                  wx:if="{{item.titleImage}}"
                  class="bhk-share__member-tag bhk-share__member-tag--image"
                  src="{{item.titleImage}}"
                  mode="heightFix"
                ></image>
                <view wx:else class="bhk-share__member-tag">{{item.titleName || '称号待佩戴'}}</view>
              </view>
            </view>
          </view>
          <view class="bhk-share__action" wx:if="{{index === 0}}">
            <button
              wx:if="{{shareContext.canAssist && !shareContext.assisted}}"
              class="bhk-share__assist-button"
              type="primary"
              size="mini"
              bindtap="handleAssist"
            >
              助力
            </button>
            <view wx:elif="{{shareContext.assisted}}" class="bhk-share__assist-text">已助力</view>
          </view>
          <view wx:else class="bhk-share__action"></view>
        </view>
      </view>
      <view class="bhk-share__actions">
        <button class="bhk-share__button" type="primary" open-type="share">分享给好友</button>
        <button class="bhk-share__button" type="default" bindtap="handleShareToTimeline">晒到朋友圈</button>
      </view>
    </view>

    <view class="bhk-card bhk-info">
      <view class="bhk-section-title">礼遇与规则</view>
      <view class="bhk-info__list">
        <view class="bhk-info__item">伴手礼 Cohiba Behike 56 雪茄一支。</view>
        <view class="bhk-info__item">余票与倒计时实时更新，售罄即止。</view>
        <view class="bhk-info__item">票券不可转售或退款。</view>
        <view class="bhk-info__item">现场品尝，软饮畅饮。</view>
      </view>
    </view>
  </block>
</view>

<view class="bhk-footer" wx:if="{{activity}}">
  <view class="bhk-footer__price">¥{{currentPrice}}</view>
  <view class="bhk-footer__note">仅剩{{stockRemaining}}张</view>
  <button class="bhk-footer__button" type="primary" disabled="{{stockRemaining <= 0}}" bindtap="handlePurchase">立即购票</button>
</view>

<view class="bhk-overlay" wx:if="{{resultOverlay}}">
  <view class="bhk-overlay__card">
    <view class="bhk-overlay__title">{{resultOverlay.message}}</view>
    <view class="bhk-overlay__amount">-¥{{resultOverlay.amount}}</view>
    <button class="bhk-overlay__button" type="primary" bindtap="closeResultOverlay">知道了</button>
  </view>
</view>

<view class="bhk-overlay" wx:if="{{showRules}}">
      <view class="bhk-overlay__card bhk-overlay__card--wide">
        <view class="bhk-overlay__title">活动规则</view>
      <view class="bhk-overlay__rules">
        <view class="bhk-overlay__rule">· 默认 3 次砍价，修仙境界加成最高 +{{memberBoost}} 次。</view>
        <view class="bhk-overlay__rule">· 每次抽奖随机减免票价，底价隐藏，抽完仍可原价购票。</view>
        <view class="bhk-overlay__rule">· 分享好友/朋友圈可互得 1 次砍价机会，助力他人仅 1 次。</view>
        <view class="bhk-overlay__rule">· 限量 15 张票，售罄则停止砍价与购票。</view>
      </view>
      <button class="bhk-overlay__button" type="primary" bindtap="toggleRules">关闭</button>
    </view>
</view>
