<custom-nav title="修仙等级" theme="dark"></custom-nav>
<view class="container">
  <view wx:if="{{loading}}" class="card">
    <text>加载中...</text>
  </view>

  <view wx:if="{{!loading}}">
    <view class="card member-card">
      <view class="section-title">修仙等级</view>
      <view class="current-level">{{currentLevel ? currentLevel.displayName : '炼气期 · 一层'}}</view>
      <view class="current-summary" wx:if="{{currentLevel && currentLevel.realmDescription}}">{{currentLevel.realmDescription}}</view>
      <view class="current-stats">
        <text class="stat">当前修为 {{formatExperience(member.experience || 0)}}</text>
        <text class="stat" wx:if="{{nextLevel}}">下一级 {{nextLevel.displayName}}</text>
      </view>
      <view class="progress-bar">
        <view class="progress-inner" style="{{progressStyle}}"></view>
      </view>
      <view class="progress-text" wx:if="{{nextLevel}}">距离 {{nextLevel.displayName}} 还差 {{formatCurrency(progress ? progress.nextDiff : 0)}}</view>
      <view class="progress-text" wx:else>恭喜飞升圆满，尊享终极特权</view>
      <view wx:if="{{breakthroughLevel}}" class="breakthrough-hint">
        <text class="breakthrough-hint__text">修为已圆满，请突破至 {{breakthroughLevel.displayName || breakthroughLevel.name}}。</text>
        <text class="breakthrough-hint__reward">奖励：{{breakthroughRewardText}}</text>
      </view>
      <button
        wx:if="{{breakthroughLevel}}"
        class="breakthrough-button"
        hover-class="breakthrough-button--hover"
        size="mini"
        loading="{{breakthroughLoading}}"
        disabled="{{breakthroughLoading}}"
        bindtap="handleBreakthrough"
      >突破境界</button>
      <view class="milestone-hint" wx:if="{{upcomingMilestone}}">
        <text class="milestone-tag">境界大奖</text>
        <text class="milestone-text">冲刺至 {{upcomingMilestone.displayName}} 可得 {{upcomingMilestone.milestoneReward}}</text>
      </view>
    </view>

    <view class="card realm-card" wx:if="{{visibleRealms.length}}">
      <view class="section-title">主境界进阶</view>
      <view class="realm-grid">
        <view class="realm-item" wx:for="{{visibleRealms}}" wx:key="realmKey">
          <view class="realm-header">
            <text class="realm-name">{{item.realm}}</text>
            <text class="realm-range">{{formatCurrency(item.start)}} ~ {{formatCurrency(item.end)}}</text>
          </view>
          <view class="realm-desc" wx:if="{{item.description}}">{{item.description}}</view>
          <view class="realm-milestone" wx:if="{{item.milestoneReward}}">
            <text class="reward-label">{{item.milestoneType ? item.milestoneType + '：' : '境界大奖：'}}</text>
            <text class="reward-text">{{item.milestoneReward}}</text>
            <text class="milestone-threshold" wx:if="{{item.milestoneThreshold}}">（累计 {{formatCurrency(item.milestoneThreshold)}} 解锁）</text>
          </view>
        </view>
      </view>
    </view>

    <view class="card">
      <view class="section-title">等级列表</view>
      <view class="level-toolbar" wx:if="{{!isAdmin}}">
        <view class="toggle-past" bindtap="onTogglePastLevels">
          {{showPastLevels ? '隐藏过往等级' : '查看过往等级'}}
        </view>
      </view>
      <view wx:for="{{visibleLevels}}" wx:key="_id" class="level-item {{item.milestoneReward ? 'level-item--milestone' : ''}}">
        <view class="level-rank" style="{{item.badgeStyle}}">
          <text class="rank-realm">{{item.realmShort}}</text>
          <text class="rank-stage">{{item.subLevelLabel}}</text>
        </view>
        <view class="level-info">
          <view class="level-title">LV{{item.order}} · {{item.name}}</view>
          <view class="level-meta">
            <text>修为达到 {{item.experienceRequirement}} 点</text>
          </view>
          <view class="level-desc" wx:if="{{item.subLevel === 1 && item.realmDescription}}">{{item.realmDescription}}</view>
          <view class="level-virtual" wx:if="{{item.virtualRewards && item.virtualRewards.length}}">
            <text class="reward-label">常规奖励：</text>
            <view class="reward-list">
              <text class="reward-text" wx:for="{{item.virtualRewards}}" wx:key="index">{{item}}</text>
            </view>
          </view>
          <view class="level-milestone" wx:if="{{item.milestoneReward}}">
            <text class="reward-label">境界突破：</text>
            <text class="reward-text">{{item.milestoneReward}}</text>
            <text class="reward-type" wx:if="{{item.milestoneType}}">（{{item.milestoneType}}）</text>
          </view>
          <view class="level-bonus" wx:if="{{item.rewards && item.rewards.length}}">
            <text class="reward-label">实体权益：</text>
            <text class="reward-text" wx:for="{{item.rewards}}" wx:key="index">{{item}}</text>
          </view>
          <view class="level-actions-row" wx:if="{{item.hasRewards}}">
            <button
              wx:if="{{item.claimable}}"
              class="claim-button claim-button--active"
              type="default"
              size="mini"
              data-level-id="{{item._id}}"
              bindtap="onClaimReward"
            >领取奖励</button>
            <button
              wx:elif="{{!item.claimed}}"
              class="claim-button claim-button--disabled"
              type="default"
              size="mini"
              disabled
            >未达成</button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
