<custom-nav title="ç§˜å¢ƒç³»ç»Ÿ"></custom-nav>
<view class="page">
  <view class="tab-bar">
    <view
      class="tab-item {{activeTab === 'character' ? 'tab-item--active' : ''}}"
      data-tab="character"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >è§’è‰²</view>
    <view
      class="tab-item {{activeTab === 'equipment' ? 'tab-item--active' : ''}}"
      data-tab="equipment"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >è£…å¤‡</view>
    <view
      class="tab-item {{activeTab === 'dungeon' ? 'tab-item--active' : ''}}"
      data-tab="dungeon"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >ç§˜å¢ƒ</view>
  </view>
  <view wx:if="{{loading}}" class="loading">çµæ°”æ±‡èšä¸­...</view>
  <scroll-view wx:elif="{{profile}}" scroll-y="true" class="scroll-container">
    <block wx:if="{{activeTab === 'character'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">è§’è‰²å±æ€§</view>
          <view class="section-actions" wx:if="{{profile.attributes.attributePoints > 0}}">
            <button class="action-btn" size="mini" data-mode="single" bindtap="handleAllocate">åˆ†é…å±æ€§ç‚¹</button>
            <button class="action-btn" size="mini" type="primary" data-mode="auto" bindtap="handleAllocate">å‡è¡¡åˆ†é…</button>
          </view>
        </view>
        <view class="level-line">
          <view>ç­‰çº§ {{profile.attributes.level}} / {{profile.metadata.maxLevel}}</view>
          <view class="progress-text">{{profile.attributes.experience}} / {{profile.attributes.nextLevelExp}}</view>
        </view>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{profile.attributes.experienceProgress}}%;"></view>
        </view>
        <view class="attr-grid">
          <view class="attr-item" wx:for="{{profile.attributes.attributeList}}" wx:key="key">
            <view class="attr-label">{{item.label}}</view>
            <view class="attr-value">{{item.formattedValue}}</view>
            <view class="attr-detail">
              åŸºç¡€ {{item.formattedBase}} Â· è£…å¤‡ {{item.formattedEquipment}}
              <text wx:if="{{item.formattedSkill}}"> Â· æŠ€èƒ½ {{item.formattedSkill}}</text>
            </view>
          </view>
        </view>
        <view class="attr-extra">
          <text>æˆ˜åŠ› {{profile.attributes.combatPower}}</text>
          <text>å‰©ä½™å±æ€§ç‚¹ {{profile.attributes.attributePoints}}</text>
        </view>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'equipment'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">è£…å¤‡æ€»è§ˆ</view>
        </view>
        <view class="slot-list">
          <view class="slot" wx:for="{{profile.equipment.slots}}" wx:key="slot">
            <view class="slot-label">{{item.slotLabel}}</view>
            <view wx:if="{{item.item}}" class="slot-content">
              <view class="slot-name" style="border-color: {{item.item.rarityColor}};">{{item.item.name}}</view>
              <view class="slot-meta">{{item.item.rarityLabel}} Â· ç²¾ç‚¼ {{item.item.refine}}</view>
              <view class="slot-stats">
                <text wx:for="{{item.item.statsText}}" wx:key="index">{{stat}}</text>
              </view>
            </view>
            <view wx:else class="slot-empty">æœªè£…å¤‡</view>
          </view>
        </view>
        <view class="inventory-title">èƒŒåŒ…è£…å¤‡</view>
        <view
          wx:if="{{!profile.equipment.inventory.length}}"
          class="empty-tip inventory-empty"
        >æš‚æœªè·å¾—é¢å¤–è£…å¤‡</view>
        <view class="equipment-item" wx:for="{{profile.equipment.inventory}}" wx:key="itemId">
          <view class="equipment-head">
            <view class="equipment-name" style="color: {{item.rarityColor}};">{{item.name}}</view>
            <view class="equipment-meta">{{item.slotLabel}} Â· {{item.rarityLabel}}</view>
          </view>
          <view class="equipment-desc">{{item.description}}</view>
          <view class="equipment-stats">
            <text wx:for="{{item.statsText}}" wx:key="index">{{stat}}</text>
          </view>
          <view class="equipment-actions">
            <button size="mini" data-item-id="{{item.itemId}}" bindtap="handleEquipItem" disabled="{{item.equipped}}">
              {{item.equipped ? 'ä½¿ç”¨ä¸­' : 'è£…å¤‡'}}
            </button>
            <view class="equipment-refine">{{item.refineLabel}}</view>
          </view>
        </view>
        <view class="inventory-footer" bindtap="handleOpenStones" hover-class="inventory-footer--hover">
          <view class="inventory-footer__info">
            <text class="inventory-footer__icon">ğŸª™</text>
            <text class="inventory-footer__amount">{{formattedStoneBalance}}</text>
          </view>
          <view class="inventory-footer__label">çµçŸ³ä»“åº“</view>
        </view>
      </view>

      <view class="section-card">
        <view class="section-header">
          <view class="section-title">æŠ€èƒ½ä¸æŠ½å¡</view>
          <view class="section-actions">
            <button class="action-btn" type="primary" size="mini" loading="{{drawing}}" bindtap="handleDrawSkill">æŠ½å–çµæŠ€</button>
          </view>
        </view>
        <view class="skill-slots">
          <view class="skill-slot" wx:for="{{profile.skills.equipped}}" wx:key="slot">
            <view class="slot-index">æ§½ä½ {{item.slot + 1}}</view>
            <view wx:if="{{item.detail}}" class="skill-detail">
              <view class="skill-name" style="color: {{item.detail.rarityColor}};">{{item.detail.name}} Lv.{{item.detail.level}}</view>
              <view class="skill-effects">
                <text wx:for="{{item.detail.effectsSummary}}" wx:key="index">{{effect}}</text>
              </view>
              <button size="mini" data-slot="{{item.slot}}" bindtap="handleUnequipSkill">å¸ä¸‹</button>
            </view>
            <view wx:else class="slot-empty">æœªè£…å¤‡æŠ€èƒ½</view>
          </view>
        </view>
        <view class="inventory-title">æŠ€èƒ½èƒŒåŒ…</view>
        <view
          wx:if="{{!profile.skills.inventory.length}}"
          class="empty-tip inventory-empty"
        >æš‚æ— æŠ€èƒ½</view>
        <view class="skill-item" wx:for="{{profile.skills.inventory}}" wx:key="skillId">
          <view class="skill-header">
            <view class="skill-name" style="color: {{item.rarityColor}};">{{item.name}} Lv.{{item.level}}</view>
            <view class="skill-meta">{{item.rarityLabel}}</view>
          </view>
          <view class="skill-desc">{{item.description}}</view>
          <view class="skill-effects">
            <text wx:for="{{item.effectsSummary}}" wx:key="index">{{effect}}</text>
          </view>
          <view class="skill-actions">
            <button size="mini" data-skill-id="{{item.skillId}}" bindtap="handleEquipSkill" disabled="{{item.equipped}}">
              {{item.equipped ? 'ä½¿ç”¨ä¸­' : 'è£…å¤‡'}}
            </button>
            <view class="skill-time">è·å¾—äº {{item.obtainedAtText}}</view>
          </view>
        </view>
      </view>

      <view class="section-card" wx:if="{{profile.skillHistory.length}}">
        <view class="section-header">
          <view class="section-title">æŠ€èƒ½åŠ¨æ€</view>
        </view>
        <view class="history-item" wx:for="{{profile.skillHistory}}" wx:key="index">
          <view class="history-title">{{item.createdAtText}}</view>
          <view class="history-desc">{{item.summary}}</view>
        </view>
      </view>
      <view class="empty-card" wx:if="{{!profile.skillHistory.length}}">
        <text class="empty-tip">æš‚æ— æŠ€èƒ½åŠ¨æ€</text>
      </view>
    </block>

    <block wx:else>
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">ç§˜å¢ƒå¯¹æ‰‹</view>
        </view>
        <view class="enemy-card" wx:for="{{profile.enemies}}" wx:key="id">
          <view class="enemy-header">
            <view class="enemy-name">{{item.name}}</view>
            <view class="enemy-difficulty">{{item.difficulty}}</view>
          </view>
          <view class="enemy-desc">{{item.description}}</view>
          <view class="enemy-meta">ç­‰çº§ {{item.level}} Â· æ¨èæˆ˜åŠ› {{item.combatPower}}</view>
          <view class="enemy-reward">{{item.rewardsText}}</view>
          <button
            class="enemy-action"
            data-id="{{item.id}}"
            loading="{{battleLoading && selectedEnemyId === item.id}}"
            bindtap="handleBattle"
          >æŒ‘æˆ˜</button>
        </view>
      </view>

      <view class="section-card" wx:if="{{battleResult}}">
        <view class="section-header">
          <view class="section-title">æœ€æ–°æˆ˜æŠ¥</view>
        </view>
        <view class="battle-summary {{battleResult.victory ? 'battle-win' : battleResult.draw ? 'battle-draw' : 'battle-lose'}}">
          {{battleResult.victory ? 'èƒœåˆ©' : battleResult.draw ? 'åŠ¿å‡åŠ›æ•Œ' : 'æƒœè´¥'}} Â· å›åˆ {{battleResult.rounds || 0}}
        </view>
        <view class="battle-reward">{{battleResult.rewardsText}}</view>
        <view class="battle-log">
          <text wx:for="{{battleResult.log}}" wx:key="index">{{item}}</text>
        </view>
      </view>

      <view class="section-card">
        <view class="section-header">
          <view class="section-title">æˆ˜æ–—è®°å½•</view>
        </view>
        <view wx:if="{{!profile.battleHistory.length}}" class="empty-tip">æš‚æ— æˆ˜æ–—è®°å½•</view>
        <view class="history-item" wx:for="{{profile.battleHistory}}" wx:key="index">
          <view class="history-title">{{item.createdAtText}} Â· {{item.resultLabel}}</view>
          <view class="history-desc">{{item.enemyName}} Â· {{item.rewardsText}}</view>
        </view>
      </view>
    </block>
  </scroll-view>
</view>
