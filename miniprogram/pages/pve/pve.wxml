<custom-nav title="秘境试炼"></custom-nav>
<view class="page">
  <view wx:if="{{loading}}" class="loading">灵气汇聚中...</view>
  <scroll-view wx:elif="{{profile}}" scroll-y="true" class="scroll-container">
    <view class="section-card">
      <view class="section-header">
        <view class="section-title">角色属性</view>
        <view class="section-actions" wx:if="{{profile.attributes.attributePoints > 0}}">
          <button class="action-btn" size="mini" data-mode="single" bindtap="handleAllocate">分配属性点</button>
          <button class="action-btn" size="mini" type="primary" data-mode="auto" bindtap="handleAllocate">均衡分配</button>
        </view>
      </view>
      <view class="level-line">
        <view>等级 {{profile.attributes.level}} / {{profile.metadata.maxLevel}}</view>
        <view class="progress-text">{{profile.attributes.experience}} / {{profile.attributes.nextLevelExp}}</view>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{profile.attributes.experienceProgress}}%;"></view>
      </view>
      <view class="attr-grid">
        <view class="attr-item" wx:for="{{profile.attributes.attributeList}}" wx:key="key">
          <view class="attr-label">{{item.label}}</view>
          <view class="attr-value">{{item.formattedValue}}</view>
          <view class="attr-detail">基础 {{item.formattedBase}} · 装备 {{item.formattedEquipment}}<text wx:if="{{item.formattedSkill}}"> · 技能 {{item.formattedSkill}}</text></view>
        </view>
      </view>
      <view class="attr-extra">
        <text>战力 {{profile.attributes.combatPower}}</text>
        <text>剩余属性点 {{profile.attributes.attributePoints}}</text>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <view class="section-title">装备总览</view>
      </view>
      <view class="slot-list">
        <view class="slot" wx:for="{{profile.equipment.slots}}" wx:key="slot">
          <view class="slot-label">{{item.slotLabel}}</view>
          <view wx:if="{{item.item}}" class="slot-content">
            <view class="slot-name" style="border-color: {{item.item.rarityColor}};">{{item.item.name}}</view>
            <view class="slot-meta">{{item.item.rarityLabel}} · 精炼 {{item.item.refine}}</view>
            <view class="slot-stats">
              <text wx:for="{{item.item.statsText}}" wx:key="index">{{stat}}</text>
            </view>
          </view>
          <view wx:else class="slot-empty">未装备</view>
        </view>
      </view>
      <view class="inventory-title">背包装备</view>
      <view class="equipment-item" wx:for="{{profile.equipment.inventory}}" wx:key="itemId">
        <view class="equipment-head">
          <view class="equipment-name" style="color: {{item.rarityColor}};">{{item.name}}</view>
          <view class="equipment-meta">{{item.slotLabel}} · {{item.rarityLabel}}</view>
        </view>
        <view class="equipment-desc">{{item.description}}</view>
        <view class="equipment-stats">
          <text wx:for="{{item.statsText}}" wx:key="index">{{stat}}</text>
        </view>
        <view class="equipment-actions">
          <button size="mini" data-item-id="{{item.itemId}}" bindtap="handleEquipItem" disabled="{{item.equipped}}">{{item.equipped ? '使用中' : '装备'}}</button>
          <view class="equipment-refine">{{item.refineLabel}}</view>
        </view>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <view class="section-title">技能与抽卡</view>
        <view class="section-actions">
          <button class="action-btn" type="primary" size="mini" loading="{{drawing}}" bindtap="handleDrawSkill">抽取灵技</button>
        </view>
      </view>
      <view class="skill-slots">
        <view class="skill-slot" wx:for="{{profile.skills.equipped}}" wx:key="slot">
          <view class="slot-index">槽位 {{item.slot + 1}}</view>
          <view wx:if="{{item.detail}}" class="skill-detail">
            <view class="skill-name" style="color: {{item.detail.rarityColor}};">{{item.detail.name}} Lv.{{item.detail.level}}</view>
            <view class="skill-effects">
              <text wx:for="{{item.detail.effectsSummary}}" wx:key="index">{{effect}}</text>
            </view>
            <button size="mini" data-slot="{{item.slot}}" bindtap="handleUnequipSkill">卸下</button>
          </view>
          <view wx:else class="slot-empty">未装备技能</view>
        </view>
      </view>
      <view class="inventory-title">技能背包</view>
      <view class="skill-item" wx:for="{{profile.skills.inventory}}" wx:key="skillId">
        <view class="skill-header">
          <view class="skill-name" style="color: {{item.rarityColor}};">{{item.name}} Lv.{{item.level}}</view>
          <view class="skill-meta">{{item.rarityLabel}}</view>
        </view>
        <view class="skill-desc">{{item.description}}</view>
        <view class="skill-effects">
          <text wx:for="{{item.effectsSummary}}" wx:key="index">{{effect}}</text>
        </view>
        <view class="skill-actions">
          <button size="mini" data-skill-id="{{item.skillId}}" bindtap="handleEquipSkill" disabled="{{item.equipped}}">{{item.equipped ? '使用中' : '装备'}}</button>
          <view class="skill-time">获得于 {{item.obtainedAtText}}</view>
        </view>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <view class="section-title">秘境对手</view>
      </view>
      <view class="enemy-card" wx:for="{{profile.enemies}}" wx:key="id">
        <view class="enemy-header">
          <view class="enemy-name">{{item.name}}</view>
          <view class="enemy-difficulty">{{item.difficulty}}</view>
        </view>
        <view class="enemy-desc">{{item.description}}</view>
        <view class="enemy-meta">等级 {{item.level}} · 推荐战力 {{item.combatPower}}</view>
        <view class="enemy-reward">修为 +{{item.rewards.exp}} · 灵石 +{{item.rewards.stones}}</view>
        <button class="enemy-action" data-id="{{item.id}}" loading="{{battleLoading && selectedEnemyId === item.id}}" bindtap="handleBattle">挑战</button>
      </view>
    </view>

    <view class="section-card" wx:if="{{battleResult}}">
      <view class="section-header">
        <view class="section-title">最新战报</view>
      </view>
      <view class="battle-summary {{battleResult.victory ? 'battle-win' : battleResult.draw ? 'battle-draw' : 'battle-lose'}}">
        {{battleResult.victory ? '胜利' : battleResult.draw ? '势均力敌' : '惜败'}} · 回合 {{battleResult.rounds || 0}}
      </view>
      <view class="battle-reward">修为 +{{battleResult.rewards.exp || 0}} · 灵石 +{{battleResult.rewards.stones || 0}} · 属性点 +{{battleResult.rewards.attributePoints || 0}}</view>
      <view class="battle-log">
        <text wx:for="{{battleResult.log}}" wx:key="index">{{item}}</text>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <view class="section-title">战斗记录</view>
      </view>
      <view class="history-item" wx:for="{{profile.battleHistory}}" wx:key="index">
        <view class="history-title">{{item.createdAtText}} · {{item.resultLabel}}</view>
        <view class="history-desc">{{item.enemyName}} · {{item.rewardsText}}</view>
      </view>
      <view class="section-header history-header">
        <view class="section-title">技能动态</view>
      </view>
      <view class="history-item" wx:for="{{profile.skillHistory}}" wx:key="index">
        <view class="history-title">{{item.createdAtText}}</view>
        <view class="history-desc">{{item.summary}}</view>
      </view>
    </view>
  </scroll-view>
</view>
