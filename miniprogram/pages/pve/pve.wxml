<custom-nav title="秘境挑战" theme="dark"></custom-nav>
<view class="page">
  <view wx:if="{{loading}}" class="loading">灵气汇聚中...</view>
  <scroll-view wx:elif="{{profile}}" scroll-y="true" class="scroll-container">
    <view class="section-card" wx:if="{{profile.secretRealm}}">
      <view class="section-header">
        <view class="section-title">秘境进度</view>
      </view>
      <view class="progress-summary">
        <view>最高解锁：第{{profile.secretRealm.highestUnlockedFloor}}层</view>
        <view>已通关：{{profile.secretRealm.clearedCount}} / {{profile.secretRealm.totalFloors}}</view>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <view class="section-title">秘境对手</view>
      </view>
      <view
        class="enemy-card {{item.type === 'boss' ? 'enemy-boss' : ''}} {{item.locked ? 'enemy-locked' : ''}}"
        wx:for="{{profile.enemies || []}}"
        wx:key="id"
      >
        <view class="enemy-header">
          <view class="enemy-name">{{item.name}}</view>
          <view class="enemy-difficulty">{{item.difficulty}}</view>
        </view>
        <view class="enemy-meta">{{item.floorLabel}} · {{item.stageName}}</view>
        <view class="enemy-desc">{{item.description}}</view>
        <view class="enemy-meta">等级 {{item.level}} · 推荐战力 {{item.combatPower}}</view>
        <view class="enemy-status">状态：{{item.statusLabel}}</view>
        <view class="enemy-reward">{{item.rewardsText}}</view>
        <view
          wx:if="{{profile.metadata.viewerIsAdmin && item.adminEnemyDetails}}"
          class="enemy-admin-section"
        >
          <view
            wx:if="{{item.adminEnemyDetails.meta && item.adminEnemyDetails.meta.length}}"
            class="enemy-admin-meta"
          >
            <text
              wx:for="{{item.adminEnemyDetails.meta}}"
              wx:key="label"
              class="enemy-admin-meta-item"
            >{{item.label}}：{{item.value}}</text>
          </view>
          <view
            wx:if="{{item.adminEnemyDetails.entries && item.adminEnemyDetails.entries.length}}"
            class="enemy-admin-grid"
          >
            <view
              wx:for="{{item.adminEnemyDetails.entries}}"
              wx:key="key"
              class="enemy-admin-stat {{item.type === 'special' ? 'enemy-admin-stat-special' : ''}}"
            >
              <text class="enemy-admin-stat-label">{{item.label}}</text>
              <text class="enemy-admin-stat-value">{{item.value}}</text>
            </view>
          </view>
          <view
            wx:if="{{item.adminEnemyDetails.skills && item.adminEnemyDetails.skills.length}}"
            class="enemy-admin-skill-list"
          >
            <view
              wx:for="{{item.adminEnemyDetails.skills}}"
              wx:key="id"
              class="enemy-admin-skill-item"
            >
              <view class="enemy-admin-skill-name">{{item.name}}</view>
              <view wx:if="{{item.meta}}" class="enemy-admin-skill-meta">{{item.meta}}</view>
              <view wx:if="{{item.description}}" class="enemy-admin-skill-desc">{{item.description}}</view>
              <view
                wx:if="{{item.highlights && item.highlights.length}}"
                class="enemy-admin-skill-highlights"
              >
                <view
                  wx:for="{{item.highlights}}"
                  wx:key="*this"
                  class="enemy-admin-skill-highlight"
                >{{item}}</view>
              </view>
            </view>
          </view>
        </view>
        <button
          class="enemy-action"
          data-id="{{item.id}}"
          data-locked="{{item.locked}}"
          data-index="{{index}}"
          loading="{{battleLoading && selectedEnemyId === item.id}}"
          bindtap="handleBattle"
          disabled="{{item.locked}}"
        >{{item.locked ? '未解锁' : '挑战'}}</button>
      </view>
      <view wx:if="{{!(profile.enemies && profile.enemies.length)}}" class="empty-tip">暂无可挑战的秘境</view>
    </view>

    <view class="section-card" wx:if="{{battleResult}}">
      <view class="section-header">
        <view class="section-title">最新战报</view>
      </view>
      <view class="battle-summary {{battleResult.victory ? 'battle-win' : battleResult.draw ? 'battle-draw' : 'battle-lose'}}">
        {{battleResult.victory ? '胜利' : battleResult.draw ? '势均力敌' : '惜败'}} · 回合 {{battleResult.rounds || 0}}
      </view>
      <view class="battle-reward">{{battleResult.rewardsText}}</view>
      <view class="battle-log">
        <text wx:for="{{battleResult.log || []}}" wx:key="index">{{item}}</text>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <view class="section-title">战斗记录</view>
      </view>
      <view
        class="history-item"
        wx:for="{{profile.battleHistory || []}}"
        wx:key="id"
        data-index="{{index}}"
        hover-class="none"
        bindtap="handleHistoryTap"
      >
        <view class="history-title">{{item.createdAtText}}</view>
        <view class="history-desc">{{item.summary || item.resultLabel}}</view>
      </view>
      <view wx:if="{{!(profile.battleHistory && profile.battleHistory.length)}}" class="empty-tip">暂无战斗记录</view>
    </view>
  </scroll-view>

  <view wx:else class="empty-card">
    <text class="empty-tip">暂无秘境数据</text>
  </view>
</view>
