<custom-nav title="预约包房" theme="dark"></custom-nav>
<view class="container">
  <view
    wx:if="{{notice && (!notice.closable || !noticeDismissed)}}"
    class="notice {{notice.type || 'info'}}"
  >
    <text class="notice-text">{{notice.message}}</text>
    <button
      wx:if="{{notice.closable}}"
      size="mini"
      class="notice-close"
      bindtap="dismissNotice"
    >知道了</button>
  </view>
  <view wx:if="{{memberReservations.length}}" class="card reservations-card">
    <view class="section-title">我的预约</view>
    <view class="reservation-item" wx:for="{{memberReservations}}" wx:key="_id">
      <view class="reservation-header">
        <view class="reservation-room">{{item.roomName || '包房'}}</view>
        <view class="reservation-status {{item.status}}">{{item.statusLabel}}</view>
      </view>
      <view class="reservation-time">{{item.date}} {{item.startTime}} - {{item.endTime}}</view>
      <view class="reservation-meta" wx:if="{{item.price}}">费用：{{formatCurrency(item.price)}}</view>
      <view class="reservation-meta" wx:if="{{item.status === 'pendingApproval'}}">等待管理员审核</view>
      <view class="reservation-meta" wx:if="{{item.status === 'approved'}}">请按预约时间到店使用</view>
      <button
        wx:if="{{item.canCancel}}"
        size="mini"
        type="warn"
        plain
        data-id="{{item._id}}"
        loading="{{cancellingId === item._id}}"
        disabled="{{!!cancellingId && cancellingId !== item._id}}"
        bindtap="handleCancelReservation"
      >取消预约</button>
    </view>
  </view>
  <view wx:elif="{{!loading}}" class="card reservations-card reservations-card--empty">当前暂无预约记录</view>
  <view class="card filter-card">
    <view class="section-title">选择日期与时间</view>
    <view class="usage">剩余包房使用次数：{{memberUsageCount}}</view>
    <picker mode="date" value="{{date}}" bindchange="handleDateChange">
      <view class="picker">预约日期：{{date}}</view>
    </picker>
    <picker mode="time" value="{{startTime}}" start="00:00" end="23:59" bindchange="handleStartTimeChange">
      <view class="picker">开始时间：{{startTime}}</view>
    </picker>
    <picker mode="time" value="{{endTime}}" start="00:00" end="23:59" bindchange="handleEndTimeChange">
      <view class="picker">结束时间：{{endTime}}</view>
    </picker>
    <view wx:if="{{timeError}}" class="time-error">{{timeError}}</view>
  </view>

  <view class="card">
    <view class="section-title">可预约包房</view>
    <view wx:if="{{loading}}">加载中...</view>
    <view wx:elif="{{!rooms.length}}" class="empty-state">所选时段暂无空闲包房</view>
    <view wx:else>
      <view class="room" wx:for="{{rooms}}" wx:key="_id">
        <view class="room-info">
          <view class="room-name">{{item.name}}</view>
          <view class="room-capacity">可容纳：{{item.capacity}} 人</view>
          <view class="room-facilities">设施：{{item.facilities}}</view>
          <view class="room-price">{{item.isFree ? '权益免费使用' : formatCurrency(item.price)}}</view>
        </view>
        <button size="mini" type="primary" loading="{{submitting}}" data-room="{{item}}" bindtap="handleReserve">预约</button>
      </view>
    </view>
  </view>
</view>
