<custom-nav title="çµçŸ³å•†åŸ" theme="dark"></custom-nav>
<view class="mall-page">
  <view class="section-card mall-balance-card">
    <view class="mall-balance-card__label">å½“å‰çµçŸ³</view>
    <view class="mall-balance-card__value">{{stoneBalanceText}} æš</view>
    <view class="mall-balance-card__hint">å¯ç”¨äºå…‘æ¢è™šæ‹Ÿé“å…·ï¼Œæ— æ³•æŠ˜ç°ã€‚</view>
  </view>

  <view wx:if="{{error}}" class="section-card mall-message mall-message--error">{{error}}</view>
  <view wx:elif="{{loading}}" class="section-card mall-message">çµçŸ³æ°”æ¯æ±‡èšä¸­...</view>
  <block wx:else>
    <view wx:if="{{categories.length}}" class="section-card mall-catalog">
      <view class="section-header">
        <view class="section-title">çµçŸ³å…‘æ¢</view>
        <view class="section-subtitle">æŒ‰ç±»å‹æŒ‘é€‰å¿ƒä»ªé“å…·</view>
      </view>
      <view wx:if="{{categories.length > 1}}" class="mall-tabs">
        <view
          wx:for="{{categories}}"
          wx:key="key"
          class="mall-tab {{activeCategoryKey === item.key ? 'mall-tab--active' : ''}}"
          data-key="{{item.key}}"
          bindtap="handleCategoryChange"
          hover-class="mall-tab--hover"
        >
          <text class="mall-tab__label">{{item.label}}</text>
        </view>
      </view>
      <view wx:if="{{activeCategory && activeCategory.items.length}}" class="mall-grid">
        <block wx:for="{{activeCategory.items}}" wx:key="id">
          <view
            class="mall-item {{item.iconUrl ? 'mall-item--has-icon' : ''}}"
            data-id="{{item.id}}"
            bindtap="handleItemTap"
            hover-class="mall-item--hover"
          >
            <view class="mall-slot {{item.iconUrl ? 'mall-slot--has-icon' : ''}}">
              <view class="mall-slot__frame {{item.iconUrl ? 'mall-slot__frame--image' : ''}}">
                <block wx:if="{{item.iconUrl}}">
                  <image class="mall-slot__image" src="{{item.iconUrl}}" mode="aspectFill" lazy-load="true" />
                </block>
                <view wx:elif="{{item.icon}}" class="mall-slot__emoji">{{item.icon}}</view>
                <view wx:else class="mall-slot__placeholder">{{item.iconText || item.name}}</view>
              </view>
            </view>
            <view class="mall-slot__meta">
              <text class="mall-slot__price-icon">ğŸª™</text>
              <text class="mall-slot__price-value">{{item.price}}</text>
            </view>
          </view>
        </block>
      </view>
      <view wx:elif="{{activeCategory}}" class="mall-empty">è¯¥ç±»åˆ«æš‚æœªä¸Šæ¶é“å…·</view>
    </view>
    <view wx:else class="section-card mall-empty-card">
      <view class="mall-empty">å•†åŸæš‚æœªä¸Šæ¶å¯å…‘æ¢çš„é“å…·ï¼Œæ•¬è¯·æœŸå¾…ã€‚</view>
    </view>
  </block>
</view>

<view wx:if="{{showDetail && detailItem}}" class="mall-modal" catchtouchmove="noop">
  <view class="mall-modal__mask" bindtap="handleModalClose"></view>
  <view class="mall-modal__panel">
    <view class="mall-modal__icon-wrapper">
      <view class="mall-modal__icon-frame {{detailItem.iconUrl ? 'mall-modal__icon-frame--image' : ''}}">
        <block wx:if="{{detailItem.iconUrl}}">
          <image class="mall-modal__icon-image" src="{{detailItem.iconUrl}}" mode="aspectFill" lazy-load="true" />
        </block>
        <view wx:elif="{{detailItem.icon}}" class="mall-modal__icon-emoji">{{detailItem.icon}}</view>
        <view wx:else class="mall-modal__icon-placeholder">{{detailItem.iconText || detailItem.name}}</view>
      </view>
    </view>
    <view class="mall-modal__header">
      <view class="mall-modal__title">{{detailItem.name}}</view>
      <view class="mall-modal__price">
        <text class="mall-modal__price-icon">ğŸª™</text>
        <text class="mall-modal__price-value">{{detailItem.price}}</text>
      </view>
    </view>
    <view class="mall-modal__body">
      <view wx:if="{{detailItem.categoryLabel}}" class="mall-modal__tag">{{detailItem.categoryLabel}}</view>
      <view wx:if="{{detailItem.effectLabel}}" class="mall-modal__highlight">{{detailItem.effectLabel}}</view>
      <view class="mall-modal__desc">{{detailItem.description || 'æš‚æ— é“å…·æè¿°'}}</view>
    </view>
    <view class="mall-modal__actions">
      <button
        class="mall-modal__button mall-modal__button--ghost"
        hover-class="mall-modal__button--ghost-hover"
        bindtap="handleModalClose"
      >ç¨åå†çœ‹</button>
      <button
        class="mall-modal__button mall-modal__button--primary"
        hover-class="mall-modal__button--primary-hover"
        data-id="{{detailItem.id}}"
        loading="{{submittingId === detailItem.id}}"
        disabled="{{submittingId === detailItem.id}}"
        bindtap="handleModalPurchase"
      >å…‘æ¢</button>
    </view>
  </view>
</view>
