<view class="home-page">
  <view class="background background--fallback">
    <image
      class="background-fallback__image"
      src="{{backgroundImage}}"
      mode="aspectFill"
    ></image>
  </view>
  <view
    wx:if="{{backgroundVideo}}"
    class="background background--video background-layer {{showBackgroundVideo ? 'background-layer--visible' : ''}}"
  >
    <video
      class="background-video background-layer {{showBackgroundVideo ? 'background-layer--visible' : ''}}"
      src="{{backgroundVideo}}"
      autoplay
      loop
      muted
      controls="{{false}}"
      show-center-play-btn="{{false}}"
      show-fullscreen-btn="{{false}}"
      show-play-btn="{{false}}"
      show-screen-lock-button="{{false}}"
      enable-progress-gesture="{{false}}"
      objectFit="cover"
      poster="{{backgroundImage}}"
      binderror="handleBackgroundVideoError"
    ></video>
  </view>
  <view class="background background--overlay background-layer {{showBackgroundOverlay ? 'background-layer--visible' : ''}}"></view>
  <view class="mist-layer mist-layer--one background-layer {{showBackgroundOverlay ? 'background-layer--visible' : ''}}"></view>
  <view class="mist-layer mist-layer--two background-layer {{showBackgroundOverlay ? 'background-layer--visible' : ''}}"></view>
  <custom-nav title="会员中心" enable-back="{{false}}" theme="transparent"></custom-nav>

  <view class="content" wx:if="{{!loading}}" style="min-height: calc(100vh - {{navHeight}}px);">
    <view class="top-bar">
      <view class="profile-card">
        <view class="profile-avatar-wrapper" bindtap="handleAvatarTap">
          <image
            class="profile-avatar"
            src="{{(member && member.avatarUrl) ? member.avatarUrl : defaultAvatar}}"
            mode="cover"
          ></image>
          <image
            wx:if="{{member && member.avatarFrame}}"
            class="profile-avatar-frame"
            src="{{member.avatarFrame}}"
            mode="scaleToFill"
          ></image>
          <view wx:if="{{showAvatarBadge}}" class="badge-dot profile-avatar__dot"></view>
        </view>
        <view class="profile-info">
          <view class="profile-name" bindtap="handleProfileTap">
            {{member ? (member.nickName || '无名仙友') : '无名仙友'}}
            <view wx:if="{{showNameBadge}}" class="badge-dot profile-name__dot"></view>
          </view>
          <view class="profile-meta">
            <view class="profile-meta__title" bindtap="handleTitleTap">
              <image
                wx:if="{{activeTitleImage}}"
                class="profile-meta__title-image"
                src="{{activeTitleImage}}"
                mode="heightFix"
              ></image>
              <view wx:else class="profile-meta__title-placeholder">无称号</view>
            </view>
          </view>
        </view>
        <view class="profile-other">
            <view class="profile-meta__item" bindtap="handleLevelTap">
              <text class="profile-meta__text">境界 {{member ? (member.level ? member.level.name : '练气初期') : '练气初期'}}</text>
              <view wx:if="{{realmHasPendingRewards}}" class="badge-dot profile-meta__dot"></view>
            </view>
            <text class="profile-meta__text" bindtap="handleCombatPowerTap">战力 {{memberStats.combatPower}}</text>
            <text class="profile-meta__text" bindtap="handleStoneTap">灵石 {{memberStats.stoneBalance}}</text>
        </view>
      </view>

      <view class="top-bar__actions">
        <view class="activity-panel">
          <view class="activity-item" wx:for="{{activityIcons}}" wx:key="label" data-url="{{item.url}}" data-label="{{item.label}}" bindtap="handleActivityTap">
            <view class="activity-icon">{{item.icon}}</view>
            <view class="activity-label">{{item.label}}</view>
          </view>
        </view>
      </view>
    </view>

    <view class="hero-section">
      <view class="hero-copy">
        <view class="today">{{today}}</view>
        <view class="hero-title">仙缘启程</view>
        <view class="hero-subtitle" style="white-space: pre-wrap">
尊贵的酒隐之茄会员：
现实中的休闲娱乐，能够积攒此位面的修为与灵石。</view>
        <view class="progress-info">
          <view class="progress-track">
            <view class="progress-inner" style="{{progressStyle}}"></view>
          </view>
          <view class="progress-text">修为{{memberStats.experience}}，距下级还需 {{progressRemainingExperience}} </view>
        </view>
      </view>

      <view class="hero-figure">
        <view class="hero-figure__image-wrapper figure-scale {{heroFigureScaleClass}}">
          <image class="hero-image" src="{{heroImage}}" mode="widthFix"></image>
        </view>
        <view class="aura aura-1"></view>
        <view class="aura aura-2"></view>
      </view>
    </view>

    <view class="bottom-nav {{navExpanded ? 'bottom-nav--expanded' : 'bottom-nav--collapsed'}}">
      <view class="bottom-nav__items">
        <view
          class="nav-item"
          wx:for="{{navExpanded ? navItems : collapsedNavItems}}"
          wx:key="label"
          data-url="{{item.url}}"
          data-action="{{item.action}}"
          bindtap="handleNavTap"
        >
          <view class="nav-icon-wrapper">
            <text class="nav-icon">{{item.icon}}</text>
            <view wx:if="{{item.showDot}}" class="badge-dot nav-item__dot"></view>
          </view>
          <view class="nav-label">{{item.label}}</view>
        </view>
      </view>
      <view wx:if="{{!navExpanded}}" class="bottom-nav__more" bindtap="handleExpandNav">
        <text class="bottom-nav__more-icon">⋯</text>
        <text class="bottom-nav__more-label">更多</text>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading-state">
    <text>灵力汇聚中...</text>
  </view>

  <view wx:if="{{showProfile}}" class="profile-modal">
    <view class="modal-mask" bindtap="handleCloseProfile"></view>
    <view class="modal-content modal-content--editor">
      <view class="modal-header">
        <view class="modal-title">仙缘档案</view>
        <view class="modal-close" bindtap="handleCloseProfile">×</view>
      </view>
      <scroll-view scroll-y="true" class="modal-body modal-body--scroll">
        <view class="archive-section">
          <view class="archive-section__header">
            <view class="archive-section__title">道号</view>
            <view class="archive-section__meta">剩余次数：{{profileEditor.renameCredits}}</view>
          </view>
          <view class="archive-field">
            <input
              class="archive-input"
              value="{{profileEditor.nickName}}"
              placeholder="请输入你的道号"
              maxlength="12"
              bindinput="handleArchiveNickname"
            />
          </view>
          <view class="archive-helper">首次改名免费，后续需消耗改名次数，可使用改名卡补充。</view>
          <button
            wx:if="{{profileEditor.renameCards > 0}}"
            class="archive-action"
            size="mini"
            loading="{{renameRedeeming}}"
            disabled="{{renameRedeeming}}"
            bindtap="handleUseRenameCard"
          >使用改名卡（+1 次）</button>
        </view>

        <view class="archive-section">
          <view class="archive-section__title">性别</view>
          <view class="gender-options">
            <view
              class="gender-option {{profileEditor.gender === 'unknown' ? 'gender-option--active' : ''}}"
              data-value="unknown"
              bindtap="handleGenderSelect"
            >保密</view>
            <view
              class="gender-option {{profileEditor.gender === 'male' ? 'gender-option--active' : ''}}"
              data-value="male"
              bindtap="handleGenderSelect"
            >
              <text class="gender-option__icon" aria-hidden="true">♂</text>
              <text class="gender-option__label">道友</text>
            </view>
            <view
              class="gender-option {{profileEditor.gender === 'female' ? 'gender-option--active' : ''}}"
              data-value="female"
              bindtap="handleGenderSelect"
            >
              <text class="gender-option__icon" aria-hidden="true">♀</text>
              <text class="gender-option__label">仙子</text>
            </view>
          </view>
        </view>

        <view class="archive-section archive-section--summary">
          <view class="archive-summary">
            <view class="archive-summary__item">
              <view class="archive-summary__label">当前境界</view>
              <view class="archive-summary__value">{{member ? (member.level ? member.level.name : '练气初期') : '练气初期'}}</view>
            </view>
            <view class="archive-summary__item">
              <view class="archive-summary__label">修为值</view>
              <view class="archive-summary__value">{{memberStats.experience}}</view>
            </view>
            <view class="archive-summary__item">
              <view class="archive-summary__label">灵石</view>
              <view class="archive-summary__value">{{memberStats.stoneBalance}}</view>
            </view>
          </view>
        </view>

        <view class="archive-section" wx:if="{{profileEditor.renameHistory.length}}">
          <view class="archive-section__title">改名记录</view>
          <view class="rename-history">
            <view class="rename-history__item" wx:for="{{profileEditor.renameHistory}}" wx:key="id">
              <view class="rename-history__names">{{item.previous || '—'}} → {{item.current || '—'}}</view>
              <view class="rename-history__time">{{item.displayTime}}</view>
            </view>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-footer__btn modal-footer__btn--ghost" bindtap="handleCloseProfile" disabled="{{profileSaving}}">取消</button>
        <button
          class="modal-footer__btn"
          type="primary"
          loading="{{profileSaving}}"
          disabled="{{profileSaving}}"
          bindtap="handleArchiveSubmit"
        >保存档案</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showAvatarPicker}}" class="profile-modal">
    <view class="modal-mask" bindtap="handleCloseAvatarPicker"></view>
    <view class="modal-content modal-content--avatar">
      <view class="modal-header modal-header--appearance">
        <view class="modal-title">外观设置</view>
        <view class="modal-close" bindtap="handleCloseAvatarPicker">×</view>
      </view>
        <view class="appearance-tabs">
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'avatar' ? 'appearance-tab--active' : ''}}"
            data-tab="avatar"
            bindtap="handleAppearanceTabChange"
          >
            头像
            <view wx:if="{{!appearanceBadgeState.avatar}}" class="badge-dot appearance-tab__dot"></view>
          </view>
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'frame' ? 'appearance-tab--active' : ''}}"
            data-tab="frame"
            bindtap="handleAppearanceTabChange"
          >
            相框
            <view wx:if="{{!appearanceBadgeState.frame}}" class="badge-dot appearance-tab__dot"></view>
          </view>
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'title' ? 'appearance-tab--active' : ''}}"
            data-tab="title"
            bindtap="handleAppearanceTabChange"
          >
            称号
            <view wx:if="{{!appearanceBadgeState.title}}" class="badge-dot appearance-tab__dot"></view>
          </view>
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'background' ? 'appearance-tab--active' : ''}}"
            data-tab="background"
            bindtap="handleAppearanceTabChange"
          >
            背景
            <view wx:if="{{!appearanceBadgeState.background}}" class="badge-dot appearance-tab__dot"></view>
          </view>
        </view>
      <view class="appearance-modal__body-wrapper">
        <scroll-view scroll-y="true" class="modal-body modal-body--scroll appearance-modal__body">
          <view wx:if="{{avatarPicker.activeTab === 'avatar'}}" class="archive-section appearance-section">
            <view class="avatar-grid">
              <view
                class="avatar-option {{avatarPicker.avatarUrl === item.url ? 'avatar-option--active' : ''}}"
                wx:for="{{avatarPicker.avatarOptions}}"
                wx:key="id"
                data-url="{{item.url}}"
                bindtap="handleAvatarPickerSelect"
              >
                <image class="avatar-option__image" src="{{item.url}}" mode="aspectFill"></image>
              </view>
            </view>
          </view>
          <view wx:elif="{{avatarPicker.activeTab === 'frame'}}" class="archive-section appearance-section">
            <view class="avatar-frame-grid">
              <view
                class="avatar-frame-option {{avatarPicker.avatarFrame === item.url ? 'avatar-frame-option--active' : ''}}"
                wx:for="{{avatarPicker.frameOptions}}"
                wx:key="id"
                data-url="{{item.url}}"
                bindtap="handleAvatarFrameSelect"
              >
                <view class="avatar-frame-option__preview">
                  <image
                    class="avatar-frame-option__avatar"
                    src="{{avatarPicker.avatarUrl || defaultAvatar}}"
                    mode="cover"
                  ></image>
                  <image
                    wx:if="{{item.url}}"
                    class="avatar-frame-option__frame"
                    src="{{item.url}}"
                    mode="scaleToFill"
                  ></image>
                </view>
                <view class="avatar-frame-option__label">{{item.name}}</view>
              </view>
            </view>
          </view>
          <view wx:elif="{{avatarPicker.activeTab === 'title'}}" class="archive-section appearance-section">
            <view class="appearance-title-grid">
              <view
                class="appearance-title-option {{avatarPicker.appearanceTitle === item.id ? 'appearance-title-option--active' : ''}}"
                wx:for="{{avatarPicker.titleOptions}}"
                wx:key="id"
                data-id="{{item.id}}"
                bindtap="handleTitleSelect"
              >
                <view class="appearance-title-option__preview">
                  <image
                    wx:if="{{item.image}}"
                    class="appearance-title-option__image"
                    src="{{item.image}}"
                    mode="widthFix"
                  ></image>
                  <view wx:else class="appearance-title-option__placeholder">无称号</view>
                </view>
                <view class="appearance-title-option__label">{{item.name}}</view>
              </view>
            </view>
          </view>
          <view wx:else class="archive-section appearance-section appearance-section--background">
            <view class="appearance-background-toggle">
              <view class="appearance-background-toggle__info">
                <view class="appearance-background-toggle__title">动态背景</view>
                <view class="appearance-background-toggle__desc">并非所有背景都支持动态背景。</view>
              </view>
              <switch
                class="appearance-background-toggle__switch"
                checked="{{avatarPicker.dynamicBackground}}"
                bindchange="handleDynamicBackgroundToggle"
              ></switch>
            </view>
            <view class="appearance-background-grid">
              <view
                class="appearance-background-option {{avatarPicker.backgroundId === item.id ? 'appearance-background-option--active' : ''}} {{!item.unlocked ? 'appearance-background-option--locked' : ''}}"
                wx:for="{{avatarPicker.backgroundOptions}}"
                wx:key="id"
                data-id="{{item.id}}"
                data-disabled="{{!item.unlocked}}"
                data-hint="{{item.description}}"
                bindtap="handleBackgroundSelect"
              >
                <image class="appearance-background-option__image" src="{{item.image}}" mode="aspectFill"></image>
                <view class="appearance-background-option__overlay">
                  <view class="appearance-background-option__name">{{item.name}}</view>
                  <view class="appearance-background-option__desc">{{item.description}}</view>
                </view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
      <view class="modal-footer">
        <button class="modal-footer__btn modal-footer__btn--ghost" bindtap="handleCloseAvatarPicker" disabled="{{avatarPickerSaving}}">取消</button>
        <button
          class="modal-footer__btn"
          type="primary"
          loading="{{avatarPickerSaving}}"
          disabled="{{avatarPickerSaving}}"
          bindtap="handleAvatarPickerConfirm"
        >保存外观</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showOnboarding}}" class="onboarding-modal">
    <view class="modal-mask"></view>
    <view class="onboarding-content">
      <view class="onboarding-header">
        <view class="onboarding-title">完善仙缘信息</view>
        <view class="onboarding-subtitle">首次入门请授权微信昵称与手机号</view>
      </view>
      <view class="authorization-steps">
        <view class="authorization-step {{authorizationStatus.profileAuthorized ? 'authorization-step--done' : ''}}">
          <view class="authorization-step__header">
            <view class="authorization-step__index">1</view>
            <view class="authorization-step__texts">
              <view class="authorization-step__title">授权昵称与头像</view>
              <view class="authorization-step__desc">用于生成会员档案，授权后可微调昵称</view>
            </view>
          </view>
          <view class="authorization-step__content">
            <view class="authorization-preview">
              <image class="authorization-avatar" src="{{onboarding.avatarUrl || defaultAvatar}}" mode="cover"></image>
              <input
                class="authorization-input"
                value="{{onboarding.nickName}}"
                placeholder="授权后可修改昵称"
                maxlength="20"
                bindinput="handleNicknameInput"
                disabled="{{!authorizationStatus.profileAuthorized}}"
              />
            </view>
            <button class="authorization-action" bindtap="handleRequestUserProfile">
              {{authorizationStatus.profileAuthorized ? '已授权微信昵称' : '授权获取微信昵称'}}
            </button>
          </view>
        </view>
        <view class="authorization-step {{authorizationStatus.phoneAuthorized ? 'authorization-step--done' : ''}}">
          <view class="authorization-step__header">
            <view class="authorization-step__index">2</view>
            <view class="authorization-step__texts">
              <view class="authorization-step__title">授权手机号</view>
              <view class="authorization-step__desc">用于验证会员身份与预约通知</view>
            </view>
          </view>
          <view class="authorization-step__content">
            <view class="authorization-phone">
              <text class="authorization-phone__value {{authorizationStatus.phoneAuthorized ? '' : 'authorization-phone__value--placeholder'}}">
                {{authorizationStatus.phoneAuthorized ? (onboarding.mobile || '已授权，后台将解密手机号') : '授权后展示手机号'}}
              </text>
            </view>
            <button
              class="authorization-action"
              open-type="getPhoneNumber"
              bindgetphonenumber="handleGetPhoneNumber"
            >
              {{authorizationStatus.phoneAuthorized ? '已获取手机号' : '授权获取手机号'}}
            </button>
          </view>
        </view>
      </view>
      <button
        class="onboarding-submit"
        loading="{{onboardingSubmitting}}"
        disabled="{{onboardingSubmitting}}"
        bindtap="handleOnboardingConfirm"
      >确认并开启旅程</button>
    </view>
  </view>
</view>
