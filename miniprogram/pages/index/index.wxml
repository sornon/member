<view class="home-page">
  <image class="background" src="{{backgroundImage}}" mode="aspectFill"></image>
  <view class="mist-layer mist-layer--one"></view>
  <view class="mist-layer mist-layer--two"></view>

  <custom-nav title="会员中心" enable-back="{{false}}" theme="dark"></custom-nav>

  <view class="content" wx:if="{{!loading}}">
    <view class="top-bar">
      <view class="profile-card" bindtap="handleProfileTap">
        <image class="profile-avatar" src="{{(member && member.avatarUrl) ? member.avatarUrl : defaultAvatar}}" mode="cover"></image>
        <view class="profile-info">
          <view class="profile-name">{{member ? (member.nickName || '无名仙友') : '无名仙友'}}</view>
          <view class="profile-level">境界：{{member ? (member.level ? member.level.name : '练气初期') : '练气初期'}}</view>
          <view class="profile-meta">
            <text>灵石 {{memberStats.stoneBalance}}</text>
            <text>修为 {{memberStats.experience}}</text>
          </view>
        </view>
      </view>

      <view class="activity-panel">
        <view class="activity-item" wx:for="{{activityIcons}}" wx:key="label" data-url="{{item.url}}" data-label="{{item.label}}" bindtap="handleActivityTap">
          <view class="activity-icon">{{item.icon}}</view>
          <view class="activity-label">{{item.label}}</view>
        </view>
      </view>
    </view>

    <view class="hero-section">
      <view class="hero-copy">
        <view class="today">{{today}}</view>
        <view class="hero-title">仙缘启程</view>
        <view class="hero-subtitle">灵气回荡的天穹下，万道齐鸣，等你归位。</view>
        <view class="progress-info">
          <view class="progress-track">
            <view class="progress-inner" style="{{progressStyle}}"></view>
          </view>
          <view class="progress-text">距下境界还需 {{progress ? progress.nextDiff : 0}} 修为</view>
        </view>
      </view>

      <view class="hero-figure">
        <image class="hero-image" src="{{heroImage}}" mode="widthFix"></image>
        <view class="aura aura-1"></view>
        <view class="aura aura-2"></view>
      </view>
    </view>

    <view class="bottom-nav">
      <view class="nav-item" wx:for="{{navItems}}" wx:key="label" data-url="{{item.url}}" bindtap="handleNavTap">
        <view class="nav-icon">{{item.icon}}</view>
        <view class="nav-label">{{item.label}}</view>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading-state">
    <text>灵力汇聚中...</text>
  </view>

  <view wx:if="{{showProfile}}" class="profile-modal">
    <view class="modal-mask" bindtap="handleCloseProfile"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">仙缘档案</view>
        <view class="modal-close" bindtap="handleCloseProfile">×</view>
      </view>
      <view class="modal-body">
        <view class="modal-row">
          <text class="modal-label">道号</text>
          <text class="modal-value">{{member ? (member.nickName || '神秘仙友') : '神秘仙友'}}</text>
        </view>
        <view class="modal-row">
          <text class="modal-label">当前境界</text>
          <text class="modal-value">{{member ? (member.level ? member.level.name : '练气初期') : '练气初期'}}</text>
        </view>
        <view class="modal-row">
          <text class="modal-label">修为值</text>
          <text class="modal-value">{{memberStats.experience}}</text>
        </view>
        <view class="modal-row">
          <text class="modal-label">灵石余额</text>
          <text class="modal-value">{{memberStats.stoneBalance}}</text>
        </view>
        <view class="modal-row">
          <text class="modal-label">现金余额</text>
          <text class="modal-value">{{memberStats.cashBalance}}</text>
        </view>
        <view class="modal-divider"></view>
        <view class="modal-section-title">今日任务</view>
        <view wx:if="{{tasks.length}}" class="modal-task-list">
          <view class="modal-task" wx:for="{{tasks}}" wx:key="_id">
            <view class="task-name">{{item.title}}</view>
            <view class="task-reward">{{item.rewardSummary}}</view>
          </view>
        </view>
        <view wx:else class="modal-empty">今日暂无任务，稍后再来查看~</view>
      </view>
    </view>
  </view>

  <view wx:if="{{showOnboarding}}" class="onboarding-modal">
    <view class="modal-mask"></view>
    <view class="onboarding-content">
      <view class="onboarding-header">
        <view class="onboarding-title">完善仙缘信息</view>
        <view class="onboarding-subtitle">首次入门请授权微信昵称与手机号</view>
      </view>
      <view class="authorization-steps">
        <view class="authorization-step {{authorizationStatus.profileAuthorized ? 'authorization-step--done' : ''}}">
          <view class="authorization-step__header">
            <view class="authorization-step__index">1</view>
            <view class="authorization-step__texts">
              <view class="authorization-step__title">授权昵称与头像</view>
              <view class="authorization-step__desc">用于生成会员档案，授权后可微调昵称</view>
            </view>
          </view>
          <view class="authorization-step__content">
            <view class="authorization-preview">
              <image class="authorization-avatar" src="{{onboarding.avatarUrl || defaultAvatar}}" mode="cover"></image>
              <input
                class="authorization-input"
                value="{{onboarding.nickName}}"
                placeholder="授权后可修改昵称"
                maxlength="20"
                bindinput="handleNicknameInput"
                disabled="{{!authorizationStatus.profileAuthorized}}"
              />
            </view>
            <button class="authorization-action" bindtap="handleRequestUserProfile">
              {{authorizationStatus.profileAuthorized ? '已授权微信昵称' : '授权获取微信昵称'}}
            </button>
          </view>
        </view>
        <view class="authorization-step {{authorizationStatus.phoneAuthorized ? 'authorization-step--done' : ''}}">
          <view class="authorization-step__header">
            <view class="authorization-step__index">2</view>
            <view class="authorization-step__texts">
              <view class="authorization-step__title">授权手机号</view>
              <view class="authorization-step__desc">用于验证会员身份与预约通知</view>
            </view>
          </view>
          <view class="authorization-step__content">
            <view class="authorization-phone">
              <text class="authorization-phone__value {{authorizationStatus.phoneAuthorized ? '' : 'authorization-phone__value--placeholder'}}">
                {{authorizationStatus.phoneAuthorized ? (onboarding.mobile || '已授权，后台将解密手机号') : '授权后展示手机号'}}
              </text>
            </view>
            <button
              class="authorization-action"
              open-type="getPhoneNumber"
              bindgetphonenumber="handleGetPhoneNumber"
            >
              {{authorizationStatus.phoneAuthorized ? '已获取手机号' : '授权获取手机号'}}
            </button>
          </view>
        </view>
      </view>
      <button
        class="onboarding-submit"
        loading="{{onboardingSubmitting}}"
        disabled="{{onboardingSubmitting}}"
        bindtap="handleOnboardingConfirm"
      >确认并开启旅程</button>
    </view>
  </view>
</view>
