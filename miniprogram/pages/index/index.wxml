<view class="home-page">
  <view class="background background--fallback">
    <image
      class="background-fallback__image"
      src="{{backgroundImage}}"
      mode="aspectFill"
    ></image>
  </view>
  <view
    wx:if="{{backgroundVideo}}"
    class="background background--video background-layer {{showBackgroundVideo ? 'background-layer--visible' : ''}}"
  >
    <video
      class="background-video background-layer {{showBackgroundVideo ? 'background-layer--visible' : ''}}"
      src="{{backgroundVideo}}"
      autoplay
      loop
      muted
      controls="{{false}}"
      show-center-play-btn="{{false}}"
      show-fullscreen-btn="{{false}}"
      show-play-btn="{{false}}"
      show-screen-lock-button="{{false}}"
      enable-progress-gesture="{{false}}"
      objectFit="cover"
      poster="{{backgroundImage}}"
      binderror="handleBackgroundVideoError"
    ></video>
  </view>
  <view class="background background--overlay background-layer {{showBackgroundOverlay ? 'background-layer--visible' : ''}}"></view>
  <view class="mist-layer mist-layer--one background-layer {{showBackgroundOverlay ? 'background-layer--visible' : ''}}"></view>
  <view class="mist-layer mist-layer--two background-layer {{showBackgroundOverlay ? 'background-layer--visible' : ''}}"></view>
  <custom-nav title="ä¼šå‘˜ä¸­å¿ƒ" enable-back="{{false}}" theme="transparent"></custom-nav>

  <view class="content" wx:if="{{!loading}}" style="min-height: calc(100vh - {{navHeight}}px);">
    <view class="top-bar">
      <view class="profile-card">
        <view class="profile-avatar-wrapper" bindtap="handleAvatarTap">
          <image
            class="profile-avatar"
            src="{{(member && member.avatarUrl) ? member.avatarUrl : defaultAvatar}}"
            mode="cover"
          ></image>
          <image
            wx:if="{{member && member.avatarFrame}}"
            class="profile-avatar-frame"
            src="{{member.avatarFrame}}"
            mode="scaleToFill"
          ></image>
          <view wx:if="{{showAvatarBadge}}" class="badge-dot profile-avatar__dot"></view>
        </view>
        <view class="profile-info">
          <view class="profile-identity">
            <view class="profile-name" bindtap="handleProfileTap">
              {{member ? (member.nickName || 'æ— åä»™å‹') : 'æ— åä»™å‹'}}
              <view wx:if="{{showNameBadge}}" class="badge-dot profile-name__dot"></view>
            </view>
            <view
              wx:if="{{activeTitleImage}}"
              class="profile-meta__title"
              bindtap="handleTitleTap"
            >
              <image
                class="profile-meta__title-image"
                src="{{activeTitleImage}}"
                mode="heightFix"
              ></image>
            </view>
          </view>
        </view>
        <view class="profile-other">
            <view class="profile-meta__item" bindtap="handleLevelTap">
              <text class="profile-meta__text">å¢ƒç•Œ {{member ? (member.level ? member.level.name : 'ç»ƒæ°”åˆæœŸ') : 'ç»ƒæ°”åˆæœŸ'}}</text>
              <view wx:if="{{realmHasPendingRewards}}" class="badge-dot profile-meta__dot"></view>
            </view>
            <text class="profile-meta__text" bindtap="handleCombatPowerTap">æˆ˜åŠ› {{memberStats.combatPower}}</text>
            <text class="profile-meta__text" bindtap="handleStoneTap">çµçŸ³ {{memberStats.stoneBalance}}</text>
        </view>
      </view>

      <view class="top-bar__actions">
        <view class="trade-entry" bindtap="handleTradeTap">
          <text class="trade-entry__icon">ğŸ’¹</text>
          <view class="trade-entry__label">äº¤æ˜“è¡Œ</view>
        </view>
        <view class="activity-panel">
          <view class="activity-item" wx:for="{{activityIcons}}" wx:key="label" data-url="{{item.url}}" data-label="{{item.label}}" bindtap="handleActivityTap">
            <view class="activity-icon">{{item.icon}}</view>
            <view class="activity-label">{{item.label}}</view>
          </view>
        </view>
      </view>
    </view>

    <view class="hero-section">
      <view class="hero-copy">
        <view class="today">{{today}}</view>
        <view class="hero-title">ä»™ç¼˜å¯ç¨‹</view>
        <view class="hero-subtitle" style="white-space: pre-wrap">
å°Šè´µçš„é…’éšä¹‹èŒ„ä¼šå‘˜ï¼š
ç°å®ä¸­çš„ä¼‘é—²å¨±ä¹ï¼Œèƒ½å¤Ÿç§¯æ”’æ­¤ä½é¢çš„ä¿®ä¸ºä¸çµçŸ³ã€‚</view>
        <view class="progress-info">
          <view class="progress-track">
            <view class="progress-inner" style="{{progressStyle}}"></view>
          </view>
          <view class="progress-text">ä¿®ä¸º{{memberStats.experience}}ï¼Œè·ä¸‹çº§è¿˜éœ€ {{progressRemainingExperience}} </view>
        </view>
      </view>

      <view class="hero-figure">
        <view class="hero-figure__image-wrapper figure-scale {{heroFigureScaleClass}}">
          <image class="hero-image" src="{{heroImage}}" mode="widthFix"></image>
        </view>
        <view class="aura aura-1"></view>
        <view class="aura aura-2"></view>
      </view>
    </view>

    <view class="bottom-nav {{navExpanded ? 'bottom-nav--expanded' : 'bottom-nav--collapsed'}}">
      <view class="bottom-nav__items">
        <view
          class="nav-item"
          wx:for="{{navExpanded ? navItems : collapsedNavItems}}"
          wx:key="label"
          data-url="{{item.url}}"
          data-action="{{item.action}}"
          bindtap="handleNavTap"
        >
          <view class="nav-icon-wrapper">
            <text class="nav-icon">{{item.icon}}</text>
            <view wx:if="{{item.showDot}}" class="badge-dot nav-item__dot"></view>
          </view>
          <view class="nav-label">{{item.label}}</view>
        </view>
      </view>
      <view wx:if="{{!navExpanded}}" class="bottom-nav__more" bindtap="handleExpandNav">
        <text class="bottom-nav__more-icon">â‹¯</text>
        <text class="bottom-nav__more-label">æ›´å¤š</text>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading-state">
    <text>çµåŠ›æ±‡èšä¸­...</text>
  </view>

  <view wx:if="{{showProfile}}" class="profile-modal">
    <view class="modal-mask" bindtap="handleCloseProfile"></view>
    <view class="modal-content modal-content--editor">
      <view class="modal-header">
        <view class="modal-title">ä»™ç¼˜æ¡£æ¡ˆ</view>
        <view class="modal-close" bindtap="handleCloseProfile">Ã—</view>
      </view>
      <scroll-view scroll-y="true" class="modal-body modal-body--scroll">
        <view class="archive-section">
          <view class="archive-section__header">
            <view class="archive-section__title">é“å·</view>
            <view class="archive-section__meta">å‰©ä½™æ¬¡æ•°ï¼š{{profileEditor.renameCredits}}</view>
          </view>
          <view class="archive-field">
            <input
              class="archive-input"
              value="{{profileEditor.nickName}}"
              placeholder="è¯·è¾“å…¥ä½ çš„é“å·"
              maxlength="12"
              bindinput="handleArchiveNickname"
            />
          </view>
          <view class="archive-helper">é¦–æ¬¡æ”¹åå…è´¹ï¼Œåç»­éœ€æ¶ˆè€—æ”¹åæ¬¡æ•°ï¼Œå¯ä½¿ç”¨æ”¹åå¡è¡¥å……ã€‚</view>
          <button
            wx:if="{{profileEditor.renameCards > 0}}"
            class="archive-action"
            size="mini"
            loading="{{renameRedeeming}}"
            disabled="{{renameRedeeming}}"
            bindtap="handleUseRenameCard"
          >ä½¿ç”¨æ”¹åå¡ï¼ˆ+1 æ¬¡ï¼‰</button>
        </view>

        <view class="archive-section">
          <view class="archive-section__title">æ€§åˆ«</view>
          <view class="gender-options">
            <view
              class="gender-option {{profileEditor.gender === 'unknown' ? 'gender-option--active' : ''}}"
              data-value="unknown"
              bindtap="handleGenderSelect"
            >ä¿å¯†</view>
            <view
              class="gender-option {{profileEditor.gender === 'male' ? 'gender-option--active' : ''}}"
              data-value="male"
              bindtap="handleGenderSelect"
            >
              <text class="gender-option__icon" aria-hidden="true">â™‚</text>
              <text class="gender-option__label">é“å‹</text>
            </view>
            <view
              class="gender-option {{profileEditor.gender === 'female' ? 'gender-option--active' : ''}}"
              data-value="female"
              bindtap="handleGenderSelect"
            >
              <text class="gender-option__icon" aria-hidden="true">â™€</text>
              <text class="gender-option__label">ä»™å­</text>
            </view>
          </view>
        </view>

        <view class="archive-section archive-section--summary">
          <view class="archive-summary">
            <view class="archive-summary__item">
              <view class="archive-summary__label">å½“å‰å¢ƒç•Œ</view>
              <view class="archive-summary__value">{{member ? (member.level ? member.level.name : 'ç»ƒæ°”åˆæœŸ') : 'ç»ƒæ°”åˆæœŸ'}}</view>
            </view>
            <view class="archive-summary__item">
              <view class="archive-summary__label">ä¿®ä¸ºå€¼</view>
              <view class="archive-summary__value">{{memberStats.experience}}</view>
            </view>
            <view class="archive-summary__item">
              <view class="archive-summary__label">çµçŸ³</view>
              <view class="archive-summary__value">{{memberStats.stoneBalance}}</view>
            </view>
          </view>
        </view>

        <view class="archive-section" wx:if="{{profileEditor.renameHistory.length}}">
          <view class="archive-section__title">æ”¹åè®°å½•</view>
          <view class="rename-history">
            <view class="rename-history__item" wx:for="{{profileEditor.renameHistory}}" wx:key="id">
              <view class="rename-history__names">{{item.previous || 'â€”'}} â†’ {{item.current || 'â€”'}}</view>
              <view class="rename-history__time">{{item.displayTime}}</view>
            </view>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-footer__btn modal-footer__btn--ghost" bindtap="handleCloseProfile" disabled="{{profileSaving}}">å–æ¶ˆ</button>
        <button
          class="modal-footer__btn"
          type="primary"
          loading="{{profileSaving}}"
          disabled="{{profileSaving}}"
          bindtap="handleArchiveSubmit"
        >ä¿å­˜æ¡£æ¡ˆ</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showAvatarPicker}}" class="profile-modal">
    <view class="modal-mask" bindtap="handleCloseAvatarPicker"></view>
    <view class="modal-content modal-content--avatar">
      <view class="modal-header modal-header--appearance">
        <view class="modal-title">å¤–è§‚è®¾ç½®</view>
        <view class="modal-close" bindtap="handleCloseAvatarPicker">Ã—</view>
      </view>
        <view class="appearance-tabs">
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'avatar' ? 'appearance-tab--active' : ''}}"
            data-tab="avatar"
            bindtap="handleAppearanceTabChange"
          >
            å¤´åƒ
            <view wx:if="{{!appearanceBadgeState.avatar}}" class="badge-dot appearance-tab__dot"></view>
          </view>
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'frame' ? 'appearance-tab--active' : ''}}"
            data-tab="frame"
            bindtap="handleAppearanceTabChange"
          >
            ç›¸æ¡†
            <view wx:if="{{!appearanceBadgeState.frame}}" class="badge-dot appearance-tab__dot"></view>
          </view>
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'title' ? 'appearance-tab--active' : ''}}"
            data-tab="title"
            bindtap="handleAppearanceTabChange"
          >
            ç§°å·
            <view wx:if="{{!appearanceBadgeState.title}}" class="badge-dot appearance-tab__dot"></view>
          </view>
          <view
            class="appearance-tab {{avatarPicker.activeTab === 'background' ? 'appearance-tab--active' : ''}}"
            data-tab="background"
            bindtap="handleAppearanceTabChange"
          >
            èƒŒæ™¯
            <view wx:if="{{!appearanceBadgeState.background}}" class="badge-dot appearance-tab__dot"></view>
          </view>
        </view>
      <view class="appearance-modal__body-wrapper">
        <scroll-view scroll-y="true" class="modal-body modal-body--scroll appearance-modal__body">
          <view wx:if="{{avatarPicker.activeTab === 'avatar'}}" class="archive-section appearance-section">
            <view class="avatar-grid">
              <view
                class="avatar-option {{avatarPicker.avatarUrl === item.url ? 'avatar-option--active' : ''}}"
                wx:for="{{avatarPicker.avatarOptions}}"
                wx:key="id"
                data-url="{{item.url}}"
                bindtap="handleAvatarPickerSelect"
              >
                <image class="avatar-option__image" src="{{item.url}}" mode="aspectFill"></image>
              </view>
            </view>
          </view>
          <view wx:elif="{{avatarPicker.activeTab === 'frame'}}" class="archive-section appearance-section">
            <view class="avatar-frame-grid">
              <view
                class="avatar-frame-option {{avatarPicker.avatarFrame === item.url ? 'avatar-frame-option--active' : ''}}"
                wx:for="{{avatarPicker.frameOptions}}"
                wx:key="id"
                data-url="{{item.url}}"
                bindtap="handleAvatarFrameSelect"
              >
                <view class="avatar-frame-option__preview">
                  <image
                    class="avatar-frame-option__avatar"
                    src="{{avatarPicker.avatarUrl || defaultAvatar}}"
                    mode="cover"
                  ></image>
                  <image
                    wx:if="{{item.url}}"
                    class="avatar-frame-option__frame"
                    src="{{item.url}}"
                    mode="scaleToFill"
                  ></image>
                </view>
                <view class="avatar-frame-option__label">{{item.name}}</view>
              </view>
            </view>
          </view>
          <view wx:elif="{{avatarPicker.activeTab === 'title'}}" class="archive-section appearance-section">
            <view class="appearance-title-grid">
              <view
                class="appearance-title-option {{avatarPicker.appearanceTitle === item.id ? 'appearance-title-option--active' : ''}}"
                wx:for="{{avatarPicker.titleOptions}}"
                wx:key="id"
                data-id="{{item.id}}"
                bindtap="handleTitleSelect"
              >
                <view class="appearance-title-option__preview">
                  <image
                    wx:if="{{item.image}}"
                    class="appearance-title-option__image"
                    src="{{item.image}}"
                    mode="widthFix"
                  ></image>
                  <view wx:else class="appearance-title-option__placeholder">æ— ç§°å·</view>
                </view>
                <view class="appearance-title-option__label">{{item.name}}</view>
              </view>
            </view>
          </view>
          <view wx:else class="archive-section appearance-section appearance-section--background">
            <view class="appearance-background-toggle">
              <view class="appearance-background-toggle__info">
                <view class="appearance-background-toggle__title">åŠ¨æ€èƒŒæ™¯</view>
                <view class="appearance-background-toggle__desc">å¹¶éæ‰€æœ‰èƒŒæ™¯éƒ½æ”¯æŒåŠ¨æ€èƒŒæ™¯ã€‚</view>
              </view>
              <switch
                class="appearance-background-toggle__switch"
                checked="{{avatarPicker.dynamicBackground}}"
                bindchange="handleDynamicBackgroundToggle"
              ></switch>
            </view>
            <view class="appearance-background-grid">
              <view
                class="appearance-background-option {{avatarPicker.backgroundId === item.id ? 'appearance-background-option--active' : ''}} {{!item.unlocked ? 'appearance-background-option--locked' : ''}}"
                wx:for="{{avatarPicker.backgroundOptions}}"
                wx:key="id"
                data-id="{{item.id}}"
                data-disabled="{{!item.unlocked}}"
                data-hint="{{item.description}}"
                bindtap="handleBackgroundSelect"
              >
                <image class="appearance-background-option__image" src="{{item.image}}" mode="aspectFill"></image>
                <view class="appearance-background-option__overlay">
                  <view class="appearance-background-option__name">{{item.name}}</view>
                  <view class="appearance-background-option__desc">{{item.description}}</view>
                </view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
      <view class="modal-footer">
        <button class="modal-footer__btn modal-footer__btn--ghost" bindtap="handleCloseAvatarPicker" disabled="{{avatarPickerSaving}}">å–æ¶ˆ</button>
        <button
          class="modal-footer__btn"
          type="primary"
          loading="{{avatarPickerSaving}}"
          disabled="{{avatarPickerSaving}}"
          bindtap="handleAvatarPickerConfirm"
        >ä¿å­˜å¤–è§‚</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showOnboarding}}" class="onboarding-modal">
    <view class="modal-mask"></view>
    <view class="onboarding-content">
      <view class="onboarding-header">
        <view class="onboarding-title">å®Œå–„ä»™ç¼˜ä¿¡æ¯</view>
        <view class="onboarding-subtitle">é¦–æ¬¡å…¥é—¨è¯·æˆæƒå¾®ä¿¡æ˜µç§°ä¸æ‰‹æœºå·</view>
      </view>
      <view class="authorization-steps">
        <view class="authorization-step {{authorizationStatus.profileAuthorized ? 'authorization-step--done' : ''}}">
          <view class="authorization-step__header">
            <view class="authorization-step__index">1</view>
            <view class="authorization-step__texts">
              <view class="authorization-step__title">æˆæƒæ˜µç§°ä¸å¤´åƒ</view>
              <view class="authorization-step__desc">ç”¨äºç”Ÿæˆä¼šå‘˜æ¡£æ¡ˆï¼Œæˆæƒåå¯å¾®è°ƒæ˜µç§°</view>
            </view>
          </view>
          <view class="authorization-step__content">
            <view class="authorization-preview">
              <image class="authorization-avatar" src="{{onboarding.avatarUrl || defaultAvatar}}" mode="cover"></image>
              <input
                class="authorization-input"
                value="{{onboarding.nickName}}"
                placeholder="æˆæƒåå¯ä¿®æ”¹æ˜µç§°"
                maxlength="20"
                bindinput="handleNicknameInput"
                disabled="{{!authorizationStatus.profileAuthorized}}"
              />
            </view>
            <button class="authorization-action" bindtap="handleRequestUserProfile">
              {{authorizationStatus.profileAuthorized ? 'å·²æˆæƒå¾®ä¿¡æ˜µç§°' : 'æˆæƒè·å–å¾®ä¿¡æ˜µç§°'}}
            </button>
          </view>
        </view>
        <view class="authorization-step {{authorizationStatus.phoneAuthorized ? 'authorization-step--done' : ''}}">
          <view class="authorization-step__header">
            <view class="authorization-step__index">2</view>
            <view class="authorization-step__texts">
              <view class="authorization-step__title">æˆæƒæ‰‹æœºå·</view>
              <view class="authorization-step__desc">ç”¨äºéªŒè¯ä¼šå‘˜èº«ä»½ä¸é¢„çº¦é€šçŸ¥</view>
            </view>
          </view>
          <view class="authorization-step__content">
            <view class="authorization-phone">
              <text class="authorization-phone__value {{authorizationStatus.phoneAuthorized ? '' : 'authorization-phone__value--placeholder'}}">
                {{authorizationStatus.phoneAuthorized ? (onboarding.mobile || 'å·²æˆæƒï¼Œåå°å°†è§£å¯†æ‰‹æœºå·') : 'æˆæƒåå±•ç¤ºæ‰‹æœºå·'}}
              </text>
            </view>
            <button
              class="authorization-action"
              open-type="getPhoneNumber"
              bindgetphonenumber="handleGetPhoneNumber"
            >
              {{authorizationStatus.phoneAuthorized ? 'å·²è·å–æ‰‹æœºå·' : 'æˆæƒè·å–æ‰‹æœºå·'}}
            </button>
          </view>
        </view>
      </view>
      <button
        class="onboarding-submit"
        loading="{{onboardingSubmitting}}"
        disabled="{{onboardingSubmitting}}"
        bindtap="handleOnboardingConfirm"
      >ç¡®è®¤å¹¶å¼€å¯æ—…ç¨‹</button>
    </view>
  </view>
</view>
