<custom-nav title="备餐列表" theme="dark"></custom-nav>
<view class="prep-page">
  <view class="status-tabs">
    <view
      class="status-tab {{activeStatus === tab.id ? 'status-tab--active' : ''}}"
      wx:for="{{statusTabs}}"
      wx:key="id"
      wx:for-item="tab"
      data-id="{{tab.id}}"
      bindtap="handleStatusChange"
    >
      {{tab.label}}
    </view>
  </view>

  <view class="placeholder" wx:if="{{loading}}">加载中...</view>
  <view class="placeholder" wx:elif="{{!orders.length}}">暂无订单</view>

  <view class="order-card" wx:for="{{orders}}" wx:key="_id" wx:for-item="order">
    <view class="order-header">
      <view class="order-id">#{{order.shortId}}</view>
      <view class="order-status">{{order.statusLabel}}</view>
    </view>
    <view class="order-meta">会员：{{order.memberSnapshot && order.memberSnapshot.nickName ? order.memberSnapshot.nickName : '未知'}}</view>
    <view class="order-meta">提交时间：{{order.createdAtLabel}}</view>
    <view class="order-meta" wx:if="{{order.remark}}">备注：{{order.remark}}</view>
    <view class="order-meta" wx:if="{{order.adminRemark}}">管理员备注：{{order.adminRemark}}</view>
    <view class="order-meta order-meta--adjust" wx:if="{{order.priceAdjustmentRemark}}">
      改价说明：{{order.priceAdjustmentRemark}}
      <text wx:if="{{order.priceAdjustmentUpdatedAtLabel}}">（{{order.priceAdjustmentUpdatedAtLabel}}）</text>
    </view>
    <view class="order-meta order-meta--cancel" wx:if="{{order.status === 'cancelled' && order.cancelRemark}}">取消说明：{{order.cancelRemark}}</view>
    <view class="order-meta order-meta--cancel" wx:if="{{order.status === 'cancelled' && order.cancelledAtLabel}}">取消时间：{{order.cancelledAtLabel}}</view>
    <view class="order-meta order-meta--cancel" wx:if="{{order.status === 'cancelled' && order.cancelledByLabel}}">取消方：{{order.cancelledByLabel}}</view>
    <view class="order-items">
      <view class="order-line" wx:for="{{order.items}}" wx:key="{{index}}" wx:for-item="orderItem">
        <view class="line-main">
          <text class="line-title">{{orderItem.title}}</text>
          <view class="line-meta">
            <text wx:if="{{orderItem.spec}}" class="line-spec-label">{{orderItem.spec}}</text>
            <text wx:if="{{orderItem.spec && orderItem.unit}}" class="line-spec-separator">·</text>
            <text class="line-spec-price">{{orderItem.priceLabel}}{{orderItem.unit}}</text>
            <text class="line-spec-quantity"> × {{orderItem.quantity}}</text>
          </view>
        </view>
        <text class="line-amount">{{orderItem.amountLabel}}</text>
      </view>
    </view>
    <view class="order-total">
      合计 {{order.totalAmountLabel}}
      <text class="order-total-original" wx:if="{{order.priceAdjusted && order.originalTotalAmountLabel}}">
        原价 {{order.originalTotalAmountLabel}}
      </text>
    </view>
    <view class="order-meta" wx:if="{{order.adminConfirmedAtLabel}}">管理员确认：{{order.adminConfirmedAtLabel}}</view>
    <view class="order-meta" wx:if="{{order.memberConfirmedAtLabel}}">会员确认：{{order.memberConfirmedAtLabel}}</view>
    <button
      wx:if="{{order.status === 'submitted'}}"
      class="action-btn"
      type="primary"
      loading="{{processingId === order._id && processingAction === 'ready'}}"
      disabled="{{!!processingId && processingId !== order._id}}"
      data-id="{{order._id}}"
      bindtap="handleMarkReady"
    >推送给会员</button>
    <button
      wx:if="{{order.canCancel}}"
      class="action-btn action-btn--cancel"
      type="default"
      loading="{{processingId === order._id && processingAction === 'cancel'}}"
      disabled="{{!!processingId && processingId !== order._id}}"
      data-id="{{order._id}}"
      bindtap="handleCancelOrder"
    >取消订单</button>
  </view>
</view>
