<custom-nav title="订单查询" theme="dark"></custom-nav>
<view class="page">
  <view class="filters">
    <view class="filter-input">
      <input
        class="input"
        placeholder="输入会员昵称 / 手机号 / 编号"
        value="{{keyword}}"
        confirm-type="search"
        bindinput="handleKeywordInput"
        bindconfirm="handleSearch"
      />
    </view>
    <view class="filter-actions">
      <button class="btn primary" type="primary" size="mini" loading="{{loading}}" bindtap="handleSearch">查询</button>
      <button class="btn" size="mini" bindtap="handleResetFilters">重置</button>
    </view>
  </view>

  <view class="summary">共 {{total}} 单</view>

  <view class="orders">
    <view class="empty" wx:if="{{!loading && !orders.length}}">
      暂无符合条件的订单
    </view>

    <block wx:for="{{orders}}" wx:key="_id">
      <view class="order-card">
        <view class="order-header">
          <text class="order-id">#{{item._id}}</text>
          <view class="status-wrap">
            <view
              wx:if="{{item.status === 'pending' || item.status === 'created'}}"
              class="status status-{{item.status}} status-clickable"
              data-id="{{item._id}}"
              data-status="{{item.status}}"
              bindtap="handleStatusTap"
            >{{item.statusLabel}}</view>
            <view wx:else class="status status-{{item.status}}">{{item.statusLabel}}</view>
          </view>
        </view>
        <view class="order-meta">
          <text class="meta-text">创建：{{item.createdAtLabel || '—'}}</text>
          <text class="meta-text" wx:if="{{item.confirmedAtLabel}}">完成：{{item.confirmedAtLabel}}</text>
        </view>
        <view class="order-member">
          <text class="meta-text">会员：{{item.memberName || '—'}}</text>
          <text class="meta-text" wx:if="{{item.memberId}}">编号：{{item.memberId}}</text>
          <text class="meta-text" wx:if="{{item.memberMobile}}">手机：{{item.memberMobile}}</text>
        </view>
        <view class="order-amount">
          <view class="amount-wrap">
            <text class="amount" wx:if="{{!item.priceAdjusted}}">{{item.totalAmountLabel}}</text>
            <view class="amount-adjusted" wx:else>
              <text class="amount amount-new">{{item.totalAmountLabel}}</text>
              <text class="amount-original">原价 {{item.originalTotalAmountLabel}}</text>
            </view>
          </view>
          <text class="reward">赠送 {{item.stoneRewardLabel}}</text>
        </view>
        <view class="order-adjust-remark" wx:if="{{item.priceAdjustmentRemark}}">
          改价说明：{{item.priceAdjustmentRemark}}
          <text wx:if="{{item.priceAdjustmentUpdatedAtLabel}}">（{{item.priceAdjustmentUpdatedAtLabel}}）</text>
        </view>
        <view
          class="order-actions"
          wx:if="{{item.status === 'pending' || item.status === 'created'}}"
        >
          <button
            class="adjust-btn"
            size="mini"
            data-id="{{item._id}}"
            loading="{{priceAdjustingId === item._id}}"
            disabled="{{priceAdjustingId === item._id || forceChargingId === item._id}}"
            bindtap="handleOpenPriceAdjustDialog"
          >改价</button>
          <button
            class="force-btn"
            size="mini"
            type="primary"
            loading="{{forceChargingId === item._id}}"
            data-id="{{item._id}}"
            bindtap="handleForceChargeTap"
          >强制扣款</button>
        </view>
        <view class="order-items" wx:if="{{item.items && item.items.length}}">
          <view
            class="order-item"
            wx:for="{{item.items}}"
            wx:key="goodsIndex"
            wx:for-item="goods"
            wx:for-index="goodsIndex"
          >
            <text class="name">{{goods.name || '未命名'}}</text>
            <text class="quantity">x{{goods.quantity}}</text>
            <text class="price">{{goods.priceLabel}}</text>
            <text class="item-amount">{{goods.amountLabel}}</text>
          </view>
        </view>
      </view>
    </block>

    <view class="loading" wx:if="{{loading && orders.length}}">加载中...</view>
    <view class="no-more" wx:elif="{{orders.length >= total && total > 0}}">没有更多订单</view>
  </view>

  <view class="force-dialog-mask" wx:if="{{forceChargeDialog.visible}}">
    <view class="force-dialog">
      <view class="force-dialog__title">关联会员</view>
      <view class="force-dialog__body">
        <block wx:if="{{!forceChargeDialog.memberLocked}}">
          <view class="force-dialog__search">
            <input
              class="force-dialog__input"
              placeholder="输入昵称 / 手机号 / 编号"
              value="{{forceChargeDialog.keyword}}"
              confirm-type="search"
              bindinput="handleForceChargeMemberInput"
              bindconfirm="handleForceChargeMemberSearch"
            />
            <button class="force-dialog__search-btn" size="mini" bindtap="handleForceChargeMemberSearch">
              搜索
            </button>
          </view>
          <view class="force-dialog__error" wx:if="{{forceChargeDialog.error}}">{{forceChargeDialog.error}}</view>
          <view class="force-dialog__results">
            <view class="force-dialog__loading" wx:if="{{forceChargeDialog.loading}}">搜索中...</view>
            <view
              class="force-dialog__empty"
              wx:elif="{{!forceChargeDialog.loading && (!forceChargeDialog.results.length)}}"
            >
              请输入关键词搜索会员
            </view>
            <block wx:else>
              <view
                class="force-dialog__member {{forceChargeDialog.selectedMemberId === member._id ? 'is-active' : ''}}"
                wx:for="{{forceChargeDialog.results}}"
                wx:for-item="member"
                wx:key="_id"
                data-id="{{member._id}}"
                bindtap="handleSelectForceChargeMember"
              >
                <view class="member-name">{{member.nickName || '未命名'}}</view>
                <view class="member-meta">
                  <text wx:if="{{member.mobile}}">{{member.mobile}}</text>
                  <text wx:if="{{member.levelName}}">{{member.levelName}}</text>
                  <text>余额：{{member.balanceLabel}}</text>
                </view>
              </view>
            </block>
          </view>
        </block>
        <block wx:else>
          <view class="force-dialog__locked">
            <view class="member-name">{{(forceChargeDialog.memberInfo && forceChargeDialog.memberInfo.nickName) || '未命名'}}</view>
            <view class="member-meta">
              <text wx:if="{{forceChargeDialog.memberInfo && forceChargeDialog.memberInfo.mobile}}">{{forceChargeDialog.memberInfo.mobile}}</text>
              <text wx:if="{{forceChargeDialog.memberInfo && forceChargeDialog.memberInfo.levelName}}">{{forceChargeDialog.memberInfo.levelName}}</text>
              <text wx:if="{{forceChargeDialog.memberInfo && forceChargeDialog.memberInfo.balanceLabel}}">
                余额：{{forceChargeDialog.memberInfo.balanceLabel}}
              </text>
            </view>
            <view class="force-dialog__hint">将对以上会员扣除订单金额</view>
          </view>
        </block>
        <view class="force-dialog__remark">
          <textarea
            class="force-dialog__remark-input"
            placeholder="扣款备注（可选，会员可见）"
            maxlength="140"
            value="{{forceChargeDialog.remark}}"
            bindinput="handleForceChargeRemarkInput"
          ></textarea>
          <view class="force-dialog__remark-hint">备注将展示在会员消费记录中，亦可说明改价原因</view>
        </view>
      </view>
      <view class="force-dialog__footer">
        <button class="force-dialog__btn" size="mini" bindtap="closeForceChargeDialog">取消</button>
        <button
          class="force-dialog__btn primary"
          size="mini"
          type="primary"
          loading="{{forceChargingId && forceChargeDialog.orderId === forceChargingId}}"
          disabled="{{( !forceChargeDialog.memberLocked && !forceChargeDialog.selectedMemberId) || forceChargingId}}"
          bindtap="handleConfirmForceChargeWithMember"
        >确认扣款</button>
      </view>
    </view>
  </view>

  <view class="price-dialog-mask" wx:if="{{priceAdjustDialog.visible}}">
    <view class="price-dialog">
      <view class="price-dialog__title">改价</view>
      <view class="price-dialog__body">
        <view class="price-dialog__summary">
          <text>当前金额：{{priceAdjustDialog.currentAmountLabel}}</text>
          <text wx:if="{{priceAdjustDialog.originalAmountLabel}}">原价：{{priceAdjustDialog.originalAmountLabel}}</text>
        </view>
        <view class="price-dialog__field">
          <text class="price-dialog__label">改后金额（元）</text>
          <input
            class="price-dialog__input"
            type="digit"
            placeholder="请输入改后金额"
            value="{{priceAdjustDialog.amountInput}}"
            bindinput="handlePriceAdjustAmountInput"
          />
        </view>
        <view class="price-dialog__field">
          <text class="price-dialog__label">备注（会员可见）</text>
          <textarea
            class="price-dialog__textarea"
            placeholder="填写改价原因，可选"
            maxlength="140"
            value="{{priceAdjustDialog.remark}}"
            bindinput="handlePriceAdjustRemarkInput"
          ></textarea>
        </view>
        <view class="price-dialog__error" wx:if="{{priceAdjustDialog.error}}">{{priceAdjustDialog.error}}</view>
      </view>
      <view class="price-dialog__footer">
        <button class="price-dialog__btn" size="mini" bindtap="closePriceAdjustDialog">取消</button>
        <button
          class="price-dialog__btn primary"
          size="mini"
          type="primary"
          loading="{{priceAdjustingId === priceAdjustDialog.orderId}}"
          disabled="{{priceAdjustingId === priceAdjustDialog.orderId}}"
          bindtap="handleConfirmPriceAdjust"
        >确认改价</button>
      </view>
    </view>
  </view>
</view>
