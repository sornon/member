<custom-nav title="数据清理" theme="dark"></custom-nav>
<view class="cleanup-page">
  <view class="intro-card">
    <view class="intro-title">清理删除会员遗留数据</view>
    <view class="intro-desc">该操作会扫描多项会员相关数据，移除已被删除会员遗留的记录，避免异常数据影响现有会员。</view>
    <view class="intro-note">操作仅针对无效成员记录，不会改动当前有效会员的数据。建议在非营业高峰时段执行。</view>
    <button
      class="cleanup-button primary"
      bindtap="handleScanTap"
      loading="{{loading && loadingAction === 'scan'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'scan' ? '扫描中…' : '扫描待清理数据'}}
    </button>
    <button
      wx:if="{{preview && preview.items.length}}"
      class="cleanup-button danger"
      bindtap="handleCleanupTap"
      loading="{{loading && loadingAction === 'cleanup'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'cleanup' ? '清理中…' : '确认清理'}}
    </button>
  </view>

  <view wx:if="{{preview}}" class="preview-card">
    <view class="preview-header">
      <view class="preview-title">扫描结果</view>
      <view wx:if="{{previewAt}}" class="preview-time">{{previewAt}}</view>
    </view>
    <view wx:if="{{preview.total > 0}}" class="preview-summary">发现 {{preview.total}} 条待清理记录</view>
    <view wx:else class="preview-summary muted">未发现待清理数据</view>
    <view wx:if="{{preview.items.length}}" class="preview-list">
      <view wx:for="{{preview.items}}" wx:key="key" class="preview-item">
        <view class="preview-name">
          <text class="preview-collection">{{item.collection}}</text>
          <text class="preview-label">{{item.label}}</text>
        </view>
        <view class="preview-field">索引字段：{{item.indexes}}</view>
        <view class="preview-desc">数据功能：{{item.description}}</view>
        <view class="preview-reason">清理原因：{{item.reason}}</view>
      </view>
    </view>
    <view wx:else class="preview-empty">未发现孤立数据，当前无需清理。</view>
  </view>

  <view wx:if="{{result}}" class="result-card">
    <view class="result-header">
      <view class="result-title">清理结果</view>
      <view wx:if="{{finishedAt}}" class="result-time">{{finishedAt}}</view>
    </view>
    <view class="result-summary">共清理 {{result.totalRemoved}} 条记录</view>
    <view class="result-members">当前有效会员：{{result.memberCount}} 人</view>
    <view wx:if="{{result.details.length}}" class="detail-list">
      <view wx:for="{{result.details}}" wx:key="key" class="detail-item">
        <view class="detail-name">{{item.label}}</view>
        <view class="detail-count">{{item.count}}</view>
      </view>
    </view>
    <view wx:else class="detail-empty">未发现需要清理的数据，系统状态良好。</view>
    <view wx:if="{{result.errors.length}}" class="error-block">
      <view class="error-title">部分数据未能成功清理：</view>
      <view wx:for="{{result.errors}}" wx:key="index" class="error-item">{{item}}</view>
    </view>
  </view>
</view>
