<custom-nav title="系统设置" theme="dark"></custom-nav>
<view class="system-switch-page container">
  <view wx:if="{{loading}}" class="card loading-card">加载中…</view>
  <block wx:else>
    <view class="card intro-card">
      <view class="intro-title">全局设置概览</view>
      <view class="intro-desc">系统全局配置功能，集中管理会员端的关键能力与活动信息。</view>
    </view>

    <view class="card switch-card">
      <view class="card-title">基础功能</view>
      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">收银台</view>
          <view class="switch-desc">控制会员钱包内的在线快捷充值入口。</view>
        </view>
        <switch
          checked="{{features.cashierEnabled}}"
          data-key="cashierEnabled"
          bindchange="handleFeatureToggle"
          disabled="{{updating.cashierEnabled}}"
          color="#566aff"
        ></switch>
      </view>
      <view wx:if="{{updating.cashierEnabled}}" class="switch-hint">保存中…</view>
      <view wx:elif="{{!features.cashierEnabled}}" class="switch-hint warning">关闭后，会员钱包将提示“目前只支持收款台线下充值”。</view>
      <view wx:else class="switch-hint">开启后，会员可直接在钱包中完成微信充值。</view>
    </view>

    <view class="card tournament-card">
      <view class="card-title">仙界比武大会</view>
      <view class="card-desc">为活动开放状态、报名窗口与对外说明提供统一配置。</view>
      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">大会入口</view>
          <view class="switch-desc">控制小程序内比武大会报名与战报的展示。</view>
        </view>
        <switch
          checked="{{tournamentDraft.enabled}}"
          data-field="enabled"
          bindchange="handleTournamentToggle"
          disabled="{{tournamentSavingFields.enabled}}"
          color="#566aff"
        ></switch>
      </view>
      <view wx:if="{{tournamentSavingFields.enabled}}" class="switch-hint">保存中…</view>
      <view wx:elif="{{!tournamentDraft.enabled}}" class="switch-hint warning">关闭后，入口会隐藏，会员无法报名参战。</view>
      <view wx:else class="switch-hint">开启后，会员可在比武入口报名参战。</view>

      <view class="form-grid">
        <view class="form-field">
          <view class="field-label">报名开启时间</view>
          <input
            class="field-input"
            placeholder="示例：2025-07-01 10:00"
            value="{{tournamentDraft.registrationStart}}"
            data-field="registrationStart"
            bindinput="handleTournamentFieldChange"
            bindblur="handleTournamentFieldBlur"
            disabled="{{tournamentSavingFields.registrationStart}}"
          />
          <view class="field-hint">用于在前台公告报名开始时间。</view>
        </view>
        <view class="form-field">
          <view class="field-label">报名截止时间</view>
          <input
            class="field-input"
            placeholder="留空表示随时可报名"
            value="{{tournamentDraft.registrationEnd}}"
            data-field="registrationEnd"
            bindinput="handleTournamentFieldChange"
            bindblur="handleTournamentFieldBlur"
            disabled="{{tournamentSavingFields.registrationEnd}}"
          />
          <view class="field-hint">会在会员端报名须知中同步展示。</view>
        </view>
        <view class="form-field">
          <view class="field-label">参赛人数上限</view>
          <input
            class="field-input"
            type="number"
            placeholder="默认 64 人"
            value="{{tournamentDraft.maxParticipants}}"
            data-field="maxParticipants"
            bindinput="handleTournamentFieldChange"
            bindblur="handleTournamentFieldBlur"
            disabled="{{tournamentSavingFields.maxParticipants}}"
          />
          <view class="field-hint">系统会按照先到先得自动截取报名名单。</view>
        </view>
        <view class="form-field">
          <view class="field-label">规则说明链接</view>
          <input
            class="field-input"
            placeholder="填写外部图文或活动详情地址"
            value="{{tournamentDraft.ruleLink}}"
            data-field="ruleLink"
            bindinput="handleTournamentFieldChange"
            bindblur="handleTournamentFieldBlur"
            disabled="{{tournamentSavingFields.ruleLink}}"
          />
          <view class="field-hint">会员端可跳转查看完整规则细节。</view>
        </view>
      </view>
      <view class="form-field full-width">
        <view class="field-label">活动公告文案</view>
        <textarea
          class="field-textarea"
          placeholder="填写将展示给会员的大会公告、奖励说明等内容"
          value="{{tournamentDraft.announcement}}"
          maxlength="500"
          show-confirm-bar="false"
          data-field="announcement"
          bindinput="handleTournamentFieldChange"
          bindblur="handleTournamentFieldBlur"
          disabled="{{tournamentSavingFields.announcement}}"
        ></textarea>
        <view class="field-hint">支持换行，将直接同步到会员端的说明区块。</view>
      </view>

      <view wx:if="{{tournamentError}}" class="error-banner">{{tournamentError}}</view>
    </view>

    <view wx:if="{{error}}" class="error-banner">{{error}}</view>
  </block>
</view>
