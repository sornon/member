<custom-nav title="系统设置" theme="dark"></custom-nav>
<view class="system-switch-page container">
  <view wx:if="{{loading}}" class="card loading-card">加载中…</view>
  <block wx:else>
    <view class="card intro-card">
      <view class="intro-title">全局设置概览</view>
      <view class="intro-desc">系统全局配置功能，集中管理会员端的关键能力与活动信息。</view>
    </view>

    <view class="card cache-card">
      <view class="card-title">小程序缓存管理</view>
      <view class="card-desc">在后台刷新缓存版本号后，会员端会自动清理对应缓存并重新同步数据。</view>
      <block wx:for="{{cacheScopes}}" wx:key="key">
        <view class="cache-row">
          <view class="cache-info">
            <view class="cache-name">{{item.title}}</view>
            <view class="cache-desc">{{item.description}}</view>
            <view class="cache-version">当前版本：{{features.cacheVersions[item.key] || 0}}</view>
          </view>
          <button
            class="ghost-button"
            bindtap="handleCacheRefresh"
            data-scope="{{item.key}}"
            loading="{{cacheRefreshing[item.key]}}"
            disabled="{{cacheRefreshing[item.key]}}"
          >{{item.actionLabel}}</button>
        </view>
      </block>
      <view wx:if="{{cacheError}}" class="error-banner">{{cacheError}}</view>
    </view>

    <view class="card global-background-card">
      <view class="card-title">全局背景</view>
      <view class="card-desc">统一管理会员首页背景，活动期间可快速切换主题。</view>

      <view class="global-background-summary">
        <view class="global-background-summary__text">
          <view class="global-background-summary__primary">{{globalBackgroundSummary}}</view>
          <view class="global-background-summary__note">图片位于 /assets/background/，文件名无需后缀</view>
        </view>
        <button
          class="global-background-manage-button"
          size="mini"
          bindtap="openGlobalBackgroundManager"
        >管理背景</button>
      </view>

      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">启用全局背景</view>
          <view class="switch-desc">开启后，所有会员背景将强制应用下方选中的样式。</view>
        </view>
        <switch
          checked="{{globalBackgroundDraft.enabled}}"
          bindchange="handleGlobalBackgroundToggle"
          disabled="{{globalBackgroundSaving}}"
          color="#566aff"
        ></switch>
      </view>
      <view class="switch-hint {{globalBackgroundDraft.enabled ? '' : 'warning'}}">
        {{globalBackgroundDraft.enabled ? '已启用全局背景，会员端将在刷新后同步。' : '关闭后，会员背景恢复为各自保存的个人设置。'}}
      </view>

      <view class="global-background-preview">
        <image class="global-background-preview__image" src="{{globalBackgroundPreview.image}}" mode="aspectFill"></image>
        <view class="global-background-preview__meta">
          <view class="global-background-preview__name">{{globalBackgroundPreview.name || '默认背景'}}</view>
          <view class="global-background-preview__desc">
            {{globalBackgroundDraft.enabled ? (globalBackgroundPreview.description || '当前背景将在会员端生效。') : '全局背景未启用，会员使用个人背景。'}}
          </view>
          <view wx:if="{{globalBackgroundPreview.video}}" class="global-background-preview__tag">
            {{globalBackgroundDraft.animated ? '动态背景已启用' : '支持动态视频，可根据需要开启'}}
          </view>
          <view wx:elif="{{globalBackgroundDraft.enabled}}" class="global-background-preview__tag global-background-preview__tag--muted">
            当前背景未配置动态视频，将展示静态效果
          </view>
        </view>
      </view>

      <view class="appearance-background-toggle appearance-background-toggle--admin">
        <view class="appearance-background-toggle__info">
          <view class="appearance-background-toggle__title">动态背景</view>
          <view class="appearance-background-toggle__desc">若素材含视频，可开启动态背景覆盖静态图。</view>
        </view>
        <switch
          class="appearance-background-toggle__switch"
          checked="{{globalBackgroundDraft.animated}}"
          disabled="{{globalBackgroundSaving || !globalBackgroundPreview.video}}"
          bindchange="handleGlobalBackgroundAnimatedToggle"
        ></switch>
      </view>
      <view wx:if="{{!globalBackgroundPreview.video}}" class="switch-hint warning">
        当前背景缺少视频资源，启用动态背景后仍会展示静态图。
      </view>

      <block wx:if="{{globalBackgroundOptions.length}}">
        <view class="appearance-background-grid">
          <view
            class="appearance-background-option {{globalBackgroundDraft.backgroundId === item.id ? 'appearance-background-option--active' : ''}}"
            wx:for="{{globalBackgroundOptions}}"
            wx:key="id"
            data-id="{{item.id}}"
            bindtap="handleGlobalBackgroundSelect"
          >
            <image class="appearance-background-option__image" src="{{item.image}}" mode="aspectFill"></image>
            <view class="appearance-background-option__overlay">
              <view class="appearance-background-option__name">{{item.name}}</view>
              <view class="appearance-background-option__desc">{{item.description}}</view>
            </view>
          </view>
        </view>
      </block>
      <view wx:else class="global-background-empty">暂无自定义背景，请点击“管理背景”添加。</view>

    <view wx:if="{{globalBackgroundError}}" class="error-banner">{{globalBackgroundError}}</view>
  </view>

  <view class="card enhancement-card">
    <view class="card-title">装备强化配置</view>
    <view class="card-desc">配置装备强化的成功率区间与上限，所有修改会立即应用至会员端。</view>

    <view class="form-grid">
      <view class="form-field">
        <view class="field-label">100% 成功等级上限</view>
        <input
          class="field-input"
          data-field="guaranteedLevel"
          value="{{enhancementDraft.guaranteedLevel}}"
          bindinput="handleEnhancementFieldChange"
          placeholder="例如：3"
          disabled="{{enhancementSaving}}"
        />
        <view class="field-hint">填写正整数，表示强化至该等级以内必定成功。</view>
      </view>
      <view class="form-field">
        <view class="field-label">每级成功率衰减（%）</view>
        <input
          class="field-input"
          data-field="decayPerLevel"
          value="{{enhancementDraft.decayPerLevel}}"
          bindinput="handleEnhancementFieldChange"
          placeholder="例如：10"
          disabled="{{enhancementSaving}}"
        />
        <view class="field-hint">超过保底等级后，每提升一级成功率下降的百分比。</view>
      </view>
      <view class="form-field">
        <view class="field-label">强化等级上限</view>
        <input
          class="field-input"
          data-field="maxLevel"
          value="{{enhancementDraft.maxLevel}}"
          bindinput="handleEnhancementFieldChange"
          placeholder="例如：10"
          disabled="{{enhancementSaving}}"
        />
        <view class="field-hint">最大可强化等级，当前建议保持在 10 以内。</view>
      </view>
    </view>

    <view class="action-row">
      <button
        class="primary-button"
        bindtap="handleEnhancementSubmit"
        loading="{{enhancementSaving}}"
        disabled="{{enhancementSaving}}"
      >保存配置</button>
      <button class="ghost-button" bindtap="handleEnhancementReset" disabled="{{enhancementSaving}}">恢复默认</button>
      <view class="action-hint">当前方案：+{{enhancementDraft.guaranteedLevel}} 内必定成功，之后每级减少 {{enhancementDraft.decayPerLevel}}%。</view>
    </view>

    <view wx:if="{{enhancementError}}" class="error-banner">{{enhancementError}}</view>
  </view>

  <view class="card switch-card">
    <view class="card-title">首页入口</view>
      <view class="card-desc">控制会员端首页快捷入口的展示，调整后会实时生效。</view>
      <block wx:for="{{homeEntryList}}" wx:key="fullKey">
        <view class="switch-row">
          <view class="switch-info">
            <view class="switch-name">{{item.label}}</view>
            <view class="switch-desc">{{item.description}}</view>
          </view>
          <switch
            checked="{{features.homeEntries[item.key]}}"
            data-key="{{item.fullKey}}"
            bindchange="handleFeatureToggle"
            disabled="{{updating[item.fullKey]}}"
            color="#566aff"
          ></switch>
        </view>
        <view wx:if="{{updating[item.fullKey]}}" class="switch-hint">保存中…</view>
        <view wx:elif="{{!features.homeEntries[item.key]}}" class="switch-hint warning">{{item.hiddenHint}}</view>
        <view wx:else class="switch-hint">{{item.visibleHint}}</view>
      </block>
    </view>

    <view class="card switch-card">
      <view class="card-title">基础功能</view>
      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">收银台</view>
          <view class="switch-desc">控制会员钱包内的在线快捷充值入口。</view>
        </view>
        <switch
          checked="{{features.cashierEnabled}}"
          data-key="cashierEnabled"
          bindchange="handleFeatureToggle"
          disabled="{{updating.cashierEnabled}}"
          color="#566aff"
        ></switch>
      </view>
      <view wx:if="{{updating.cashierEnabled}}" class="switch-hint">保存中…</view>
      <view wx:elif="{{!features.cashierEnabled}}" class="switch-hint warning">关闭后，会员钱包将提示“目前只支持收款台线下充值”。</view>
      <view wx:else class="switch-hint">开启后，会员可直接在钱包中完成微信充值。</view>
    </view>

    <view class="card secret-realm-card">
      <view class="card-title">秘境挑战进度</view>
      <view class="card-desc">将所有会员的秘境通关记录恢复到默认状态，常用于测试或异常恢复。</view>
      <view class="secret-realm-reset">
        <button
          class="danger-button"
          bindtap="handleSecretRealmReset"
          loading="{{secretRealmResetting}}"
          disabled="{{secretRealmResetting}}"
        >全局重置</button>
        <view class="secret-realm-hint">操作会清空所有楼层的通关记录，执行前请务必确认。</view>
      </view>
      <view wx:if="{{secretRealmResetSummary}}" class="secret-realm-summary">{{secretRealmResetSummary}}</view>
      <view wx:if="{{secretRealmResetError}}" class="error-banner">{{secretRealmResetError}}</view>
    </view>

    <view class="card rage-card">
      <view class="card-title">真气增长参数</view>
      <view class="card-desc">配置 PVE / PVP 战斗通用的真气增长规则，若系统设置无法加载将自动回退到默认值。</view>

      <view class="form-grid rage-grid">
        <view class="form-field rage-field" wx:for="{{rageFieldList}}" wx:key="key">
          <view class="field-inline">
            <view class="field-label">{{item.label}}</view>
            <input
              class="field-input rage-input"
              data-field="{{item.key}}"
              value="{{rageDraft[item.key]}}"
              bindinput="handleRageFieldChange"
              placeholder="{{rageDefaults[item.key]}}"
              disabled="{{rageSaving}}"
            />
          </view>
          <view class="field-hint">{{item.hint}}</view>
        </view>
      </view>

      <view class="action-row rage-actions">
        <button class="primary-button" bindtap="handleRageSubmit" loading="{{rageSaving}}" disabled="{{rageSaving}}">
          保存真气参数
        </button>
        <button class="ghost-button" bindtap="handleRageReset" disabled="{{rageSaving}}">恢复默认</button>
        <view class="action-hint">默认：开局 0 · 回合 +20 · 普攻 +10 · 受击 ×1.5 · 暴击 +1 · 被暴击 +1</view>
      </view>

      <view wx:if="{{rageError}}" class="error-banner">{{rageError}}</view>
    </view>

    <view class="card tournament-card">
      <view class="card-title">仙界比武大会</view>
      <view class="card-desc">为活动开放状态、报名窗口与对外说明提供统一配置。</view>
      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">大会入口</view>
          <view class="switch-desc">控制小程序内比武大会报名与战报的展示。</view>
        </view>
        <switch
          checked="{{tournamentDraft.enabled}}"
          data-field="enabled"
          bindchange="handleTournamentToggle"
          disabled="{{tournamentSaving || tournamentResetting}}"
          color="#566aff"
        ></switch>
      </view>
      <view wx:if="{{tournamentSaving}}" class="switch-hint">保存中…</view>
      <view wx:elif="{{!tournamentDraft.enabled}}" class="switch-hint warning">关闭后，入口会隐藏，会员无法报名参战。</view>
      <view wx:else class="switch-hint">开启后，会员可在比武入口报名参战。</view>

      <view class="form-grid">
        <view class="form-field">
          <view class="field-label">报名开启时间</view>
          <input
            class="field-input"
            placeholder="示例：2025-07-01 10:00"
            value="{{tournamentDraft.registrationStart}}"
            data-field="registrationStart"
            bindinput="handleTournamentFieldChange"
            disabled="{{tournamentSaving || tournamentResetting}}"
          />
          <view class="field-hint">用于在前台公告报名开始时间。</view>
        </view>
        <view class="form-field">
          <view class="field-label">报名截止时间</view>
          <input
            class="field-input"
            placeholder="留空表示随时可报名"
            value="{{tournamentDraft.registrationEnd}}"
            data-field="registrationEnd"
            bindinput="handleTournamentFieldChange"
            disabled="{{tournamentSaving || tournamentResetting}}"
          />
          <view class="field-hint">会在会员端报名须知中同步展示。</view>
        </view>
      </view>

      <view class="action-row">
        <button
          class="primary-button"
          bindtap="handleTournamentSubmit"
          loading="{{tournamentSaving}}"
          disabled="{{tournamentSaving || tournamentResetting}}"
        >保存大会设置</button>
        <view class="action-hint">点击保存后会同步更新报名开放时间。</view>
      </view>

      <view wx:if="{{tournamentError}}" class="error-banner">{{tournamentError}}</view>

      <view class="reset-section">
        <view class="reset-title">比赛数据重置</view>
        <view class="reset-desc">清空战报与赛季档案，用于测试或异常恢复。</view>
        <view class="reset-actions">
          <button
            class="ghost-button"
            bindtap="handleTournamentReset"
            data-scope="season"
            loading="{{tournamentResetting && tournamentResetScope==='season'}}"
            disabled="{{tournamentResetting || tournamentSaving}}"
          >重置当前届</button>
          <button
            class="danger-button"
            bindtap="handleTournamentReset"
            data-scope="all"
            loading="{{tournamentResetting && tournamentResetScope==='all'}}"
            disabled="{{tournamentResetting || tournamentSaving}}"
          >重置所有届</button>
        </view>
        <view class="reset-hint">操作会永久清除对应届的比赛记录与榜单，请谨慎执行。</view>
      </view>

      <view wx:if="{{tournamentResetError}}" class="error-banner">{{tournamentResetError}}</view>

      <view class="refresh-section">
        <view class="refresh-title">刷新玩家数据</view>
        <view class="refresh-desc">强制同步所有参赛玩家的战斗属性快照，确保匹配使用的都是最新资料。</view>
        <view class="refresh-actions">
          <button
            class="ghost-button"
            bindtap="handleTournamentRefreshPlayers"
            loading="{{tournamentRefreshingPlayers}}"
            disabled="{{tournamentSaving || tournamentResetting || tournamentRefreshingPlayers}}"
          >刷新所有玩家</button>
          <view class="refresh-hint">执行时会逐个刷新玩家信息，耗时取决于成员数量，请耐心等待。</view>
        </view>
        <view wx:if="{{tournamentRefreshSummary}}" class="refresh-result">{{tournamentRefreshSummary}}</view>
        <view wx:if="{{tournamentRefreshError}}" class="error-banner">{{tournamentRefreshError}}</view>
      </view>
    </view>

    <view wx:if="{{error}}" class="error-banner">{{error}}</view>
  </block>
</view>

<view wx:if="{{globalBackgroundManagerVisible}}" class="dialog-mask" bindtap="handleGlobalBackgroundManagerClose">
  <view class="global-background-manager-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="global-background-manager-dialog__title">全局背景素材</view>
    <scroll-view scroll-y class="global-background-manager-dialog__content">
      <view wx:if="{{globalBackgroundManagerEntries.length}}" class="global-background-manager-list">
        <block wx:for="{{globalBackgroundManagerEntries}}" wx:key="id">
          <view class="global-background-manager-item">
            <image
              wx:if="{{item.preview}}"
              class="global-background-manager-item__image"
              src="{{item.preview}}"
              mode="aspectFill"
            />
            <view class="global-background-manager-item__details">
              <view class="global-background-manager-item__name">{{item.name}}</view>
              <view class="global-background-manager-item__meta">文件名：{{item.mediaKey}}</view>
            </view>
            <button
              class="global-background-manager-item__remove"
              size="mini"
              type="warn"
              data-id="{{item.id}}"
              bindtap="handleGlobalBackgroundManagerRemove"
            >删除</button>
          </view>
        </block>
      </view>
      <view wx:else class="global-background-manager-empty">尚未添加自定义背景</view>
    </scroll-view>
    <view class="global-background-manager-form">
      <input
        class="global-background-manager-form__input"
        placeholder="背景名称"
        value="{{globalBackgroundManagerForm.name}}"
        data-field="name"
        bindinput="handleGlobalBackgroundManagerInput"
      />
      <input
        class="global-background-manager-form__input"
        placeholder="文件名（不含后缀）"
        value="{{globalBackgroundManagerForm.file}}"
        data-field="file"
        bindinput="handleGlobalBackgroundManagerInput"
      />
      <button class="global-background-manager-form__add" size="mini" bindtap="handleGlobalBackgroundManagerAdd">添加</button>
    </view>
    <view wx:if="{{globalBackgroundManagerError}}" class="global-background-manager-error">{{globalBackgroundManagerError}}</view>
    <view class="global-background-manager-actions">
      <button
        class="global-background-manager-actions__button"
        size="mini"
        bindtap="handleGlobalBackgroundManagerClose"
        disabled="{{globalBackgroundManagerSaving}}"
      >取消</button>
      <button
        class="global-background-manager-actions__button global-background-manager-actions__button--primary"
        size="mini"
        type="primary"
        bindtap="handleGlobalBackgroundManagerSave"
        loading="{{globalBackgroundManagerSaving}}"
        disabled="{{globalBackgroundManagerSaving || !globalBackgroundManagerDirty}}"
      >保存</button>
    </view>
  </view>
</view>
