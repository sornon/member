<custom-nav title="系统设置" theme="dark"></custom-nav>
<view class="system-switch-page container">
  <view wx:if="{{loading}}" class="card loading-card">加载中…</view>
  <block wx:else>
    <view class="card intro-card">
      <view class="intro-title">全局设置概览</view>
      <view class="intro-desc">系统全局配置功能，集中管理会员端的关键能力与活动信息。</view>
    </view>

    <view class="card switch-card">
      <view class="card-title">基础功能</view>
      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">收银台</view>
          <view class="switch-desc">控制会员钱包内的在线快捷充值入口。</view>
        </view>
        <switch
          checked="{{features.cashierEnabled}}"
          data-key="cashierEnabled"
          bindchange="handleFeatureToggle"
          disabled="{{updating.cashierEnabled}}"
          color="#566aff"
        ></switch>
      </view>
      <view wx:if="{{updating.cashierEnabled}}" class="switch-hint">保存中…</view>
      <view wx:elif="{{!features.cashierEnabled}}" class="switch-hint warning">关闭后，会员钱包将提示“目前只支持收款台线下充值”。</view>
      <view wx:else class="switch-hint">开启后，会员可直接在钱包中完成微信充值。</view>
    </view>

    <view class="card rage-card">
      <view class="card-title">真气增长参数</view>
      <view class="card-desc">配置 PVE / PVP 战斗通用的真气增长规则，若系统设置无法加载将自动回退到默认值。</view>

      <view class="form-grid rage-grid">
        <view class="form-field rage-field" wx:for="{{rageFieldList}}" wx:key="key">
          <view class="field-inline">
            <view class="field-label">{{item.label}}</view>
            <input
              class="field-input rage-input"
              data-field="{{item.key}}"
              value="{{rageDraft[item.key]}}"
              bindinput="handleRageFieldChange"
              placeholder="{{rageDefaults[item.key]}}"
              disabled="{{rageSaving}}"
            />
          </view>
          <view class="field-hint">{{item.hint}}</view>
        </view>
      </view>

      <view class="action-row rage-actions">
        <button class="primary-button" bindtap="handleRageSubmit" loading="{{rageSaving}}" disabled="{{rageSaving}}">
          保存真气参数
        </button>
        <button class="ghost-button" bindtap="handleRageReset" disabled="{{rageSaving}}">恢复默认</button>
        <view class="action-hint">默认：开局 0 · 回合 +20 · 普攻 +10 · 受击 ×1.5 · 暴击 +1 · 被暴击 +1</view>
      </view>

      <view wx:if="{{rageError}}" class="error-banner">{{rageError}}</view>
    </view>

    <view class="card tournament-card">
      <view class="card-title">仙界比武大会</view>
      <view class="card-desc">为活动开放状态、报名窗口与对外说明提供统一配置。</view>
      <view class="switch-row">
        <view class="switch-info">
          <view class="switch-name">大会入口</view>
          <view class="switch-desc">控制小程序内比武大会报名与战报的展示。</view>
        </view>
        <switch
          checked="{{tournamentDraft.enabled}}"
          data-field="enabled"
          bindchange="handleTournamentToggle"
          disabled="{{tournamentSaving || tournamentResetting}}"
          color="#566aff"
        ></switch>
      </view>
      <view wx:if="{{tournamentSaving}}" class="switch-hint">保存中…</view>
      <view wx:elif="{{!tournamentDraft.enabled}}" class="switch-hint warning">关闭后，入口会隐藏，会员无法报名参战。</view>
      <view wx:else class="switch-hint">开启后，会员可在比武入口报名参战。</view>

      <view class="form-grid">
        <view class="form-field">
          <view class="field-label">报名开启时间</view>
          <input
            class="field-input"
            placeholder="示例：2025-07-01 10:00"
            value="{{tournamentDraft.registrationStart}}"
            data-field="registrationStart"
            bindinput="handleTournamentFieldChange"
            disabled="{{tournamentSaving || tournamentResetting}}"
          />
          <view class="field-hint">用于在前台公告报名开始时间。</view>
        </view>
        <view class="form-field">
          <view class="field-label">报名截止时间</view>
          <input
            class="field-input"
            placeholder="留空表示随时可报名"
            value="{{tournamentDraft.registrationEnd}}"
            data-field="registrationEnd"
            bindinput="handleTournamentFieldChange"
            disabled="{{tournamentSaving || tournamentResetting}}"
          />
          <view class="field-hint">会在会员端报名须知中同步展示。</view>
        </view>
      </view>

      <view class="action-row">
        <button
          class="primary-button"
          bindtap="handleTournamentSubmit"
          loading="{{tournamentSaving}}"
          disabled="{{tournamentSaving || tournamentResetting}}"
        >保存大会设置</button>
        <view class="action-hint">点击保存后会同步更新报名开放时间。</view>
      </view>

      <view wx:if="{{tournamentError}}" class="error-banner">{{tournamentError}}</view>

      <view class="reset-section">
        <view class="reset-title">比赛数据重置</view>
        <view class="reset-desc">清空战报与赛季档案，用于测试或异常恢复。</view>
        <view class="reset-actions">
          <button
            class="ghost-button"
            bindtap="handleTournamentReset"
            data-scope="season"
            loading="{{tournamentResetting && tournamentResetScope==='season'}}"
            disabled="{{tournamentResetting || tournamentSaving}}"
          >重置当前届</button>
          <button
            class="danger-button"
            bindtap="handleTournamentReset"
            data-scope="all"
            loading="{{tournamentResetting && tournamentResetScope==='all'}}"
            disabled="{{tournamentResetting || tournamentSaving}}"
          >重置所有届</button>
        </view>
        <view class="reset-hint">操作会永久清除对应届的比赛记录与榜单，请谨慎执行。</view>
      </view>

      <view wx:if="{{tournamentResetError}}" class="error-banner">{{tournamentResetError}}</view>

      <view class="refresh-section">
        <view class="refresh-title">刷新玩家数据</view>
        <view class="refresh-desc">强制同步所有参赛玩家的战斗属性快照，确保匹配使用的都是最新资料。</view>
        <view class="refresh-actions">
          <button
            class="ghost-button"
            bindtap="handleTournamentRefreshPlayers"
            loading="{{tournamentRefreshingPlayers}}"
            disabled="{{tournamentSaving || tournamentResetting || tournamentRefreshingPlayers}}"
          >刷新所有玩家</button>
          <view class="refresh-hint">执行时会逐个刷新玩家信息，耗时取决于成员数量，请耐心等待。</view>
        </view>
        <view wx:if="{{tournamentRefreshSummary}}" class="refresh-result">{{tournamentRefreshSummary}}</view>
        <view wx:if="{{tournamentRefreshError}}" class="error-banner">{{tournamentRefreshError}}</view>
      </view>
    </view>

    <view wx:if="{{error}}" class="error-banner">{{error}}</view>
  </block>
</view>
