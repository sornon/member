<custom-nav title="包房预约审核" theme="dark"></custom-nav>
<view class="container">
  <view class="card filter-card">
    <view class="filter-label">筛选状态</view>
    <picker
      mode="selector"
      range="{{statusOptions}}"
      range-key="label"
      value="{{statusIndex}}"
      bindchange="handleStatusChange"
    >
      <view class="picker">当前：{{currentStatusLabel}}</view>
    </picker>
  </view>

  <view class="card overview-card">
    <view class="overview-header">
      <view class="overview-title">近7天包房预定情况</view>
      <view class="overview-updated" wx:if="{{overviewGeneratedAt}}">更新于 {{overviewGeneratedAt}}</view>
    </view>
    <view wx:if="{{overviewLoading}}" class="overview-loading">正在加载包房概览...</view>
    <view wx:elif="{{overviewError}}" class="overview-error" bindtap="handleRetryOverview">
      {{overviewError}}，点击重试
    </view>
    <view wx:else class="overview-grid">
      <view
        class="overview-tile {{day.isToday ? 'overview-tile-today' : ''}}"
        wx:for="{{reservationOverview}}"
        wx:key="date"
        wx:for-item="day"
      >
        <view class="overview-tile-header">
          <text class="overview-tile-label">{{day.displayLabel}}</text>
          <text wx:if="{{day.shortDate}}" class="overview-tile-sub">{{day.shortDate}}</text>
        </view>
        <block wx:if="{{day.reservations && day.reservations.length}}">
          <view class="overview-tile-occupancy">
            <view
              class="overview-occupancy-item"
              wx:for="{{day.reservations}}"
              wx:key="_id"
              wx:for-item="entry"
            >
              <text class="overview-occupancy-slot">{{entry.startTime}}-{{entry.endTime}}</text>
              <text class="overview-occupancy-divider">·</text>
              <text class="overview-occupancy-room">{{entry.roomName || '包房'}}</text>
            </view>
          </view>
        </block>
        <view wx:else class="overview-empty">空闲</view>
      </view>
    </view>
  </view>

  <view wx:if="{{loading && !reservations.length}}" class="card">正在加载预约...</view>
  <view wx:if="{{!loading && !reservations.length}}" class="card empty">暂无预约申请</view>

  <view class="card" wx:for="{{reservations}}" wx:key="_id">
    <view class="item-header">
      <view class="room">{{item.roomName || '包房'}}</view>
      <view class="status {{item.status}}">{{item.statusLabel}}</view>
    </view>
    <view class="item-time">{{item.date}} {{item.startTime}} - {{item.endTime}}</view>
    <view class="item-member">
      申请人：{{item.memberDisplayName || item.memberId}}
      <text wx:if="{{item.memberMobile}}"> · {{item.memberMobile}}</text>
    </view>
    <view class="item-meta" wx:if="{{item.usageCredits}}">占用使用次数：{{item.usageCredits}}</view>
    <view class="item-meta" wx:if="{{item.approval && item.approval.reason}}">审核备注：{{item.approval.reason}}</view>
    <view class="item-actions" wx:if="{{item.status === 'pendingApproval'}}">
      <button
        size="mini"
        type="warn"
        loading="{{processingId === item._id && processingType === 'reject'}}"
        disabled="{{!!processingId && processingId !== item._id}}"
        data-id="{{item._id}}"
        bindtap="handleReject"
      >拒绝</button>
      <button
        size="mini"
        type="primary"
        loading="{{processingId === item._id && processingType === 'approve'}}"
        disabled="{{!!processingId && processingId !== item._id}}"
        data-id="{{item._id}}"
        bindtap="handleApprove"
      >通过</button>
    </view>
    <view class="item-actions" wx:elif="{{item.canCancel}}">
      <button
        size="mini"
        type="warn"
        plain
        loading="{{processingId === item._id && processingType === 'cancel'}}"
        disabled="{{!!processingId && processingId !== item._id}}"
        data-id="{{item._id}}"
        bindtap="handleCancel"
      >取消预约</button>
    </view>
  </view>

  <view wx:if="{{loading && reservations.length}}" class="loading">加载中...</view>
  <view wx:if="{{finished && reservations.length}}" class="finished">没有更多记录了</view>
</view>
