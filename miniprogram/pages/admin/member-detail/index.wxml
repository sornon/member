<custom-nav title="会员资料" theme="dark"></custom-nav>
<view class="member-detail" wx:if="{{!loading}}">
  <view class="section">
    <view class="section-title">账号信息</view>
    <view class="info-row">
      <view class="info-label">会员 ID</view>
      <view class="info-value">{{member._id}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">注册时间</view>
      <view class="info-value">{{member.createdAt || '—'}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">最近更新</view>
      <view class="info-value">{{member.updatedAt || '—'}}</view>
    </view>
  </view>

  <view class="section">
    <view class="section-title">基础资料</view>
    <view class="toolbar">
      <button class="recharge" size="mini" bindtap="showRechargeDialog">为该会员充值</button>
    </view>
    <view class="form-item">
      <view class="form-label">道号</view>
      <input
        class="form-input"
        value="{{form.nickName}}"
        placeholder="请输入昵称"
        data-field="nickName"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">剩余改名次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.renameCredits}}"
        placeholder="请输入剩余改名次数"
        data-field="renameCredits"
        bindinput="handleInputChange"
      />
    </view>
    <view class="rename-meta">
      <text>已使用改名次数：{{member.renameUsed || 0}}</text>
    </view>
    <view class="form-item">
      <view class="form-label">可洗点次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.respecAvailable}}"
        placeholder="请输入剩余洗点次数"
        data-field="respecAvailable"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">包房使用次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.roomUsageCount}}"
        placeholder="请输入剩余包房使用次数"
        data-field="roomUsageCount"
        bindinput="handleInputChange"
      />
    </view>
    <view wx:if="{{renameHistory.length}}" class="rename-history">
      <view class="rename-history__title">改名记录</view>
      <view class="rename-history__item" wx:for="{{renameHistory}}" wx:key="id">
        <view class="rename-history__names">{{item.previous}} → {{item.current}}</view>
        <view class="rename-history__meta">{{item.time}} · {{item.source}}</view>
      </view>
    </view>
    <view class="form-item">
      <view class="form-label">手机号</view>
      <input
        class="form-input"
        value="{{form.mobile}}"
        placeholder="请输入手机号"
        data-field="mobile"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">修为值</view>
      <input
        class="form-input"
        type="number"
        value="{{form.experience}}"
        placeholder="请输入修为值"
        data-field="experience"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">灵石余额（枚）</view>
      <input
        class="form-input"
        type="number"
        value="{{form.stoneBalance}}"
        placeholder="请输入灵石余额"
        data-field="stoneBalance"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">现金余额（元）</view>
      <input
        class="form-input"
        type="digit"
        value="{{form.cashBalance}}"
        placeholder="请输入现金余额"
        data-field="cashBalance"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">当前境界</view>
      <view class="readonly-value">{{currentLevelName || '—'}}</view>
    </view>
    <view class="form-item">
      <view class="form-label">角色权限</view>
      <checkbox-group class="role-group" bindchange="handleRolesChange">
        <label
          wx:for="{{roleOptions}}"
          wx:key="value"
          class="role-option {{item.checked ? 'checked' : ''}}"
        >
          <checkbox
            value="{{item.value}}"
            checked="{{item.checked}}"
            disabled="{{item.disabled}}"
          />
          <text class="role-label">{{item.label}}</text>
        </label>
      </checkbox-group>
    </view>
    <view class="form-item">
      <view class="form-label">头像权限</view>
      <view class="avatar-permission-note">C 级头像默认开放</view>
      <checkbox-group class="avatar-permission-grid" bindchange="handleAvatarUnlockChange">
        <block wx:for="{{avatarOptionGroups}}" wx:key="gender">
          <view class="avatar-permission-group">
            <view class="avatar-permission-group__title">{{item.label}}</view>
            <view class="avatar-permission-group__list">
              <label
                wx:for="{{item.options}}"
                wx:for-item="option"
                wx:key="id"
                class="avatar-permission-item {{option.disabled ? 'avatar-permission-item--disabled' : ''}}"
              >
                <checkbox
                  value="{{option.id}}"
                  checked="{{option.checked}}"
                  disabled="{{option.disabled}}"
                />
                <text class="avatar-permission-name {{option.disabled ? 'avatar-permission-name--disabled' : ''}}">{{option.label}}</text>
                <text wx:if="{{option.disabled}}" class="avatar-permission-tag">默认</text>
              </label>
            </view>
          </view>
        </block>
      </checkbox-group>
    </view>
  </view>

  <button class="submit" type="primary" loading="{{saving}}" bindtap="handleSubmit">保存修改</button>

  <view class="section">
    <view class="section-title">PVE 装备</view>
    <view class="equipment-admin__actions">
      <picker
        mode="selector"
        range="{{equipmentCatalog}}"
        range-key="label"
        value="{{equipmentPickerIndex}}"
        bindchange="handleEquipmentPickerChange"
        disabled="{{!(equipmentCatalog && equipmentCatalog.length)}}"
      >
        <button
          class="grant-equipment-btn"
          size="mini"
          type="primary"
          loading="{{grantingEquipment}}"
          disabled="{{!(equipmentCatalog && equipmentCatalog.length)}}"
        >
          发放装备
        </button>
      </picker>
      <text wx:if="{{!(equipmentCatalog && equipmentCatalog.length)}}" class="equipment-admin__hint">请稍候，正在加载装备目录</text>
    </view>
    <view class="equipment-admin__content">
      <view class="equipment-admin__block">
        <view class="equipment-admin__subtitle">已装备</view>
        <view wx:if="{{equipmentSlots.length}}" class="equipment-admin__slot-list">
          <view class="equipment-admin__slot" wx:for="{{equipmentSlots}}" wx:key="slot">
            <text class="equipment-admin__slot-label">{{item.slotLabel}}</text>
            <text class="equipment-admin__slot-value" style="color: {{item.qualityColor}};">{{item.name || '未装备'}}</text>
          </view>
        </view>
        <view wx:else class="equipment-admin__empty">暂无装备数据</view>
      </view>
      <view class="equipment-admin__block">
        <view class="equipment-admin__subtitle">背包装备</view>
        <view wx:if="{{equipmentInventory.length}}" class="equipment-admin__inventory">
          <view class="equipment-admin__inventory-item" wx:for="{{equipmentInventory}}" wx:key="itemId">
            <view class="equipment-admin__inventory-name" style="color: {{item.qualityColor}};">{{item.name}}</view>
            <view class="equipment-admin__inventory-meta">
              <text>{{item.qualityLabel}}</text>
              <text wx:if="{{item.slotLabel}}">{{item.slotLabel}}</text>
              <text wx:if="{{item.obtainedAtText}}">{{item.obtainedAtText}}</text>
              <text wx:if="{{item.equipped}}" class="equipment-admin__inventory-tag">已装备</text>
            </view>
          </view>
        </view>
        <view wx:else class="equipment-admin__empty">尚未拥有其他装备</view>
      </view>
    </view>
  </view>
</view>

<view wx:if="{{loading}}" class="loading">加载会员资料...</view>

<view wx:if="{{rechargeVisible}}" class="dialog-mask" bindtap="hideRechargeDialog">
  <view class="dialog" catchtap="noop" catchtouchmove="noop">
    <view class="dialog-title">充值到账户余额</view>
    <view class="dialog-body">
      <view class="dialog-tip">金额单位：元（保留两位小数）</view>
      <input
        class="dialog-input"
        type="digit"
        placeholder="请输入充值金额"
        value="{{rechargeAmount}}"
        bindinput="handleRechargeInput"
      />
    </view>
    <view class="dialog-actions">
      <button size="mini" class="dialog-btn" bindtap="hideRechargeDialog">取消</button>
      <button size="mini" class="dialog-btn primary" bindtap="handleRechargeConfirm">确认充值</button>
    </view>
  </view>
</view>
