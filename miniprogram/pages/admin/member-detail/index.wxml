<custom-nav title="会员资料" theme="dark"></custom-nav>
<view class="member-detail" wx:if="{{!loading}}">
  <view class="section">
    <view class="section-title">账号信息</view>
    <view class="info-row">
      <view class="info-label">会员 ID</view>
      <view class="info-value">{{member._id}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">注册时间</view>
      <view class="info-value">{{member.createdAt || '—'}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">最近更新</view>
      <view class="info-value">{{member.updatedAt || '—'}}</view>
    </view>
  </view>

  <view class="section">
    <view class="section-title">基础资料</view>
    <view class="toolbar">
      <button class="recharge" size="mini" bindtap="showRechargeDialog">为该会员充值</button>
    </view>
    <view class="form-item">
      <view class="form-label">道号</view>
      <input
        class="form-input"
        value="{{form.nickName}}"
        placeholder="请输入昵称"
        data-field="nickName"
        bindinput="handleInputChange"
      />
    </view>
    <view class="rename-meta">
      <text>剩余改名次数：{{member.renameCredits || 0}}</text>
      <text>已使用：{{member.renameUsed || 0}}</text>
    </view>
    <view wx:if="{{renameHistory.length}}" class="rename-history">
      <view class="rename-history__title">改名记录</view>
      <view class="rename-history__item" wx:for="{{renameHistory}}" wx:key="id">
        <view class="rename-history__names">{{item.previous}} → {{item.current}}</view>
        <view class="rename-history__meta">{{item.time}} · {{item.source}}</view>
      </view>
    </view>
    <view class="form-item">
      <view class="form-label">手机号</view>
      <input
        class="form-input"
        value="{{form.mobile}}"
        placeholder="请输入手机号"
        data-field="mobile"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">修为值</view>
      <input
        class="form-input"
        type="number"
        value="{{form.experience}}"
        placeholder="请输入修为值"
        data-field="experience"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">灵石余额（枚）</view>
      <input
        class="form-input"
        type="number"
        value="{{form.stoneBalance}}"
        placeholder="请输入灵石余额"
        data-field="stoneBalance"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">现金余额（元）</view>
      <input
        class="form-input"
        type="digit"
        value="{{form.cashBalance}}"
        placeholder="请输入现金余额"
        data-field="cashBalance"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">当前境界</view>
      <view class="readonly-value">{{currentLevelName || '—'}}</view>
    </view>
    <view class="form-item">
      <view class="form-label">角色权限</view>
      <checkbox-group class="role-group" bindchange="handleRolesChange">
        <label
          wx:for="{{roleOptions}}"
          wx:key="value"
          class="role-option {{item.checked ? 'checked' : ''}}"
        >
          <checkbox
            value="{{item.value}}"
            checked="{{item.checked}}"
            disabled="{{item.disabled}}"
          />
          <text class="role-label">{{item.label}}</text>
        </label>
      </checkbox-group>
    </view>
  </view>

  <button class="submit" type="primary" loading="{{saving}}" bindtap="handleSubmit">保存修改</button>
</view>

<view wx:if="{{loading}}" class="loading">加载会员资料...</view>

<view wx:if="{{rechargeVisible}}" class="dialog-mask" bindtap="hideRechargeDialog">
  <view class="dialog" catchtap="noop" catchtouchmove="noop">
    <view class="dialog-title">充值到账户余额</view>
    <view class="dialog-body">
      <view class="dialog-tip">金额单位：元（保留两位小数）</view>
      <input
        class="dialog-input"
        type="digit"
        placeholder="请输入充值金额"
        value="{{rechargeAmount}}"
        bindinput="handleRechargeInput"
      />
    </view>
    <view class="dialog-actions">
      <button size="mini" class="dialog-btn" bindtap="hideRechargeDialog">取消</button>
      <button size="mini" class="dialog-btn primary" bindtap="handleRechargeConfirm">确认充值</button>
    </view>
  </view>
</view>
