<custom-nav title="会员资料" theme="dark"></custom-nav>
<view class="member-detail" wx:if="{{!loading}}">
  <view class="section">
    <view class="section-title">账号信息</view>
    <view class="info-row">
      <view class="info-label">会员 ID</view>
      <view class="info-value">{{member._id}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">注册时间</view>
      <view class="info-value">{{member.createdAt || '—'}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">最近更新</view>
      <view class="info-value">{{member.updatedAt || '—'}}</view>
    </view>
  </view>

  <view class="section section--basic">
    <view class="section-title">基础资料</view>
    <view class="toolbar">
      <button class="recharge" size="mini" bindtap="showRechargeDialog">为该会员充值</button>
      <button
        wx:if="{{proxyLoginAvailable}}"
        class="proxy-login"
        size="mini"
        loading="{{proxyLoginLoading}}"
        disabled="{{proxyLoginLoading}}"
        bindtap="handleProxyLogin"
      >
        上身
      </button>
      <button
        class="delete-member"
        size="mini"
        type="warn"
        loading="{{deleting}}"
        disabled="{{loading || deleting}}"
        bindtap="handleDeleteMember"
      >
        删除会员
      </button>
    </view>
    <view class="basic-info-grid">
      <view class="form-item">
        <view class="form-label">道号</view>
        <input
          class="form-input"
          value="{{form.nickName}}"
          placeholder="请输入昵称"
          data-field="nickName"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">真实姓名</view>
        <input
          class="form-input"
          value="{{form.realName}}"
          placeholder="请输入真实姓名"
          data-field="realName"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">剩余改名次数</view>
        <input
          class="form-input"
          type="number"
          value="{{form.renameCredits}}"
          placeholder="请输入剩余改名次数"
          data-field="renameCredits"
          bindinput="handleInputChange"
        />
        <view class="rename-meta">
          <text>已使用改名次数：{{member.renameUsed || 0}}</text>
        </view>
      </view>
      <view class="form-item">
        <view class="form-label">可洗点次数</view>
        <input
          class="form-input"
          type="number"
          value="{{form.respecAvailable}}"
          placeholder="请输入剩余洗点次数"
          data-field="respecAvailable"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">抽取灵技次数</view>
        <input
          class="form-input"
          type="number"
          value="{{form.skillDrawCredits}}"
          placeholder="请输入剩余收取灵技次数"
          data-field="skillDrawCredits"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">纳戒升级次数</view>
        <input
          class="form-input"
          type="number"
          value="{{form.storageUpgradeAvailable}}"
          placeholder="请输入剩余纳戒升级次数"
          data-field="storageUpgradeAvailable"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">纳戒升级上限</view>
        <input
          class="form-input"
          type="number"
          value="{{form.storageUpgradeLimit}}"
          placeholder="请输入纳戒升级上限"
          data-field="storageUpgradeLimit"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">包房使用次数</view>
        <input
          class="form-input"
          type="number"
          value="{{form.roomUsageCount}}"
          placeholder="请输入剩余包房使用次数"
          data-field="roomUsageCount"
          bindinput="handleInputChange"
        />
      </view>
      <view
        wx:if="{{renameHistory.length}}"
        class="rename-history basic-info-grid__full"
      >
        <view class="rename-history__title">改名记录</view>
        <view class="rename-history__item" wx:for="{{renameHistory}}" wx:key="id">
          <view class="rename-history__names">{{item.previous}} → {{item.current}}</view>
          <view class="rename-history__meta">{{item.time}} · {{item.source}}</view>
        </view>
      </view>
      <view class="form-item">
        <view class="form-label">手机号</view>
        <input
          class="form-input"
          value="{{form.mobile}}"
          placeholder="请输入手机号"
          data-field="mobile"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">修为值</view>
        <input
          class="form-input"
          type="number"
          value="{{form.experience}}"
          placeholder="请输入修为值"
          data-field="experience"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">灵石余额（枚）</view>
        <input
          class="form-input"
          type="number"
          value="{{form.stoneBalance}}"
          placeholder="请输入灵石余额"
          data-field="stoneBalance"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">现金余额（元）</view>
        <input
          class="form-input"
          type="digit"
          value="{{form.cashBalance}}"
          placeholder="请输入现金余额"
          data-field="cashBalance"
          bindinput="handleInputChange"
        />
      </view>
      <view class="form-item">
        <view class="form-label">当前境界</view>
        <view class="readonly-value">{{currentLevelName || '—'}}</view>
      </view>
      <view class="form-item basic-info-grid__full">
        <view class="form-label">角色权限</view>
        <checkbox-group class="role-group" bindchange="handleRolesChange">
          <label
            wx:for="{{roleOptions}}"
            wx:key="value"
            class="role-option {{item.checked ? 'checked' : ''}}"
          >
            <checkbox
              value="{{item.value}}"
              checked="{{item.checked}}"
              disabled="{{item.disabled}}"
            />
            <text class="role-label">{{item.label}}</text>
          </label>
        </checkbox-group>

      </view>

      <view class="form-item basic-info-grid__full">
        <view class="form-label">头像权限</view>
        <view class="avatar-permission-summary">
          <text class="avatar-permission-summary__primary">{{avatarPermissionSummary}}</text>
          <text class="avatar-permission-summary__note">C 级头像默认开放</text>
        </view>
        <button class="avatar-edit-button" size="mini" bindtap="showAvatarPermissionDialog">编辑头像权限</button>
      </view>
      <view class="form-item basic-info-grid__full">
        <view class="form-label">称号管理</view>
        <view class="title-manager-summary">
          <text class="title-manager-summary__primary">{{titleSummary}}</text>
          <text class="title-manager-summary__note">图片位于 /assets/title/，文件名无需后缀</text>
        </view>
        <button class="title-manager-button" size="mini" bindtap="openTitleManagerDialog">管理称号</button>
      </view>
      <view class="form-item basic-info-grid__full">
        <view class="form-label">背景管理</view>
        <view class="background-manager-summary">
          <text class="background-manager-summary__primary">{{backgroundSummary}}</text>
          <text class="background-manager-summary__note">图片位于 /assets/background/，文件名无需后缀</text>
        </view>
        <button class="background-manager-button" size="mini" bindtap="openBackgroundManagerDialog">管理背景</button>
      </view>
    </view>
  </view>

  <button class="submit" type="primary" loading="{{saving}}" bindtap="handleSubmit">保存修改</button>

  <view class="section section--secret-realm">
    <view class="section-title">秘境挑战进度</view>
    <view class="secret-realm-info">
      <view>最高解锁：第{{secretRealmProfile.highestUnlockedFloor || 1}}层</view>
      <view>已通关：{{secretRealmProfile.clearedCount || 0}} / {{secretRealmProfile.totalFloors || 0}} 层</view>
    </view>
    <view class="form-item">
      <view class="form-label">目标解锁楼层</view>
      <input
        class="form-input"
        type="number"
        value="{{secretRealmDraft.highestUnlockedFloor}}"
        placeholder="请输入目标楼层"
        data-field="highestUnlockedFloor"
        bindinput="handleSecretRealmFieldChange"
      />
      <view class="form-hint">
        范围：不少于 1
        <text wx:if="{{secretRealmProfile.totalFloors}}"> · 最大 {{secretRealmProfile.totalFloors}}</text>
      </view>
    </view>
    <view class="secret-realm-toggle">
      <text class="secret-realm-toggle__label">自动补全之前楼层的通关记录</text>
      <switch
        checked="{{secretRealmDraft.autoComplete}}"
        bindchange="handleSecretRealmAutoCompleteChange"
        color="#566aff"
        disabled="{{secretRealmSaving || secretRealmResetting}}"
      ></switch>
    </view>
    <view class="secret-realm-actions">
      <button
        class="secret-realm-button secret-realm-button--primary"
        bindtap="handleSecretRealmSave"
        loading="{{secretRealmSaving}}"
        disabled="{{secretRealmSaving || secretRealmResetting}}"
      >保存进度</button>
      <button
        class="secret-realm-button"
        bindtap="handleSecretRealmReset"
        loading="{{secretRealmResetting}}"
        disabled="{{secretRealmSaving || secretRealmResetting}}"
      >重置为初始</button>
    </view>
    <view wx:if="{{secretRealmSummary}}" class="status-banner status-banner--success">{{secretRealmSummary}}</view>
    <view wx:if="{{secretRealmError}}" class="status-banner status-banner--error">{{secretRealmError}}</view>
  </view>

  <view class="section section--equipment">
    <view class="equipment-admin__header">
      <view class="section-title equipment-admin__title">物品管理</view>
      <button
        class="grant-equipment-btn"
        size="mini"
        type="primary"
        loading="{{grantingEquipment}}"
        disabled="{{!(equipmentCatalog && equipmentCatalog.length)}}"
        bindtap="showEquipmentGrantDialog"
      >
        装备发放
      </button>
      <text wx:if="{{!(equipmentCatalog && equipmentCatalog.length)}}" class="equipment-admin__hint">请稍候，正在加载装备目录</text>
    </view>
    <view wx:if="{{equipmentProfileLoaded}}" class="equipment-admin__content">
      <view class="equipment-admin__block">
        <view class="equipment-admin__subtitle">已装备</view>
        <view wx:if="{{equipmentSlots.length}}" class="equipment-admin__slot-list">
          <view
            class="equipment-admin__slot"
            wx:for="{{equipmentSlots}}"
            wx:for-index="slotIndex"
            wx:key="slot"
            data-item-id="{{item.itemId}}"
            data-inventory-id="{{item.inventoryId || item.itemId}}"
            bindlongpress="handleEquipmentItemLongPress"
          >
            <view class="equipment-admin__slot-content">
              <view
                wx:if="{{item.iconUrl}}"
                class="equipment-admin__slot-icon"
                style="border-color: {{item.qualityColor}};"
              >
                <image
                  class="equipment-admin__slot-icon-image"
                  src="{{item.iconUrl}}"
                  mode="aspectFill"
                  data-context="slot"
                  data-index="{{slotIndex}}"
                  data-fallback="{{item.iconFallbackUrl}}"
                  binderror="handleEquipmentIconError"
                />
              </view>
              <view class="equipment-admin__slot-text">
                <text class="equipment-admin__slot-label">{{item.slotLabel}}</text>
                <text class="equipment-admin__slot-value" style="color: {{item.qualityColor}};">{{item.name || '未装备'}}</text>
              </view>
            </view>
          </view>
        </view>
        <view wx:else class="equipment-admin__empty">暂无装备数据</view>
      </view>
      <view class="equipment-admin__block">
        <view class="equipment-admin__subtitle">背包装备</view>
        <view wx:if="{{equipmentInventory.length}}" class="equipment-admin__inventory">
          <view
            class="equipment-admin__inventory-item"
            wx:for="{{equipmentInventory}}"
            wx:for-index="inventoryIndex"
            wx:key="inventoryId"
            data-item-id="{{item.itemId}}"
            data-inventory-id="{{item.inventoryId || item.itemId}}"
            bindlongpress="handleEquipmentItemLongPress"
          >
            <view
              wx:if="{{item.iconUrl}}"
              class="equipment-admin__inventory-icon"
              style="border-color: {{item.qualityColor}};"
            >
              <image
                class="equipment-admin__inventory-icon-image"
                src="{{item.iconUrl}}"
                mode="aspectFill"
                data-context="inventory"
                data-index="{{inventoryIndex}}"
                data-fallback="{{item.iconFallbackUrl}}"
                binderror="handleEquipmentIconError"
              />
            </view>
            <view class="equipment-admin__inventory-info">
              <view class="equipment-admin__inventory-name" style="color: {{item.qualityColor}};">{{item.name}}</view>
              <view class="equipment-admin__inventory-meta">
                <text>{{item.qualityLabel}}</text>
                <text wx:if="{{item.slotLabel}}">{{item.slotLabel}}</text>
                <text wx:if="{{item.obtainedAtText}}">{{item.obtainedAtText}}</text>
                <text wx:if="{{item.equipped}}" class="equipment-admin__inventory-tag">已装备</text>
              </view>
            </view>
            <button
              class="equipment-admin__inventory-remove"
              size="mini"
              type="warn"
              loading="{{removingEquipmentInventoryId === (item.inventoryId || item.itemId)}}"
              disabled="{{removingEquipmentInventoryId && removingEquipmentInventoryId !== (item.inventoryId || item.itemId)}}"
              data-item-id="{{item.itemId}}"
              data-inventory-id="{{item.inventoryId || item.itemId}}"
              bindtap="handleEquipmentDelete"
            >
              删除
            </button>
          </view>
        </view>
        <view wx:else class="equipment-admin__empty">尚未拥有其他装备</view>
      </view>
    </view>
    <view wx:else class="equipment-admin__empty">暂未获取装备数据</view>
  </view>
</view>

<view wx:if="{{equipmentEditDialogVisible}}" class="dialog-mask" bindtap="hideEquipmentEditDialog">
  <view class="equipment-edit-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="equipment-edit-dialog__title">{{equipmentEditItem.name || '装备详情'}}</view>
    <view class="equipment-edit-dialog__meta">
      <text wx:if="{{equipmentEditItem.qualityLabel}}">{{equipmentEditItem.qualityLabel}}</text>
      <text wx:if="{{equipmentEditItem.slotLabel}}">{{equipmentEditItem.slotLabel}}</text>
      <text wx:if="{{equipmentEditItem.refineLabel}}">{{equipmentEditItem.refineLabel}}</text>
    </view>
    <view
      wx:if="{{equipmentEditItem.statsText && equipmentEditItem.statsText.length}}"
      class="equipment-edit-dialog__stats"
    >
      <text
        wx:for="{{equipmentEditItem.statsText}}"
        wx:key="*this"
        class="equipment-edit-dialog__stat"
      >
        {{item}}
      </text>
    </view>
    <view class="equipment-edit-dialog__field">
      <text class="equipment-edit-dialog__label">精炼等级</text>
      <input
        class="equipment-edit-dialog__input"
        type="number"
        value="{{equipmentEditForm.refine}}"
        bindinput="handleEquipmentEditRefineInput"
        placeholder="请输入精炼等级"
      />
      <text class="equipment-edit-dialog__hint">请输入不小于 0 的整数</text>
    </view>
    <view class="equipment-edit-dialog__actions">
      <button size="mini" class="equipment-edit-dialog__btn" bindtap="hideEquipmentEditDialog">取消</button>
      <button
        size="mini"
        class="equipment-edit-dialog__btn equipment-edit-dialog__btn--primary"
        loading="{{updatingEquipment}}"
        disabled="{{updatingEquipment}}"
        bindtap="handleEquipmentEditConfirm"
      >
        保存
      </button>
    </view>
  </view>
</view>

<view wx:if="{{avatarPermissionDialogVisible}}" class="dialog-mask" bindtap="hideAvatarPermissionDialog">
  <view class="avatar-permission-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="avatar-permission-dialog__header">
      <view class="avatar-permission-dialog__title">编辑头像权限</view>
      <text class="avatar-permission-dialog__subtitle">C 级头像默认开放</text>
    </view>
    <scroll-view scroll-y class="avatar-permission-dialog__content">
      <checkbox-group class="avatar-permission-grid" bindchange="handleAvatarDialogChange">
        <block wx:for="{{avatarDialogOptionGroups}}" wx:key="gender">
          <view class="avatar-permission-group">
            <view class="avatar-permission-group__title">{{item.label}}</view>
            <view class="avatar-permission-group__list">
              <label
                wx:for="{{item.options}}"
                wx:for-item="option"
                wx:key="id"
                class="avatar-permission-item {{option.disabled ? 'avatar-permission-item--disabled' : ''}}"
              >
                <checkbox
                  value="{{option.id}}"
                  checked="{{option.checked}}"
                  disabled="{{option.disabled}}"
                />
                <image
                  wx:if="{{option.url}}"
                  class="avatar-permission-item__image"
                  src="{{option.url}}"
                  mode="aspectFill"
                ></image>
                <view class="avatar-permission-item__info">
                  <text class="avatar-permission-name {{option.disabled ? 'avatar-permission-name--disabled' : ''}}">{{option.label}}</text>
                  <view class="avatar-permission-item__meta">
                    <text>{{option.genderLabel}}</text>
                    <text class="avatar-permission-item__dot">·</text>
                    <text>{{option.rarityLabel}}</text>
                    <text
                      wx:if="{{option.attributeBonus}}"
                      class="avatar-permission-item__bonus"
                    >· 属性+{{option.attributeBonus}}</text>
                  </view>
                </view>
                <text wx:if="{{option.disabled}}" class="avatar-permission-tag">默认</text>
              </label>
            </view>
          </view>
        </block>
      </checkbox-group>

      <view class="avatar-permission-owned">
        <view class="avatar-permission-owned__label">会员已拥有的头像</view>
        <view wx:if="{{avatarManagerUnlockedEntries.length}}" class="avatar-permission-owned__list">
          <view wx:for="{{avatarManagerUnlockedEntries}}" wx:key="id" class="avatar-permission-owned__item">
            <image wx:if="{{item.preview}}" class="avatar-permission-owned__item-image" src="{{item.preview}}" mode="aspectFill"></image>
            <view class="avatar-permission-owned__info">
              <text class="avatar-permission-owned__name">{{item.name}}</text>
              <text class="avatar-permission-owned__meta">{{item.rarityLabel}}</text>
            </view>
            <button
              wx:if="{{item.isCustom}}"
              class="avatar-custom-item__remove avatar-permission-owned__remove"
              size="mini"
              data-id="{{item.id}}"
              data-name="{{item.name}}"
              bindtap="handleAvatarManagerRemove"
              disabled="{{avatarManagerSaving}}"
            >
              删除
            </button>
          </view>
        </view>
        <view wx:else class="avatar-permission-owned__empty">暂未解锁任何头像</view>
      </view>

      <view class="avatar-permission-custom">
        <view class="avatar-permission-custom__header">
          <view class="avatar-permission-custom__title">新增自定义头像</view>
          <text class="avatar-permission-custom__note">头像位于 /assets/avatar/，立绘位于 /assets/character/，文件名无需后缀</text>
        </view>
        <view wx:if="{{avatarManagerEntries.length}}" class="avatar-custom-list">
          <block wx:for="{{avatarManagerEntries}}" wx:key="id">
            <view class="avatar-custom-item">
              <image wx:if="{{item.preview}}" class="avatar-custom-item__image" src="{{item.preview}}" mode="aspectFill"></image>
              <view class="avatar-custom-item__details">
                <view class="avatar-custom-item__name">{{item.name}}</view>
                <view class="avatar-custom-item__meta">{{item.genderLabel}} · {{item.rarityLabel}} · 文件名：{{item.file}}</view>
              </view>
              <button
                class="avatar-custom-item__remove"
                size="mini"
                data-id="{{item.id}}"
                data-name="{{item.name}}"
                bindtap="handleAvatarManagerRemove"
                disabled="{{avatarManagerSaving}}"
              >
                删除
              </button>
            </view>
          </block>
        </view>
        <view wx:else class="avatar-custom-empty">尚未添加自定义头像</view>

        <view class="avatar-custom-form">
          <input
            class="avatar-custom-form__input"
            placeholder="头像名称"
            value="{{avatarManagerForm.name}}"
            data-field="name"
            bindinput="handleAvatarManagerInput"
          />
          <picker
            mode="selector"
            class="avatar-custom-form__picker"
            range="{{avatarGenderOptions}}"
            range-key="label"
            data-field="gender"
            value="{{avatarManagerForm.gender === 'female' ? 1 : 0}}"
            bindchange="handleAvatarManagerPickerChange"
          >
            <view class="avatar-custom-form__picker-view">{{avatarManagerForm.gender === 'female' ? '女修' : '男修'}}</view>
          </picker>
          <picker
            mode="selector"
            class="avatar-custom-form__picker"
            range="{{avatarRarityOptions}}"
            range-key="label"
            data-field="rarity"
            value="{{avatarRarityIndexMap[avatarManagerForm.rarity] || 0}}"
            bindchange="handleAvatarManagerPickerChange"
          >
            <view class="avatar-custom-form__picker-view">{{rarityLabels[avatarManagerForm.rarity] || avatarManagerForm.rarity.toUpperCase()}}</view>
          </picker>
          <input
            class="avatar-custom-form__input"
            placeholder="文件名（无需后缀）"
            value="{{avatarManagerForm.file}}"
            data-field="file"
            bindinput="handleAvatarManagerInput"
          />
          <button class="avatar-custom-form__add" size="mini" bindtap="handleAvatarManagerAdd">添加</button>
        </view>
      </view>

    </scroll-view>
    <view class="avatar-permission-dialog__actions">
      <button class="avatar-permission-dialog__button" size="mini" bindtap="hideAvatarPermissionDialog">取消</button>
      <button
        class="avatar-permission-dialog__button avatar-permission-dialog__button--primary"
        size="mini"
        type="primary"
        loading="{{avatarManagerSaving}}"
        disabled="{{avatarManagerSaving || !avatarManagerDirty}}"
        bindtap="handleAvatarManagerSave"
      >
        保存
      </button>
    </view>
  </view>
</view>


<view wx:if="{{titleManagerVisible}}" class="dialog-mask" bindtap="handleCloseTitleManager">
  <view class="title-manager-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="title-manager-dialog__title">称号管理</view>
    <view class="title-manager-owned">
      <view class="title-manager-owned__label">会员已拥有的称号</view>
      <view wx:if="{{titleManagerUnlockedEntries.length}}" class="title-manager-owned__list">
        <view
          wx:for="{{titleManagerUnlockedEntries}}"
          wx:key="id"
          class="title-manager-owned__item"
        >
          <image
            wx:if="{{item.preview}}"
            class="title-manager-owned__item-image"
            src="{{item.preview}}"
            mode="aspectFit"
          ></image>
          <text class="title-manager-owned__name">{{item.name}}</text>
        </view>
      </view>
      <view wx:else class="title-manager-owned__empty">暂未解锁任何称号</view>
    </view>
    <scroll-view scroll-y class="title-manager-dialog__content">
      <view wx:if="{{titleManagerEntries.length}}" class="title-manager-list">
        <block wx:for="{{titleManagerEntries}}" wx:key="id">
          <view class="title-manager-item">
            <image
              wx:if="{{item.preview}}"
              class="title-manager-item__image"
              src="{{item.preview}}"
              mode="aspectFit"
            ></image>
            <view class="title-manager-item__details">
              <view class="title-manager-item__name">{{item.name}}</view>
              <view class="title-manager-item__meta">文件名：{{item.imageFile}}</view>
            </view>
            <view class="title-manager-item__actions">
              <button
                class="title-manager-item__remove"
                size="mini"
                type="warn"
                data-id="{{item.id}}"
                bindtap="handleTitleManagerRemove"
              >
                删除
              </button>
            </view>
          </view>
        </block>
      </view>
      <view wx:else class="title-manager-empty">尚未添加自定义称号</view>
    </scroll-view>
    <view class="title-manager-form">
      <input
        class="title-manager-form__input"
        placeholder="称号名称"
        value="{{titleManagerForm.name}}"
        data-field="name"
        bindinput="handleTitleManagerInput"
      />
      <input
        class="title-manager-form__input"
        placeholder="文件名（不含后缀）"
        value="{{titleManagerForm.file}}"
        data-field="file"
        bindinput="handleTitleManagerInput"
      />
      <button class="title-manager-form__add" size="mini" bindtap="handleTitleManagerAdd">添加</button>
    </view>
    <view class="title-manager-dialog__actions">
      <button
        class="title-manager-dialog__button"
        size="mini"
        bindtap="handleCloseTitleManager"
        disabled="{{titleManagerSaving}}"
      >
        取消
      </button>
      <button
        class="title-manager-dialog__button title-manager-dialog__button--primary"
        size="mini"
        type="primary"
        bindtap="handleTitleManagerSave"
        loading="{{titleManagerSaving}}"
        disabled="{{titleManagerSaving || !titleManagerDirty}}"
      >
        保存
      </button>
    </view>
  </view>
</view>

<view wx:if="{{backgroundManagerVisible}}" class="dialog-mask" bindtap="handleCloseBackgroundManager">
  <view class="background-manager-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="background-manager-dialog__title">背景管理</view>
    <view class="background-manager-owned">
      <view class="background-manager-owned__label">会员已拥有的背景</view>
      <view wx:if="{{backgroundManagerUnlockedEntries.length}}" class="background-manager-owned__list">
        <view wx:for="{{backgroundManagerUnlockedEntries}}" wx:key="id" class="background-manager-owned__item">
          <image
            wx:if="{{item.preview}}"
            class="background-manager-owned__item-image"
            src="{{item.preview}}"
            mode="aspectFill"
          />
          <text class="background-manager-owned__name">{{item.name}}</text>
        </view>
      </view>
      <view wx:else class="background-manager-owned__empty">暂未解锁任何背景</view>
    </view>
    <scroll-view scroll-y class="background-manager-dialog__content">
      <view wx:if="{{backgroundManagerEntries.length}}" class="background-manager-list">
        <block wx:for="{{backgroundManagerEntries}}" wx:key="id">
          <view class="background-manager-item">
            <image
              wx:if="{{item.preview}}"
              class="background-manager-item__image"
              src="{{item.preview}}"
              mode="aspectFit"
            />
            <view class="background-manager-item__details">
              <view class="background-manager-item__name">{{item.name}}</view>
              <view class="background-manager-item__meta">文件名：{{item.mediaKey}}</view>
            </view>
            <view class="background-manager-item__actions">
              <button
                class="background-manager-item__remove"
                size="mini"
                type="warn"
                data-id="{{item.id}}"
                bindtap="handleBackgroundManagerRemove"
              >
                删除
              </button>
            </view>
          </view>
        </block>
      </view>
      <view wx:else class="background-manager-empty">尚未添加自定义背景</view>
    </scroll-view>
    <view class="background-manager-form">
      <input
        class="background-manager-form__input"
        placeholder="背景名称"
        value="{{backgroundManagerForm.name}}"
        data-field="name"
        bindinput="handleBackgroundManagerInput"
      />
      <input
        class="background-manager-form__input"
        placeholder="文件名（不含后缀）"
        value="{{backgroundManagerForm.file}}"
        data-field="file"
        bindinput="handleBackgroundManagerInput"
      />
      <button class="background-manager-form__add" size="mini" bindtap="handleBackgroundManagerAdd">添加</button>
    </view>
    <view class="background-manager-dialog__actions">
      <button
        class="background-manager-dialog__button"
        size="mini"
        bindtap="handleCloseBackgroundManager"
        disabled="{{backgroundManagerSaving}}"
      >
        取消
      </button>
      <button
        class="background-manager-dialog__button background-manager-dialog__button--primary"
        size="mini"
        type="primary"
        bindtap="handleBackgroundManagerSave"
        loading="{{backgroundManagerSaving}}"
        disabled="{{backgroundManagerSaving || !backgroundManagerDirty}}"
      >
        保存
      </button>
    </view>
  </view>
</view>

<view wx:if="{{loading}}" class="loading">加载会员资料...</view>

<view wx:if="{{rechargeVisible}}" class="dialog-mask" bindtap="hideRechargeDialog">
  <view class="dialog" catchtap="noop" catchtouchmove="noop">
    <view class="dialog-title">充值到账户余额</view>
    <view class="dialog-body">
      <view class="dialog-tip">金额单位：元（保留两位小数）</view>
      <input
        class="dialog-input"
        type="digit"
        placeholder="请输入充值金额"
        value="{{rechargeAmount}}"
        bindinput="handleRechargeInput"
      />
    </view>
    <view class="dialog-actions">
      <button size="mini" class="dialog-btn" bindtap="hideRechargeDialog">取消</button>
      <button size="mini" class="dialog-btn primary" bindtap="handleRechargeConfirm">确认充值</button>
    </view>
  </view>
</view>

<view wx:if="{{equipmentDialogVisible}}" class="dialog-mask" bindtap="hideEquipmentGrantDialog">
  <view class="equipment-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="equipment-dialog__title">选择发放装备</view>
    <view class="equipment-dialog__filters">
      <view class="equipment-dialog__filter">
        <text class="equipment-dialog__filter-label">部位</text>
        <picker
          mode="selector"
          range="{{equipmentFilterSlotOptions}}"
          range-key="label"
          value="{{equipmentFilterSlotIndex}}"
          bindchange="handleEquipmentSlotFilterChange"
        >
          <view class="equipment-dialog__filter-value">{{equipmentFilterSlotOptions[equipmentFilterSlotIndex].label}}</view>
        </picker>
      </view>
      <view class="equipment-dialog__filter">
        <text class="equipment-dialog__filter-label">品质</text>
        <picker
          mode="selector"
          range="{{equipmentFilterQualityOptions}}"
          range-key="label"
          value="{{equipmentFilterQualityIndex}}"
          bindchange="handleEquipmentQualityFilterChange"
        >
          <view class="equipment-dialog__filter-value">{{equipmentFilterQualityOptions[equipmentFilterQualityIndex].label}}</view>
        </picker>
      </view>
    </view>
    <scroll-view scroll-y class="equipment-dialog__list">
      <view wx:if="{{!(filteredEquipmentCatalog && filteredEquipmentCatalog.length)}}" class="equipment-dialog__empty">
        当前筛选下暂无装备，请调整筛选条件
      </view>
      <radio-group
        wx:else
        class="equipment-dialog__group"
        bindchange="handleEquipmentSelect"
      >
        <label
          wx:for="{{filteredEquipmentCatalog}}"
          wx:key="id"
          class="equipment-dialog__option {{equipmentSelectionId === item.id ? 'equipment-dialog__option--active' : ''}}"
        >
          <radio value="{{item.id}}" checked="{{equipmentSelectionId === item.id}}" />
          <view class="equipment-dialog__option-content">
            <view
              wx:if="{{item.iconUrl}}"
              class="equipment-dialog__option-icon"
              style="border-color: {{item.qualityColor}};"
            >
              <image
                class="equipment-dialog__option-icon-image"
                src="{{item.iconUrl}}"
                mode="aspectFill"
                data-context="catalog"
                data-id="{{item.id}}"
                data-fallback="{{item.iconFallbackUrl}}"
                binderror="handleEquipmentIconError"
              />
            </view>
            <text class="equipment-dialog__option-text">{{item.name}}</text>
          </view>
        </label>
      </radio-group>
    </scroll-view>
    <view class="equipment-dialog__actions">
      <button size="mini" class="equipment-dialog__btn" bindtap="hideEquipmentGrantDialog">取消</button>
      <button
        size="mini"
        class="equipment-dialog__btn equipment-dialog__btn--primary"
        loading="{{grantingEquipment}}"
        disabled="{{!equipmentSelectionId}}"
        bindtap="handleEquipmentGrantConfirm"
      >
        确认发放
      </button>
    </view>
  </view>
</view>
