<custom-nav title="会员资料" theme="dark"></custom-nav>
<view class="member-detail" wx:if="{{!loading}}">
  <view class="section">
    <view class="section-title">账号信息</view>
    <view class="info-row">
      <view class="info-label">会员 ID</view>
      <view class="info-value">{{member._id}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">注册时间</view>
      <view class="info-value">{{member.createdAt || '—'}}</view>
    </view>
    <view class="info-row">
      <view class="info-label">最近更新</view>
      <view class="info-value">{{member.updatedAt || '—'}}</view>
    </view>
  </view>

  <view class="section">
    <view class="section-title">基础资料</view>
    <view class="toolbar">
      <button class="recharge" size="mini" bindtap="showRechargeDialog">为该会员充值</button>
      <button
        class="delete-member"
        size="mini"
        type="warn"
        loading="{{deleting}}"
        disabled="{{loading || deleting}}"
        bindtap="handleDeleteMember"
      >
        删除会员
      </button>
    </view>
    <view class="form-item">
      <view class="form-label">道号</view>
      <input
        class="form-input"
        value="{{form.nickName}}"
        placeholder="请输入昵称"
        data-field="nickName"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">真实姓名</view>
      <input
        class="form-input"
        value="{{form.realName}}"
        placeholder="请输入真实姓名"
        data-field="realName"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">剩余改名次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.renameCredits}}"
        placeholder="请输入剩余改名次数"
        data-field="renameCredits"
        bindinput="handleInputChange"
      />
    </view>
    <view class="rename-meta">
      <text>已使用改名次数：{{member.renameUsed || 0}}</text>
    </view>
    <view class="form-item">
      <view class="form-label">可洗点次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.respecAvailable}}"
        placeholder="请输入剩余洗点次数"
        data-field="respecAvailable"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">收取灵技次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.skillDrawCredits}}"
        placeholder="请输入剩余收取灵技次数"
        data-field="skillDrawCredits"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">纳戒升级次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.storageUpgradeAvailable}}"
        placeholder="请输入剩余纳戒升级次数"
        data-field="storageUpgradeAvailable"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">纳戒升级上限</view>
      <input
        class="form-input"
        type="number"
        value="{{form.storageUpgradeLimit}}"
        placeholder="请输入纳戒升级上限"
        data-field="storageUpgradeLimit"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">包房使用次数</view>
      <input
        class="form-input"
        type="number"
        value="{{form.roomUsageCount}}"
        placeholder="请输入剩余包房使用次数"
        data-field="roomUsageCount"
        bindinput="handleInputChange"
      />
    </view>
    <view wx:if="{{renameHistory.length}}" class="rename-history">
      <view class="rename-history__title">改名记录</view>
      <view class="rename-history__item" wx:for="{{renameHistory}}" wx:key="id">
        <view class="rename-history__names">{{item.previous}} → {{item.current}}</view>
        <view class="rename-history__meta">{{item.time}} · {{item.source}}</view>
      </view>
    </view>
    <view class="form-item">
      <view class="form-label">手机号</view>
      <input
        class="form-input"
        value="{{form.mobile}}"
        placeholder="请输入手机号"
        data-field="mobile"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">修为值</view>
      <input
        class="form-input"
        type="number"
        value="{{form.experience}}"
        placeholder="请输入修为值"
        data-field="experience"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">灵石余额（枚）</view>
      <input
        class="form-input"
        type="number"
        value="{{form.stoneBalance}}"
        placeholder="请输入灵石余额"
        data-field="stoneBalance"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">现金余额（元）</view>
      <input
        class="form-input"
        type="digit"
        value="{{form.cashBalance}}"
        placeholder="请输入现金余额"
        data-field="cashBalance"
        bindinput="handleInputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label">当前境界</view>
      <view class="readonly-value">{{currentLevelName || '—'}}</view>
    </view>
    <view class="form-item">
      <view class="form-label">角色权限</view>
      <checkbox-group class="role-group" bindchange="handleRolesChange">
        <label
          wx:for="{{roleOptions}}"
          wx:key="value"
          class="role-option {{item.checked ? 'checked' : ''}}"
        >
          <checkbox
            value="{{item.value}}"
            checked="{{item.checked}}"
            disabled="{{item.disabled}}"
          />
          <text class="role-label">{{item.label}}</text>
        </label>
      </checkbox-group>
    </view>
    <view class="form-item">
      <view class="form-label">头像权限</view>
      <view class="avatar-permission-note">C 级头像默认开放</view>
      <checkbox-group class="avatar-permission-grid" bindchange="handleAvatarUnlockChange">
        <block wx:for="{{avatarOptionGroups}}" wx:key="gender">
          <view class="avatar-permission-group">
            <view class="avatar-permission-group__title">{{item.label}}</view>
            <view class="avatar-permission-group__list">
              <label
                wx:for="{{item.options}}"
                wx:for-item="option"
                wx:key="id"
                class="avatar-permission-item {{option.disabled ? 'avatar-permission-item--disabled' : ''}}"
              >
                <checkbox
                  value="{{option.id}}"
                  checked="{{option.checked}}"
                  disabled="{{option.disabled}}"
                />
                <text class="avatar-permission-name {{option.disabled ? 'avatar-permission-name--disabled' : ''}}">{{option.label}}</text>
                <text wx:if="{{option.disabled}}" class="avatar-permission-tag">默认</text>
              </label>
            </view>
          </view>
        </block>
      </checkbox-group>
    </view>
  </view>

  <button class="submit" type="primary" loading="{{saving}}" bindtap="handleSubmit">保存修改</button>

  <view class="section section--secret-realm">
    <view class="section-title">秘境挑战进度</view>
    <view class="secret-realm-info">
      <view>最高解锁：第{{secretRealmProfile.highestUnlockedFloor || 1}}层</view>
      <view>已通关：{{secretRealmProfile.clearedCount || 0}} / {{secretRealmProfile.totalFloors || 0}} 层</view>
    </view>
    <view class="form-item">
      <view class="form-label">目标解锁楼层</view>
      <input
        class="form-input"
        type="number"
        value="{{secretRealmDraft.highestUnlockedFloor}}"
        placeholder="请输入目标楼层"
        data-field="highestUnlockedFloor"
        bindinput="handleSecretRealmFieldChange"
      />
      <view class="form-hint">
        范围：不少于 1
        <text wx:if="{{secretRealmProfile.totalFloors}}"> · 最大 {{secretRealmProfile.totalFloors}}</text>
      </view>
    </view>
    <view class="secret-realm-toggle">
      <text class="secret-realm-toggle__label">自动补全之前楼层的通关记录</text>
      <switch
        checked="{{secretRealmDraft.autoComplete}}"
        bindchange="handleSecretRealmAutoCompleteChange"
        color="#566aff"
        disabled="{{secretRealmSaving || secretRealmResetting}}"
      ></switch>
    </view>
    <view class="secret-realm-actions">
      <button
        class="secret-realm-button secret-realm-button--primary"
        bindtap="handleSecretRealmSave"
        loading="{{secretRealmSaving}}"
        disabled="{{secretRealmSaving || secretRealmResetting}}"
      >保存进度</button>
      <button
        class="secret-realm-button"
        bindtap="handleSecretRealmReset"
        loading="{{secretRealmResetting}}"
        disabled="{{secretRealmSaving || secretRealmResetting}}"
      >重置为初始</button>
    </view>
    <view wx:if="{{secretRealmSummary}}" class="status-banner status-banner--success">{{secretRealmSummary}}</view>
    <view wx:if="{{secretRealmError}}" class="status-banner status-banner--error">{{secretRealmError}}</view>
  </view>

  <view class="section section--equipment">
    <view class="equipment-admin__header">
      <view class="section-title equipment-admin__title">物品管理</view>
      <button
        class="grant-equipment-btn"
        size="mini"
        type="primary"
        loading="{{grantingEquipment}}"
        disabled="{{!(equipmentCatalog && equipmentCatalog.length)}}"
        bindtap="showEquipmentGrantDialog"
      >
        装备发放
      </button>
      <text wx:if="{{!(equipmentCatalog && equipmentCatalog.length)}}" class="equipment-admin__hint">请稍候，正在加载装备目录</text>
    </view>
    <view wx:if="{{equipmentProfileLoaded}}" class="equipment-admin__content">
      <view class="equipment-admin__block">
        <view class="equipment-admin__subtitle">已装备</view>
        <view wx:if="{{equipmentSlots.length}}" class="equipment-admin__slot-list">
          <view
            class="equipment-admin__slot"
            wx:for="{{equipmentSlots}}"
            wx:for-index="slotIndex"
            wx:key="slot"
            data-item-id="{{item.itemId}}"
            data-inventory-id="{{item.inventoryId || item.itemId}}"
            bindlongpress="handleEquipmentItemLongPress"
          >
            <view class="equipment-admin__slot-content">
              <view
                wx:if="{{item.iconUrl}}"
                class="equipment-admin__slot-icon"
                style="border-color: {{item.qualityColor}};"
              >
                <image
                  class="equipment-admin__slot-icon-image"
                  src="{{item.iconUrl}}"
                  mode="aspectFill"
                  data-context="slot"
                  data-index="{{slotIndex}}"
                  data-fallback="{{item.iconFallbackUrl}}"
                  binderror="handleEquipmentIconError"
                />
              </view>
              <view class="equipment-admin__slot-text">
                <text class="equipment-admin__slot-label">{{item.slotLabel}}</text>
                <text class="equipment-admin__slot-value" style="color: {{item.qualityColor}};">{{item.name || '未装备'}}</text>
              </view>
            </view>
          </view>
        </view>
        <view wx:else class="equipment-admin__empty">暂无装备数据</view>
      </view>
      <view class="equipment-admin__block">
        <view class="equipment-admin__subtitle">背包装备</view>
        <view wx:if="{{equipmentInventory.length}}" class="equipment-admin__inventory">
          <view
            class="equipment-admin__inventory-item"
            wx:for="{{equipmentInventory}}"
            wx:for-index="inventoryIndex"
            wx:key="inventoryId"
            data-item-id="{{item.itemId}}"
            data-inventory-id="{{item.inventoryId || item.itemId}}"
            bindlongpress="handleEquipmentItemLongPress"
          >
            <view
              wx:if="{{item.iconUrl}}"
              class="equipment-admin__inventory-icon"
              style="border-color: {{item.qualityColor}};"
            >
              <image
                class="equipment-admin__inventory-icon-image"
                src="{{item.iconUrl}}"
                mode="aspectFill"
                data-context="inventory"
                data-index="{{inventoryIndex}}"
                data-fallback="{{item.iconFallbackUrl}}"
                binderror="handleEquipmentIconError"
              />
            </view>
            <view class="equipment-admin__inventory-info">
              <view class="equipment-admin__inventory-name" style="color: {{item.qualityColor}};">{{item.name}}</view>
              <view class="equipment-admin__inventory-meta">
                <text>{{item.qualityLabel}}</text>
                <text wx:if="{{item.slotLabel}}">{{item.slotLabel}}</text>
                <text wx:if="{{item.obtainedAtText}}">{{item.obtainedAtText}}</text>
                <text wx:if="{{item.equipped}}" class="equipment-admin__inventory-tag">已装备</text>
              </view>
            </view>
            <button
              class="equipment-admin__inventory-remove"
              size="mini"
              type="warn"
              loading="{{removingEquipmentInventoryId === (item.inventoryId || item.itemId)}}"
              disabled="{{removingEquipmentInventoryId && removingEquipmentInventoryId !== (item.inventoryId || item.itemId)}}"
              data-item-id="{{item.itemId}}"
              data-inventory-id="{{item.inventoryId || item.itemId}}"
              bindtap="handleEquipmentDelete"
            >
              删除
            </button>
          </view>
        </view>
        <view wx:else class="equipment-admin__empty">尚未拥有其他装备</view>
      </view>
    </view>
    <view wx:else class="equipment-admin__empty">暂未获取装备数据</view>
  </view>
</view>

<view wx:if="{{equipmentEditDialogVisible}}" class="dialog-mask" bindtap="hideEquipmentEditDialog">
  <view class="equipment-edit-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="equipment-edit-dialog__title">{{equipmentEditItem.name || '装备详情'}}</view>
    <view class="equipment-edit-dialog__meta">
      <text wx:if="{{equipmentEditItem.qualityLabel}}">{{equipmentEditItem.qualityLabel}}</text>
      <text wx:if="{{equipmentEditItem.slotLabel}}">{{equipmentEditItem.slotLabel}}</text>
      <text wx:if="{{equipmentEditItem.refineLabel}}">{{equipmentEditItem.refineLabel}}</text>
    </view>
    <view
      wx:if="{{equipmentEditItem.statsText && equipmentEditItem.statsText.length}}"
      class="equipment-edit-dialog__stats"
    >
      <text
        wx:for="{{equipmentEditItem.statsText}}"
        wx:key="*this"
        class="equipment-edit-dialog__stat"
      >
        {{item}}
      </text>
    </view>
    <view class="equipment-edit-dialog__field">
      <text class="equipment-edit-dialog__label">精炼等级</text>
      <input
        class="equipment-edit-dialog__input"
        type="number"
        value="{{equipmentEditForm.refine}}"
        bindinput="handleEquipmentEditRefineInput"
        placeholder="请输入精炼等级"
      />
      <text class="equipment-edit-dialog__hint">请输入不小于 0 的整数</text>
    </view>
    <view class="equipment-edit-dialog__actions">
      <button size="mini" class="equipment-edit-dialog__btn" bindtap="hideEquipmentEditDialog">取消</button>
      <button
        size="mini"
        class="equipment-edit-dialog__btn equipment-edit-dialog__btn--primary"
        loading="{{updatingEquipment}}"
        disabled="{{updatingEquipment}}"
        bindtap="handleEquipmentEditConfirm"
      >
        保存
      </button>
    </view>
  </view>
</view>

<view wx:if="{{loading}}" class="loading">加载会员资料...</view>

<view wx:if="{{rechargeVisible}}" class="dialog-mask" bindtap="hideRechargeDialog">
  <view class="dialog" catchtap="noop" catchtouchmove="noop">
    <view class="dialog-title">充值到账户余额</view>
    <view class="dialog-body">
      <view class="dialog-tip">金额单位：元（保留两位小数）</view>
      <input
        class="dialog-input"
        type="digit"
        placeholder="请输入充值金额"
        value="{{rechargeAmount}}"
        bindinput="handleRechargeInput"
      />
    </view>
    <view class="dialog-actions">
      <button size="mini" class="dialog-btn" bindtap="hideRechargeDialog">取消</button>
      <button size="mini" class="dialog-btn primary" bindtap="handleRechargeConfirm">确认充值</button>
    </view>
  </view>
</view>

<view wx:if="{{equipmentDialogVisible}}" class="dialog-mask" bindtap="hideEquipmentGrantDialog">
  <view class="equipment-dialog" catchtap="noop" catchtouchmove="noop">
    <view class="equipment-dialog__title">选择发放装备</view>
    <view class="equipment-dialog__filters">
      <view class="equipment-dialog__filter">
        <text class="equipment-dialog__filter-label">部位</text>
        <picker
          mode="selector"
          range="{{equipmentFilterSlotOptions}}"
          range-key="label"
          value="{{equipmentFilterSlotIndex}}"
          bindchange="handleEquipmentSlotFilterChange"
        >
          <view class="equipment-dialog__filter-value">{{equipmentFilterSlotOptions[equipmentFilterSlotIndex].label}}</view>
        </picker>
      </view>
      <view class="equipment-dialog__filter">
        <text class="equipment-dialog__filter-label">品质</text>
        <picker
          mode="selector"
          range="{{equipmentFilterQualityOptions}}"
          range-key="label"
          value="{{equipmentFilterQualityIndex}}"
          bindchange="handleEquipmentQualityFilterChange"
        >
          <view class="equipment-dialog__filter-value">{{equipmentFilterQualityOptions[equipmentFilterQualityIndex].label}}</view>
        </picker>
      </view>
    </view>
    <scroll-view scroll-y class="equipment-dialog__list">
      <view wx:if="{{!(filteredEquipmentCatalog && filteredEquipmentCatalog.length)}}" class="equipment-dialog__empty">
        当前筛选下暂无装备，请调整筛选条件
      </view>
      <radio-group
        wx:else
        class="equipment-dialog__group"
        bindchange="handleEquipmentSelect"
      >
        <label
          wx:for="{{filteredEquipmentCatalog}}"
          wx:key="id"
          class="equipment-dialog__option {{equipmentSelectionId === item.id ? 'equipment-dialog__option--active' : ''}}"
        >
          <radio value="{{item.id}}" checked="{{equipmentSelectionId === item.id}}" />
          <view class="equipment-dialog__option-content">
            <view
              wx:if="{{item.iconUrl}}"
              class="equipment-dialog__option-icon"
              style="border-color: {{item.qualityColor}};"
            >
              <image
                class="equipment-dialog__option-icon-image"
                src="{{item.iconUrl}}"
                mode="aspectFill"
                data-context="catalog"
                data-id="{{item.id}}"
                data-fallback="{{item.iconFallbackUrl}}"
                binderror="handleEquipmentIconError"
              />
            </view>
            <text class="equipment-dialog__option-text">{{item.name}}</text>
          </view>
        </label>
      </radio-group>
    </scroll-view>
    <view class="equipment-dialog__actions">
      <button size="mini" class="equipment-dialog__btn" bindtap="hideEquipmentGrantDialog">取消</button>
      <button
        size="mini"
        class="equipment-dialog__btn equipment-dialog__btn--primary"
        loading="{{grantingEquipment}}"
        disabled="{{!equipmentSelectionId}}"
        bindtap="handleEquipmentGrantConfirm"
      >
        确认发放
      </button>
    </view>
  </view>
</view>
