<custom-nav title="è§’è‰²å…»æˆ" theme="dark"></custom-nav>
<view class="page">
  <view class="tab-bar">
    <view
      class="tab-item {{activeTab === 'character' ? 'tab-item--active' : ''}}"
      data-tab="character"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >è§’è‰²</view>
    <view
      class="tab-item {{activeTab === 'equipment' ? 'tab-item--active' : ''}}"
      data-tab="equipment"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >è£…å¤‡</view>
    <view
      class="tab-item {{activeTab === 'storage' ? 'tab-item--active' : ''}}"
      data-tab="storage"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >çº³æˆ’</view>
    <view
      class="tab-item {{activeTab === 'skill' ? 'tab-item--active' : ''}}"
      data-tab="skill"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >æŠ€èƒ½</view>
  </view>

  <view wx:if="{{loading}}" class="loading">çµæ°”æ±‡èšä¸­...</view>
  <scroll-view wx:elif="{{profile}}" scroll-y="true" class="scroll-container">
    <block wx:if="{{activeTab === 'character'}}">
      <view class="section-card role-attributes">
        <view class="section-header">
          <view class="section-title">åŸºç¡€å±æ€§</view>
          <view class="section-actions" wx:if="{{profile.attributes}}">
            <text class="section-actions__info">æ´—ç‚¹æ¬¡æ•° {{profile.attributes ? profile.attributes.respecAvailable : 0}}</text>
            <button
              class="pill-btn pill-btn--ghost section-actions__button"
              hover-class="pill-btn--hover"
              size="mini"
              loading="{{resetting}}"
              disabled="{{resetting || !(profile.attributes && profile.attributes.respecAvailable > 0)}}"
              bindtap="handleResetAttributes"
            >æ´—ç‚¹</button>
          </view>
        </view>
        <view class="attr-list">
          <view
            class="attr-row"
            wx:for="{{(profile.attributes && profile.attributes.attributeList) || []}}"
            wx:key="key"
          >
            <view
              class="attr-row__label"
              data-key="{{item.key}}"
              data-label="{{item.label}}"
              bindlongpress="handleAttributeLabelLongPress"
            >
              {{item.label}}
            </view>
            <view class="attr-row__value">{{item.formattedValue}}</view>
            <view
              class="attr-row__controls"
              wx:if="{{profile.attributes && profile.attributes.attributePoints > 0 && attributeAllocationEnabled[item.key]}}"
            >
              <button
                class="attr-control attr-control--minus"
                data-key="{{item.key}}"
                data-direction="decrease"
                bindtap="handleAttributeAdjustTap"
                bindtouchstart="handleAttributeAdjustTouchStart"
                bindtouchend="handleAttributeAdjustTouchEnd"
                bindtouchcancel="handleAttributeAdjustTouchEnd"
              >-</button>
              <input
                class="attr-input"
                type="number"
                placeholder="0"
                value="{{attributeAdjustments[item.key] !== undefined ? attributeAdjustments[item.key] : ''}}"
                data-key="{{item.key}}"
                bindinput="handleAttributeInput"
              />
              <button
                class="attr-control attr-control--plus"
                data-key="{{item.key}}"
                data-direction="increase"
                bindtap="handleAttributeAdjustTap"
                bindtouchstart="handleAttributeAdjustTouchStart"
                bindtouchend="handleAttributeAdjustTouchEnd"
                bindtouchcancel="handleAttributeAdjustTouchEnd"
              >+</button>
            </view>
          </view>
        </view>
        <view class="attr-extra">
          <text>æˆ˜åŠ› {{profile.attributes ? profile.attributes.combatPower : '--'}}</text>
          <text>å‰©ä½™å±æ€§ç‚¹ {{attributeAllocationRemaining}}</text>
        </view>
        <view
          class="attr-actions"
          wx:if="{{profile.attributes && profile.attributes.attributePoints > 0}}"
        >
          <button
            class="pill-btn pill-btn--primary attr-actions__button"
            hover-class="pill-btn--primary-hover"
            size="mini"
            bindtap="handleSubmitAllocations"
          >ç¡®å®š</button>
        </view>
        <block
          wx:if="{{profile.attributes && profile.attributes.combatStats && profile.attributes.combatStats.length}}"
        >
          <view class="subsection-title">æˆ˜æ–—å±æ€§</view>
          <view class="combat-grid">
            <view class="combat-item" wx:for="{{profile.attributes.combatStats}}" wx:key="key">
              <view class="combat-label">{{item.label}}</view>
              <view class="combat-value">{{item.formattedValue}}</view>
            </view>
          </view>
        </block>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'storage'}}">
      <view class="section-card storage-section">
        <view class="section-header">
          <view class="section-title">çº³æˆ’å‚¨ç‰©</view>
        </view>
        <view wx:if="{{storageCategories.length}}" class="storage-tabs">
          <view
            wx:for="{{storageCategories}}"
            wx:key="key"
            class="storage-tab {{activeStorageCategory === item.key ? 'storage-tab--active' : ''}}"
            data-key="{{item.key}}"
            bindtap="handleStorageCategoryChange"
          >
            <text class="storage-tab__label">{{item.label}}</text>
          </view>
        </view>
        <block wx:if="{{activeStorageCategoryData}}">
          <view wx:if="{{storageMeta}}" class="storage-summary">
            <view class="storage-summary__line">
              <text>æ€»å®¹é‡ {{storageMeta.capacity}}</text>
              <text>å·²ç”¨ {{storageMeta.used}}</text>
            </view>
            <view class="storage-summary__line">
              <text>å‰©ä½™ {{storageMeta.remaining}}</text>
              <text wx:if="{{storageMeta.upgradeAvailable !== null}}">å‰©ä½™å‡çº§æ¬¡æ•° {{storageMeta.upgradeAvailable}}</text>
              <text wx:elif="{{storageMeta.upgradesRemaining !== null}}">å¯å‡çº§æ¬¡æ•° {{storageMeta.upgradesRemaining}}</text>
            </view>
            <progress
              class="storage-summary__progress"
              percent="{{storageMeta.usagePercent}}"
              stroke-width="6"
              backgroundColor="#1b2036"
              activeColor="#566ed2"
              show-info="{{false}}"
            ></progress>
            <view class="storage-summary__actions">
              <button
                class="pill-btn pill-btn--primary storage-summary__upgrade"
                hover-class="pill-btn--primary-hover"
                size="mini"
                loading="{{storageUpgrading}}"
                disabled="{{storageUpgrading}}"
                bindtap="handleUpgradeStorage"
              >å‡çº§å‚¨ç‰©ç©ºé—´</button>
              <text class="storage-summary__hint" wx:if="{{storageMeta.nextCapacity}}">ä¸‹æ¬¡å‡çº§å®¹é‡ {{storageMeta.nextCapacity}}</text>
            </view>
          </view>
          <view wx:else class="storage-summary">
            <view class="storage-summary__line">
              <text>å·²ç”¨ {{activeStorageCategoryData.items.length}} / {{activeStorageCategoryData.capacity}}</text>
              <text>å‰©ä½™ {{activeStorageCategoryData.remaining}}</text>
            </view>
            <progress
              class="storage-summary__progress"
              percent="{{activeStorageCategoryData.usagePercent}}"
              stroke-width="6"
              backgroundColor="#1b2036"
              activeColor="#566ed2"
              show-info="{{false}}"
            ></progress>
            <view class="storage-summary__actions">
              <button
                class="pill-btn pill-btn--primary storage-summary__upgrade"
                hover-class="pill-btn--primary-hover"
                size="mini"
                loading="{{storageUpgrading}}"
                disabled="{{storageUpgrading}}"
                bindtap="handleUpgradeStorage"
              >å‡çº§å‚¨ç‰©ç©ºé—´</button>
              <text class="storage-summary__hint">ä¸‹æ¬¡å‡çº§å®¹é‡ {{activeStorageCategoryData.nextCapacity}}</text>
            </view>
          </view>
          <view class="storage-grid">
            <block wx:for="{{activeStorageCategoryData.slots}}" wx:for-index="slotIndex" wx:key="storageKey">
              <view wx:if="{{!item.placeholder}}" class="storage-slot {{item.iconUrl ? 'storage-slot--has-icon' : ''}}">
                <view wx:if="{{!item.iconUrl}}" class="storage-slot__badge">{{item.slotLabel}}</view>
                <view
                  class="storage-slot__frame {{item.iconUrl ? 'storage-slot__frame--icon' : ''}}"
                  hover-class="storage-slot__frame--hover"
                  bindtap="handleEquipmentTap"
                  bindlongpress="handleEquipmentLongPress"
                  data-source="storage"
                  data-slot="{{item.slot}}"
                  data-slot-label="{{item.slotLabel}}"
                  data-item="{{item}}"
                  data-inventory-id="{{item.inventoryId || ''}}"
                  data-category="{{item.storageCategory || activeStorageCategory}}"
                >
                  <view wx:if="{{item.recommendedUpgrade}}" class="storage-slot__recommend">
                    <text class="storage-slot__recommend-icon">â†‘</text>
                  </view>
                  <view wx:if="{{item.showNewBadge}}" class="storage-slot__flag">æ–°</view>
                  <view
                    class="storage-slot__icon {{item.iconUrl ? 'storage-slot__icon--image' : ''}}"
                    style="{{item.iconUrl ? '' : 'border-color: ' + item.qualityColor + ';'}}"
                  >
                    <block wx:if="{{item.iconUrl}}">
                      <image
                        class="storage-slot__icon-image"
                        src="{{item.iconUrl}}"
                        mode="aspectFill"
                        data-context="storage"
                        data-index="{{slotIndex}}"
                        data-category-index="{{activeStorageCategoryIndex}}"
                        data-fallback="{{item.iconFallbackUrl}}"
                        binderror="handleEquipmentIconError"
                      />
                    </block>
                    <view wx:else class="storage-slot__name storage-slot__name--placeholder">
                      {{item.shortName || item.name}}
                    </view>
                  </view>
                </view>
              </view>
              <view wx:else class="storage-slot storage-slot--empty">
                <view class="storage-slot__frame storage-slot__frame--empty">
                  <view class="storage-slot__placeholder">ç©º</view>
                </view>
              </view>
            </block>
          </view>
        </block>
        <view wx:else class="empty-tip storage-empty">æš‚æ— å‚¨ç‰©æ•°æ®</view>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'equipment'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">è£…å¤‡æ€»è§ˆ</view>
        </view>
        <view class="slot-grid">
          <view
            class="slot-card {{item.item ? 'slot-card--filled' : 'slot-card--empty'}}"
            wx:for="{{(profile.equipment && profile.equipment.slots) || []}}"
            wx:for-index="slotIndex"
            wx:key="slot"
          >
            <view class="slot-card__header">
              <text class="slot-card__slot">{{item.slotLabel}}</text>
            </view>
            <view
              class="slot-card__icon"
              style="border-color: {{item.item ? item.item.qualityColor : 'rgba(86, 110, 210, 0.48)'}};"
              bindtap="handleEquipmentTap"
              data-source="slot"
              data-slot="{{item.slot}}"
              data-slot-label="{{item.slotLabel}}"
              data-item="{{item.item}}"
            >
              <block wx:if="{{item.item}}">
                <block wx:if="{{item.item.iconUrl}}">
                  <image
                    class="slot-card__icon-image"
                    src="{{item.item.iconUrl}}"
                    mode="aspectFill"
                    data-context="slot"
                    data-index="{{slotIndex}}"
                    data-fallback="{{item.item.iconFallbackUrl}}"
                    binderror="handleEquipmentIconError"
                  />
                </block>
                <view wx:else class="slot-card__icon-label">{{item.item.shortName || item.item.name}}</view>
              </block>
              <view wx:else class="slot-card__icon-placeholder">æœªè£…å¤‡</view>
            </view>
          </view>
        </view>
        <view wx:if="{{profile.equipment && profile.equipment.bonus && profile.equipment.bonus.sets && profile.equipment.bonus.sets.length}}" class="equipment-summary">
          <view class="summary-title">å·²æ¿€æ´»å¥—è£…</view>
          <view
            class="set-item"
            wx:for="{{profile.equipment.bonus.sets}}"
            wx:key="setId"
          >
            <view class="set-head">
              <text class="set-name">{{item.name}}</text>
              <text class="set-count">{{item.count}} ä»¶</text>
            </view>
            <view class="set-effect" wx:for="{{item.effects || []}}" wx:key="pieces">
              {{item.pieces}} ä»¶ï¼š{{item.description}}
            </view>
          </view>
        </view>
        <view wx:if="{{profile.equipment && profile.equipment.bonus && profile.equipment.bonus.notes && profile.equipment.bonus.notes.length}}" class="equipment-summary">
          <view class="summary-title">è£…å¤‡ç‰¹æ€§</view>
          <view class="note-item" wx:for="{{profile.equipment.bonus.notes}}" wx:key="index">{{item}}</view>
        </view>
        <view class="inventory-title">èƒŒåŒ…è£…å¤‡</view>
        <view
          wx:if="{{!(profile.equipment && profile.equipment.inventory && profile.equipment.inventory.length)}}"
          class="empty-tip inventory-empty"
        >æš‚æœªè·å¾—é¢å¤–è£…å¤‡</view>
        <view class="inventory-grid">
          <view
            class="inventory-card {{item.equipped ? 'inventory-card--equipped' : ''}}"
            wx:for="{{(profile.equipment && profile.equipment.inventory) || []}}"
            wx:for-index="inventoryIndex"
            wx:key="inventoryId"
          >
            <view wx:if="{{!item.iconUrl}}" class="inventory-card__badge">{{item.slotLabel}}</view>
            <view class="inventory-card__frame">
              <view
                class="inventory-card__icon"
                style="border-color: {{item.qualityColor}};"
                bindtap="handleEquipmentTap"
                bindlongpress="handleEquipmentLongPress"
                data-source="inventory"
                data-slot="{{item.slot}}"
                data-item="{{item}}"
                data-inventory-id="{{item.inventoryId || ''}}"
                data-slot-label="{{item.slotLabel || ''}}"
                data-category="{{item.storageCategory || 'equipment'}}"
              >
                <block wx:if="{{item.iconUrl}}">
                  <image
                    class="inventory-card__icon-image"
                    src="{{item.iconUrl}}"
                    mode="aspectFill"
                    data-context="inventory"
                    data-index="{{inventoryIndex}}"
                    data-fallback="{{item.iconFallbackUrl}}"
                    binderror="handleEquipmentIconError"
                  />
                </block>
                <view wx:else class="inventory-card__icon-label">{{item.shortName || item.name}}</view>
                <view wx:if="{{item.equipped}}" class="inventory-card__status">å·²è£…å¤‡</view>
              </view>
            </view>
          </view>
        </view>
        <view class="inventory-footer" bindtap="handleOpenStones" hover-class="inventory-footer--hover">
          <view class="inventory-footer__info">
            <text class="inventory-footer__icon">ğŸª™</text>
            <text class="inventory-footer__amount">{{formattedStoneBalance}}</text>
          </view>
          <view class="inventory-footer__label">çµçŸ³ä»“åº“</view>
        </view>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'skill'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">æŠ€èƒ½ä¸æŠ½å¡</view>
          <view class="section-actions">
            <text class="section-actions__meta">å‰©ä½™æ¬¡æ•°ï¼š{{skillDrawCredits}}</text>
            <button
              class="action-btn action-btn--primary"
              hover-class="action-btn--primary-hover"
              size="mini"
              loading="{{drawing}}"
              disabled="{{drawing || skillDrawCredits <= 0}}"
              bindtap="handleDrawSkill"
            >æŠ½å–çµæŠ€</button>
          </view>
        </view>
        <view class="skill-slots">
          <view
            class="skill-slot-card {{item.detail ? '' : 'skill-slot-card--empty'}}"
            wx:for="{{(profile.skills && profile.skills.equipped) || []}}"
            wx:key="slot"
            wx:for-index="slotIndex"
          >
            <view class="skill-slot-card__header">
              <text class="slot-title">æ§½ä½ {{item.slot + 1}}</text>
              <button
                wx:if="{{item.detail}}"
                class="pill-btn pill-btn--ghost skill-slot-card__action"
                hover-class="pill-btn--hover"
                size="mini"
                data-slot="{{item.slot}}"
                catchtap="handleUnequipSkill"
              >å¸ä¸‹</button>
            </view>
            <view
              wx:if="{{item.detail}}"
              class="skill-slot-card__body"
              data-source="equipped"
              data-slot="{{item.slot}}"
              data-index="{{slotIndex}}"
              data-skill-id="{{item.detail.skillId}}"
              hover-class="skill-card--hover"
              bindtap="handleSkillCardTap"
            >
              <view class="skill-slot-card__name" style="color: {{item.detail.qualityColor}};">
                <text class="skill-slot-card__name-text">{{item.detail.name}}</text>
                <text class="skill-slot-card__level">Lv.{{item.detail.level}}</text>
              </view>
              <view class="skill-slot-card__tags">
                <text class="skill-tag">{{item.detail.qualityLabel}}</text>
                <text class="skill-tag">{{item.detail.typeLabel}}</text>
                <text class="skill-tag">{{item.detail.disciplineLabel}}</text>
                <text class="skill-tag">{{item.detail.elementLabel}}</text>
              </view>
              <view wx:if="{{item.detail.resourceText}}" class="skill-slot-card__meta">{{item.detail.resourceText}}</view>
              <view wx:if="{{item.detail.imprintText}}" class="skill-slot-card__meta">{{item.detail.imprintText}}</view>
              <view
                wx:if="{{item.detail.highlights && item.detail.highlights.length}}"
                class="skill-slot-card__highlights"
              >
                {{item.detail.highlights[0]}}
              </view>
            </view>
            <view wx:else class="slot-empty">æœªè£…å¤‡æŠ€èƒ½</view>
          </view>
        </view>
        <view class="inventory-title">æŠ€èƒ½èƒŒåŒ…</view>
        <view
          wx:if="{{!(profile.skills && profile.skills.inventory && profile.skills.inventory.length)}}"
          class="empty-tip inventory-empty"
        >æš‚æ— æŠ€èƒ½</view>
        <view
          wx:if="{{profile.skills && profile.skills.inventory && profile.skills.inventory.length}}"
          class="skill-grid"
        >
          <view
            class="skill-card"
            wx:for="{{(profile.skills && profile.skills.inventory) || []}}"
            wx:key="skillId"
            wx:for-index="inventoryIndex"
            data-source="inventory"
            data-index="{{inventoryIndex}}"
            data-skill-id="{{item.skillId}}"
            hover-class="skill-card--hover"
            bindtap="handleSkillCardTap"
          >
            <view wx:if="{{item.equipped}}" class="skill-card__badge">ä½¿ç”¨ä¸­</view>
            <view class="skill-card__header">
              <text class="skill-card__name" style="color: {{item.qualityColor}};">{{item.name}}</text>
              <text class="skill-card__level">Lv.{{item.level}}</text>
            </view>
            <view class="skill-card__tags">
              <text class="skill-tag">{{item.qualityLabel}}</text>
              <text class="skill-tag">{{item.typeLabel}}</text>
            </view>
            <view class="skill-card__tags skill-card__tags--secondary">
              <text class="skill-tag">{{item.disciplineLabel}}</text>
              <text class="skill-tag">{{item.elementLabel}}</text>
              <text wx:if="{{item.resourceText}}" class="skill-tag skill-tag--muted">{{item.resourceText}}</text>
            </view>
            <view wx:if="{{item.imprintText}}" class="skill-card__meta">{{item.imprintText}}</view>
            <view class="skill-card__footer">
              <button
                class="pill-btn pill-btn--primary"
                hover-class="pill-btn--primary-hover"
                size="mini"
                data-skill-id="{{item.skillId}}"
                catchtap="handleEquipSkill"
                disabled="{{item.equipped}}"
              >
                {{item.equipped ? 'ä½¿ç”¨ä¸­' : 'è£…å¤‡'}}
              </button>
              <text class="skill-card__time">è·å¾—äº {{item.obtainedAtText}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="section-card" wx:if="{{profile.skillHistory && profile.skillHistory.length}}">
        <view class="section-header">
          <view class="section-title">æŠ€èƒ½åŠ¨æ€</view>
        </view>
        <view class="history-item" wx:for="{{profile.skillHistory || []}}" wx:key="index">
          <view class="history-title">{{item.createdAtText}}</view>
          <view class="history-desc">{{item.summary}}</view>
        </view>
      </view>
      <view class="empty-card" wx:if="{{!(profile.skillHistory && profile.skillHistory.length)}}">
        <text class="empty-tip">æš‚æ— æŠ€èƒ½åŠ¨æ€</text>
      </view>
    </block>

    <block wx:else>
      <view class="empty-card">
        <text class="empty-tip">è¯·é€‰æ‹©ä¸Šæ–¹åˆ†ç±»</text>
      </view>
    </block>
  </scroll-view>

  <view wx:else class="empty-card">
    <text class="empty-tip">æš‚æœªè·å–åˆ°è§’è‰²ä¿¡æ¯</text>
  </view>

  <view wx:if="{{equipmentTooltip && equipmentTooltip.visible}}" class="equipment-tooltip">
    <view class="equipment-tooltip__mask" catchtouchmove="noop" bindtap="closeEquipmentTooltip"></view>
    <view class="equipment-tooltip__container">
      <view class="equipment-tooltip__card">
        <view class="equipment-tooltip__header">
          <text
            class="equipment-tooltip__name"
            style="color: {{equipmentTooltip.item.qualityColor}};"
        >{{equipmentTooltip.item.name}}</text>
        <text class="equipment-tooltip__quality">{{equipmentTooltip.item.qualityLabel}}</text>
      </view>
      <view class="equipment-tooltip__meta">
        <text wx:if="{{equipmentTooltip.slotLabel}}">æ§½ä½ï¼š{{equipmentTooltip.slotLabel}}</text>
        <text wx:if="{{equipmentTooltip.item.refineLabel}}">{{equipmentTooltip.item.refineLabel}}</text>
        <text wx:elif="{{equipmentTooltip.item.refine != null}}">ç²¾ç‚¼ {{equipmentTooltip.item.refine}}</text>
        <text wx:if="{{equipmentTooltip.item.storageCategoryLabel}}">ç±»åˆ«ï¼š{{equipmentTooltip.item.storageCategoryLabel}}</text>
        <text wx:if="{{equipmentTooltip.item.obtainedAtText}}">è·å¾—äº {{equipmentTooltip.item.obtainedAtText}}</text>
      </view>
      <view
        class="equipment-tooltip__stats"
        wx:if="{{equipmentTooltip.item.statsText && equipmentTooltip.item.statsText.length}}"
      >
        <text wx:for="{{equipmentTooltip.item.statsText}}" wx:key="index">{{item}}</text>
      </view>
      <view
        class="equipment-tooltip__notes"
        wx:if="{{equipmentTooltip.item.notes && equipmentTooltip.item.notes.length}}"
      >
        <text wx:for="{{equipmentTooltip.item.notes}}" wx:key="index">{{item}}</text>
      </view>
      <view
        wx:if="{{equipmentTooltip.item.kind === 'storage' && equipmentTooltip.item.description}}"
        class="equipment-tooltip__description"
      >{{equipmentTooltip.item.description}}</view>
      <view
        wx:if="{{equipmentTooltip.item.kind === 'storage' && equipmentTooltip.mode !== 'delete' && equipmentTooltip.item.actions && equipmentTooltip.item.actions.length}}"
        class="equipment-tooltip__actions"
      >
        <button
          wx:for="{{equipmentTooltip.item.actions}}"
          wx:key="key"
          class="pill-btn pill-btn--primary equipment-tooltip__action-button"
          hover-class="pill-btn--primary-hover"
          size="mini"
          data-action="{{item.key}}"
          loading="{{equipmentTooltip.using && equipmentTooltip.pendingAction === item.key}}"
          disabled="{{equipmentTooltip.using}}"
          bindtap="handleStorageItemAction"
        >{{item.label}}</button>
      </view>
      <block wx:if="{{equipmentTooltip.mode !== 'delete' && equipmentTooltip.item.kind !== 'storage'}}">
        <button
          wx:if="{{equipmentTooltip.item.equipped}}"
          class="equipment-tooltip__equip pill-btn pill-btn--ghost"
          hover-class="pill-btn--hover"
          size="mini"
          data-slot="{{equipmentTooltip.slot || equipmentTooltip.item.slot}}"
          bindtap="handleUnequipFromTooltip"
        >å¸ä¸‹</button>
        <button
          wx:elif="{{equipmentTooltip.source === 'inventory' || equipmentTooltip.source === 'storage'}}"
          class="equipment-tooltip__equip pill-btn pill-btn--primary"
          hover-class="pill-btn--primary-hover"
          size="mini"
          bindtap="handleEquipFromTooltip"
        >è£…å¤‡</button>
      </block>
      <button
        wx:if="{{equipmentTooltip.mode === 'delete'}}"
        class="equipment-tooltip__equip pill-btn pill-btn--danger"
        hover-class="pill-btn--danger-hover"
        size="mini"
        loading="{{equipmentTooltip.deleting}}"
        disabled="{{!equipmentTooltip.canDelete || equipmentTooltip.deleting}}"
        bindtap="handleDeleteFromTooltip"
      >{{equipmentTooltip.canDelete ? 'åˆ é™¤ç‰©å“' : 'æ— æ³•åˆ é™¤'}}</button>
      <view
        wx:if="{{equipmentTooltip.mode === 'delete' && equipmentTooltip.deleteDisabledReason}}"
        class="equipment-tooltip__hint"
      >{{equipmentTooltip.deleteDisabledReason}}</view>
      </view>
      <view
        wx:if="{{equipmentTooltip.equippedItem}}"
        class="equipment-tooltip__card equipment-tooltip__card--secondary"
      >
        <view class="equipment-tooltip__compare-title">å½“å‰å·²ç©¿æˆ´</view>
        <view class="equipment-tooltip__header">
          <text
            class="equipment-tooltip__name"
            style="color: {{equipmentTooltip.equippedItem.qualityColor}};"
          >{{equipmentTooltip.equippedItem.name}}</text>
          <text class="equipment-tooltip__quality">{{equipmentTooltip.equippedItem.qualityLabel}}</text>
        </view>
        <view class="equipment-tooltip__meta">
          <text wx:if="{{equipmentTooltip.equippedItem.slotLabel}}">æ§½ä½ï¼š{{equipmentTooltip.equippedItem.slotLabel}}</text>
          <text wx:if="{{equipmentTooltip.equippedItem.refineLabel}}">{{equipmentTooltip.equippedItem.refineLabel}}</text>
          <text wx:elif="{{equipmentTooltip.equippedItem.refine != null}}">ç²¾ç‚¼ {{equipmentTooltip.equippedItem.refine}}</text>
        </view>
        <view
          class="equipment-tooltip__stats"
          wx:if="{{equipmentTooltip.equippedItem.statsText && equipmentTooltip.equippedItem.statsText.length}}"
        >
          <text wx:for="{{equipmentTooltip.equippedItem.statsText}}" wx:key="index">{{item}}</text>
        </view>
        <view
          class="equipment-tooltip__notes"
          wx:if="{{equipmentTooltip.equippedItem.notes && equipmentTooltip.equippedItem.notes.length}}"
        >
          <text wx:for="{{equipmentTooltip.equippedItem.notes}}" wx:key="index">{{item}}</text>
        </view>
      </view>
    </view>
  </view>
  <view wx:if="{{skillModal && skillModal.visible}}" class="skill-modal">
    <view class="skill-modal__mask" catchtouchmove="noop" bindtap="closeSkillModal"></view>
    <view class="skill-modal__card">
      <view class="skill-modal__header">
        <text
          class="skill-modal__title"
          style="color: {{skillModal.skill.qualityColor || '#f1f4ff'}};"
        >{{skillModal.skill.name}}</text>
        <text class="skill-modal__level">Lv.{{skillModal.skill.level}}</text>
      </view>
      <view class="skill-modal__tags">
        <text wx:if="{{skillModal.slotLabel}}" class="skill-tag">{{skillModal.slotLabel}}</text>
        <text wx:if="{{skillModal.skill.qualityLabel}}" class="skill-tag">{{skillModal.skill.qualityLabel}}</text>
        <text wx:if="{{skillModal.skill.typeLabel}}" class="skill-tag">{{skillModal.skill.typeLabel}}</text>
        <text wx:if="{{skillModal.skill.disciplineLabel}}" class="skill-tag">{{skillModal.skill.disciplineLabel}}</text>
        <text wx:if="{{skillModal.skill.elementLabel}}" class="skill-tag">{{skillModal.skill.elementLabel}}</text>
      </view>
      <view wx:if="{{skillModal.skill.resourceText}}" class="skill-modal__line">{{skillModal.skill.resourceText}}</view>
      <view wx:if="{{skillModal.skill.imprintText}}" class="skill-modal__line">{{skillModal.skill.imprintText}}</view>
      <view wx:if="{{skillModal.skill.description}}" class="skill-modal__desc">{{skillModal.skill.description}}</view>
      <view
        wx:if="{{skillModal.skill.highlights && skillModal.skill.highlights.length}}"
        class="skill-modal__highlights"
      >
        <text wx:for="{{skillModal.skill.highlights}}" wx:key="index">{{item}}</text>
      </view>
      <view
        wx:if="{{skillModal.skill.obtainedAtText}}"
        class="skill-modal__line skill-modal__line--muted"
      >è·å¾—äº {{skillModal.skill.obtainedAtText}}</view>
      <view class="skill-modal__actions">
        <button
          wx:if="{{skillModal.source === 'equipped' && skillModal.slot !== null}}"
          class="pill-btn pill-btn--ghost"
          hover-class="pill-btn--hover"
          size="mini"
          data-slot="{{skillModal.slot}}"
          catchtap="handleUnequipSkill"
        >å¸ä¸‹</button>
        <button
          wx:elif="{{!skillModal.skill.equipped}}"
          class="pill-btn pill-btn--primary"
          hover-class="pill-btn--primary-hover"
          size="mini"
          data-skill-id="{{skillModal.skill.skillId}}"
          catchtap="handleEquipSkill"
        >è£…å¤‡</button>
        <button
          wx:else
          class="pill-btn pill-btn--ghost"
          size="mini"
          disabled="true"
        >ä½¿ç”¨ä¸­</button>
        <button
          class="pill-btn pill-btn--ghost"
          hover-class="pill-btn--hover"
          size="mini"
          catchtap="closeSkillModal"
        >å…³é—­</button>
      </view>
    </view>
  </view>
</view>
