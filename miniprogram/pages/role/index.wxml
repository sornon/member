<custom-nav title="角色养成" theme="dark"></custom-nav>
<view class="page">
  <view class="tab-bar">
    <view
      class="tab-item {{activeTab === 'character' ? 'tab-item--active' : ''}}"
      data-tab="character"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >角色</view>
    <view
      class="tab-item {{activeTab === 'equipment' ? 'tab-item--active' : ''}}"
      data-tab="equipment"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >装备</view>
    <view
      class="tab-item {{activeTab === 'storage' ? 'tab-item--active' : ''}}"
      data-tab="storage"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >纳戒</view>
    <view
      class="tab-item {{activeTab === 'skill' ? 'tab-item--active' : ''}}"
      data-tab="skill"
      hover-class="tab-item--hover"
      bindtap="handleTabChange"
    >技能</view>
  </view>

  <view wx:if="{{loading}}" class="loading">灵气汇聚中...</view>
  <scroll-view wx:elif="{{profile}}" scroll-y="true" class="scroll-container">
    <block wx:if="{{activeTab === 'character'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">角色属性</view>
          <view
            class="section-actions"
            wx:if="{{profile.attributes && profile.attributes.attributePoints > 0}}"
          >
            <button
              class="action-btn action-btn--ghost"
              hover-class="action-btn--hover"
              size="mini"
              data-mode="single"
              bindtap="handleAllocate"
            >分配属性点</button>
            <button
              class="action-btn action-btn--primary"
              hover-class="action-btn--primary-hover"
              size="mini"
              data-mode="auto"
              bindtap="handleAllocate"
            >均衡分配</button>
          </view>
        </view>
        <view class="level-line">
          <view class="level-stack">
            <view class="level-name">
              {{profile.attributes ? profile.attributes.levelLabel : '--'}}
            </view>
            <view
              class="level-realm"
              wx:if="{{profile.attributes && profile.attributes.realmName}}"
            >
              所属境界：{{profile.attributes.realmName}}
            </view>
            <view
              class="level-next"
              wx:if="{{profile.attributes && profile.attributes.nextLevelLabel}}"
            >
              下一阶段：{{profile.attributes.nextLevelLabel}}
            </view>
          </view>
        </view>
        <view class="attr-grid">
          <view class="attr-item" wx:for="{{(profile.attributes && profile.attributes.attributeList) || []}}" wx:key="key">
            <view class="attr-label">{{item.label}}</view>
            <view class="attr-value">{{item.formattedValue}}</view>
            <view class="attr-detail">
              基础 {{item.formattedBase}} · 装备 {{item.formattedEquipment}}
              <text wx:if="{{item.formattedSkill}}"> · 技能 {{item.formattedSkill}}</text>
            </view>
          </view>
        </view>
        <view class="attr-extra">
          <text>战力 {{profile.attributes ? profile.attributes.combatPower : '--'}}</text>
          <text>剩余属性点 {{profile.attributes ? profile.attributes.attributePoints : 0}}</text>
        </view>
        <view class="attr-respec">
          <view class="attr-respec__info">
            <text>洗点次数 {{profile.attributes ? profile.attributes.respecAvailable : 0}}</text>
          </view>
          <button
            class="pill-btn pill-btn--ghost attr-respec__button"
            hover-class="pill-btn--hover"
            size="mini"
            loading="{{resetting}}"
            disabled="{{resetting || !(profile.attributes && profile.attributes.respecAvailable > 0)}}"
            bindtap="handleResetAttributes"
          >洗点</button>
        </view>
        <block
          wx:if="{{profile.attributes && profile.attributes.combatStats && profile.attributes.combatStats.length}}"
        >
          <view class="subsection-title">战斗属性映射</view>
          <view class="combat-grid">
            <view class="combat-item" wx:for="{{profile.attributes.combatStats}}" wx:key="key">
              <view class="combat-label">{{item.label}}</view>
              <view class="combat-value">{{item.formattedValue}}</view>
              <view class="combat-detail">
                基础 {{item.formattedBase}} · 装备 {{item.formattedEquipment}}
                <text wx:if="{{item.formattedSkill}}"> · 技能 {{item.formattedSkill}}</text>
                <text wx:if="{{item.formattedMultiplier}}"> · 加成 {{item.formattedMultiplier}}</text>
              </view>
            </view>
          </view>
        </block>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'storage'}}">
      <view class="section-card storage-section">
        <view class="section-header">
          <view class="section-title">纳戒储物</view>
        </view>
        <view wx:if="{{storageCategories.length}}" class="storage-tabs">
          <view
            wx:for="{{storageCategories}}"
            wx:key="key"
            class="storage-tab {{activeStorageCategory === item.key ? 'storage-tab--active' : ''}}"
            data-key="{{item.key}}"
            bindtap="handleStorageCategoryChange"
          >
            <text class="storage-tab__label">{{item.label}}</text>
          </view>
        </view>
        <block wx:if="{{activeStorageCategoryData}}">
          <view wx:if="{{storageMeta}}" class="storage-summary">
            <view class="storage-summary__line">
              <text>总容量 {{storageMeta.capacity}}</text>
              <text>已用 {{storageMeta.used}}</text>
            </view>
            <view class="storage-summary__line">
              <text>剩余 {{storageMeta.remaining}}</text>
              <text wx:if="{{storageMeta.upgradeAvailable !== null}}">剩余升级次数 {{storageMeta.upgradeAvailable}}</text>
              <text wx:elif="{{storageMeta.upgradesRemaining !== null}}">可升级次数 {{storageMeta.upgradesRemaining}}</text>
            </view>
            <progress
              class="storage-summary__progress"
              percent="{{storageMeta.usagePercent}}"
              stroke-width="6"
              backgroundColor="#1b2036"
              activeColor="#566ed2"
              show-info="{{false}}"
            ></progress>
            <view class="storage-summary__actions">
              <button
                class="pill-btn pill-btn--primary storage-summary__upgrade"
                hover-class="pill-btn--primary-hover"
                size="mini"
                loading="{{storageUpgrading}}"
                disabled="{{storageUpgrading}}"
                bindtap="handleUpgradeStorage"
              >升级储物空间</button>
              <text class="storage-summary__hint" wx:if="{{storageMeta.nextCapacity}}">下次升级容量 {{storageMeta.nextCapacity}}</text>
            </view>
          </view>
          <view wx:else class="storage-summary">
            <view class="storage-summary__line">
              <text>已用 {{activeStorageCategoryData.items.length}} / {{activeStorageCategoryData.capacity}}</text>
              <text>剩余 {{activeStorageCategoryData.remaining}}</text>
            </view>
            <progress
              class="storage-summary__progress"
              percent="{{activeStorageCategoryData.usagePercent}}"
              stroke-width="6"
              backgroundColor="#1b2036"
              activeColor="#566ed2"
              show-info="{{false}}"
            ></progress>
            <view class="storage-summary__actions">
              <button
                class="pill-btn pill-btn--primary storage-summary__upgrade"
                hover-class="pill-btn--primary-hover"
                size="mini"
                loading="{{storageUpgrading}}"
                disabled="{{storageUpgrading}}"
                bindtap="handleUpgradeStorage"
              >升级储物空间</button>
              <text class="storage-summary__hint">下次升级容量 {{activeStorageCategoryData.nextCapacity}}</text>
            </view>
          </view>
          <view class="storage-grid">
            <block wx:for="{{activeStorageCategoryData.slots}}" wx:key="storageKey">
              <view wx:if="{{!item.placeholder}}" class="storage-slot">
                <view class="storage-slot__badge">{{item.slotLabel}}</view>
                <view
                  class="storage-slot__frame"
                  hover-class="storage-slot__frame--hover"
                  bindtap="handleEquipmentTap"
                  bindlongpress="handleEquipmentLongPress"
                  data-source="storage"
                  data-slot="{{item.slot}}"
                  data-slot-label="{{item.slotLabel}}"
                  data-item="{{item}}"
                  data-inventory-id="{{item.inventoryId || ''}}"
                  data-category="{{item.storageCategory || activeStorageCategory}}"
                >
                  <view class="storage-slot__icon" style="border-color: {{item.qualityColor}};">
                    <view class="storage-slot__name">{{item.shortName || item.name}}</view>
                  </view>
                </view>
              </view>
              <view wx:else class="storage-slot storage-slot--empty">
                <view class="storage-slot__frame storage-slot__frame--empty">
                  <view class="storage-slot__placeholder">空</view>
                </view>
              </view>
            </block>
          </view>
        </block>
        <view wx:else class="empty-tip storage-empty">暂无储物数据</view>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'equipment'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">装备总览</view>
        </view>
        <view class="slot-grid">
          <view
            class="slot-card {{item.item ? 'slot-card--filled' : 'slot-card--empty'}}"
            wx:for="{{(profile.equipment && profile.equipment.slots) || []}}"
            wx:key="slot"
          >
            <view class="slot-card__header">
              <text class="slot-card__slot">{{item.slotLabel}}</text>
            </view>
            <view
              class="slot-card__icon"
              style="border-color: {{item.item ? item.item.qualityColor : 'rgba(86, 110, 210, 0.48)'}};"
              bindtap="handleEquipmentTap"
              data-source="slot"
              data-slot="{{item.slot}}"
              data-slot-label="{{item.slotLabel}}"
              data-item="{{item.item}}"
            >
              <view class="slot-card__icon-name">
                {{item.item ? (item.item.shortName || item.item.name) : '未装备'}}
              </view>
            </view>
          </view>
        </view>
        <view wx:if="{{profile.equipment && profile.equipment.bonus && profile.equipment.bonus.sets && profile.equipment.bonus.sets.length}}" class="equipment-summary">
          <view class="summary-title">已激活套装</view>
          <view
            class="set-item"
            wx:for="{{profile.equipment.bonus.sets}}"
            wx:key="setId"
          >
            <view class="set-head">
              <text class="set-name">{{item.name}}</text>
              <text class="set-count">{{item.count}} 件</text>
            </view>
            <view class="set-effect" wx:for="{{item.effects || []}}" wx:key="pieces">
              {{item.pieces}} 件：{{item.description}}
            </view>
          </view>
        </view>
        <view wx:if="{{profile.equipment && profile.equipment.bonus && profile.equipment.bonus.notes && profile.equipment.bonus.notes.length}}" class="equipment-summary">
          <view class="summary-title">装备特性</view>
          <view class="note-item" wx:for="{{profile.equipment.bonus.notes}}" wx:key="index">{{item}}</view>
        </view>
        <view class="inventory-title">背包装备</view>
        <view
          wx:if="{{!(profile.equipment && profile.equipment.inventory && profile.equipment.inventory.length)}}"
          class="empty-tip inventory-empty"
        >暂未获得额外装备</view>
        <view class="inventory-grid">
          <view
            class="inventory-card {{item.equipped ? 'inventory-card--equipped' : ''}}"
            wx:for="{{(profile.equipment && profile.equipment.inventory) || []}}"
            wx:key="inventoryId"
          >
            <view class="inventory-card__badge">{{item.slotLabel}}</view>
            <view class="inventory-card__frame">
              <view
                class="inventory-card__icon"
                style="border-color: {{item.qualityColor}};"
                bindtap="handleEquipmentTap"
                bindlongpress="handleEquipmentLongPress"
                data-source="inventory"
                data-slot="{{item.slot}}"
                data-item="{{item}}"
                data-inventory-id="{{item.inventoryId || ''}}"
                data-slot-label="{{item.slotLabel || ''}}"
                data-category="{{item.storageCategory || 'equipment'}}"
              >
                <view class="inventory-card__icon-name">{{item.shortName || item.name}}</view>
                <view wx:if="{{item.equipped}}" class="inventory-card__status">已装备</view>
              </view>
            </view>
          </view>
        </view>
        <view class="inventory-footer" bindtap="handleOpenStones" hover-class="inventory-footer--hover">
          <view class="inventory-footer__info">
            <text class="inventory-footer__icon">🪙</text>
            <text class="inventory-footer__amount">{{formattedStoneBalance}}</text>
          </view>
          <view class="inventory-footer__label">灵石仓库</view>
        </view>
      </view>
    </block>

    <block wx:elif="{{activeTab === 'skill'}}">
      <view class="section-card">
        <view class="section-header">
          <view class="section-title">技能与抽卡</view>
          <view class="section-actions">
            <button
              class="action-btn action-btn--primary"
              hover-class="action-btn--primary-hover"
              size="mini"
              loading="{{drawing}}"
              bindtap="handleDrawSkill"
            >抽取灵技</button>
          </view>
        </view>
        <view class="skill-slots">
          <view class="skill-slot" wx:for="{{(profile.skills && profile.skills.equipped) || []}}" wx:key="slot">
            <view class="slot-index">槽位 {{item.slot + 1}}</view>
            <view wx:if="{{item.detail}}" class="skill-detail">
              <view class="skill-name" style="color: {{item.detail.rarityColor}};">{{item.detail.name}} Lv.{{item.detail.level}}</view>
              <view class="skill-effects">
                <text wx:for="{{item.detail.effectsSummary || []}}" wx:key="index">{{effect}}</text>
              </view>
              <button
                class="pill-btn pill-btn--ghost"
                hover-class="pill-btn--hover"
                size="mini"
                data-slot="{{item.slot}}"
                bindtap="handleUnequipSkill"
              >卸下</button>
            </view>
            <view wx:else class="slot-empty">未装备技能</view>
          </view>
        </view>
        <view class="inventory-title">技能背包</view>
        <view
          wx:if="{{!(profile.skills && profile.skills.inventory && profile.skills.inventory.length)}}"
          class="empty-tip inventory-empty"
        >暂无技能</view>
        <view class="skill-item" wx:for="{{(profile.skills && profile.skills.inventory) || []}}" wx:key="skillId">
          <view class="skill-header">
            <view class="skill-name" style="color: {{item.rarityColor}};">{{item.name}} Lv.{{item.level}}</view>
            <view class="skill-meta">{{item.rarityLabel}}</view>
          </view>
          <view class="skill-desc">{{item.description}}</view>
          <view class="skill-effects">
            <text wx:for="{{item.effectsSummary || []}}" wx:key="index">{{effect}}</text>
          </view>
          <view class="skill-actions">
            <button
              class="pill-btn pill-btn--primary"
              hover-class="pill-btn--primary-hover"
              size="mini"
              data-skill-id="{{item.skillId}}"
              bindtap="handleEquipSkill"
              disabled="{{item.equipped}}"
            >
              {{item.equipped ? '使用中' : '装备'}}
            </button>
            <view class="skill-time">获得于 {{item.obtainedAtText}}</view>
          </view>
        </view>
      </view>

      <view class="section-card" wx:if="{{profile.skillHistory && profile.skillHistory.length}}">
        <view class="section-header">
          <view class="section-title">技能动态</view>
        </view>
        <view class="history-item" wx:for="{{profile.skillHistory || []}}" wx:key="index">
          <view class="history-title">{{item.createdAtText}}</view>
          <view class="history-desc">{{item.summary}}</view>
        </view>
      </view>
      <view class="empty-card" wx:if="{{!(profile.skillHistory && profile.skillHistory.length)}}">
        <text class="empty-tip">暂无技能动态</text>
      </view>
    </block>

    <block wx:else>
      <view class="empty-card">
        <text class="empty-tip">请选择上方分类</text>
      </view>
    </block>
  </scroll-view>

  <view wx:else class="empty-card">
    <text class="empty-tip">暂未获取到角色信息</text>
  </view>

  <view wx:if="{{equipmentTooltip && equipmentTooltip.visible}}" class="equipment-tooltip">
    <view class="equipment-tooltip__mask" catchtouchmove="noop" bindtap="closeEquipmentTooltip"></view>
    <view class="equipment-tooltip__card">
      <view class="equipment-tooltip__header">
        <text
          class="equipment-tooltip__name"
          style="color: {{equipmentTooltip.item.qualityColor}};"
        >{{equipmentTooltip.item.name}}</text>
        <text class="equipment-tooltip__quality">{{equipmentTooltip.item.qualityLabel}}</text>
      </view>
      <view class="equipment-tooltip__meta">
        <text wx:if="{{equipmentTooltip.slotLabel}}">槽位：{{equipmentTooltip.slotLabel}}</text>
        <text wx:if="{{equipmentTooltip.item.refineLabel}}">{{equipmentTooltip.item.refineLabel}}</text>
        <text wx:elif="{{equipmentTooltip.item.refine != null}}">精炼 {{equipmentTooltip.item.refine}}</text>
      </view>
      <view
        class="equipment-tooltip__stats"
        wx:if="{{equipmentTooltip.item.statsText && equipmentTooltip.item.statsText.length}}"
      >
        <text wx:for="{{equipmentTooltip.item.statsText}}" wx:key="index">{{item}}</text>
      </view>
      <view
        class="equipment-tooltip__notes"
        wx:if="{{equipmentTooltip.item.notes && equipmentTooltip.item.notes.length}}"
      >
        <text wx:for="{{equipmentTooltip.item.notes}}" wx:key="index">{{item}}</text>
      </view>
      <button
        wx:if="{{equipmentTooltip.mode !== 'delete' && equipmentTooltip.item.equipped}}"
        class="equipment-tooltip__equip pill-btn pill-btn--ghost"
        hover-class="pill-btn--hover"
        size="mini"
        data-slot="{{equipmentTooltip.slot || equipmentTooltip.item.slot}}"
        bindtap="handleUnequipFromTooltip"
      >卸下</button>
      <button
        wx:elif="{{equipmentTooltip.mode !== 'delete' && equipmentTooltip.source === 'inventory'}}"
        class="equipment-tooltip__equip pill-btn pill-btn--primary"
        hover-class="pill-btn--primary-hover"
        size="mini"
        bindtap="handleEquipFromTooltip"
      >装备</button>
      <button
        wx:elif="{{equipmentTooltip.mode === 'delete'}}"
        class="equipment-tooltip__equip pill-btn pill-btn--danger"
        hover-class="pill-btn--danger-hover"
        size="mini"
        loading="{{equipmentTooltip.deleting}}"
        disabled="{{!equipmentTooltip.canDelete || equipmentTooltip.deleting}}"
        bindtap="handleDeleteFromTooltip"
      >{{equipmentTooltip.canDelete ? '删除物品' : '无法删除'}}</button>
      <view
        wx:if="{{equipmentTooltip.mode === 'delete' && equipmentTooltip.deleteDisabledReason}}"
        class="equipment-tooltip__hint"
      >{{equipmentTooltip.deleteDisabledReason}}</view>
    </view>
  </view>
</view>
