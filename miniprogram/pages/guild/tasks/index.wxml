<view class="tasks-page">
  <view wx:if="{{loading}}" class="state">宗门任务加载中...</view>
  <view wx:elif="{{error}}" class="state state--error">{{error}}</view>
  <scroll-view wx:else scroll-y class="tasks-scroll" enable-flex="true">
    <view wx:if="{{guild}}" class="tasks-header">
      <view class="tasks-header__title">{{guild.name || '未命名宗门'}}</view>
      <view class="tasks-header__meta">职位：{{membership ? membership.role : '成员'}}</view>
    </view>

    <view class="tasks-list">
      <view wx:if="{{tasks.length === 0}}" class="empty">暂无宗门任务，敬请期待</view>
      <block wx:else wx:for="{{tasks}}" wx:key="id">
        <view class="task-card">
          <view class="task-card__header">
            <view class="task-card__title">{{item.title || '未命名任务'}}</view>
            <view class="task-card__status {{item.status}}">{{item.statusLabel}}</view>
          </view>
          <view wx:if="{{item.description}}" class="task-card__desc">{{item.description}}</view>
          <view class="task-card__progress">
            <view class="task-card__progress-bar">
              <view class="task-card__progress-inner" style="width: {{item.progressPercent}}%;"></view>
            </view>
            <view class="task-card__progress-text">{{item.progressCurrent}} / {{item.progressTarget}}</view>
          </view>
          <view class="task-card__meta">
            <text wx:if="{{item.startAtText}}">开始 {{item.startAtText}}</text>
            <text wx:if="{{item.endAtText}}">结束 {{item.endAtText}}</text>
          </view>
          <view wx:if="{{item.rewardText}}" class="task-card__reward">奖励：{{item.rewardText}}</view>
          <button
            class="btn btn--primary"
            size="mini"
            data-id="{{item.taskId || item.id}}"
            bindtap="handleClaimTask"
            disabled="{{!item.claimable || item.claimed || claimingTaskId === (item.taskId || item.id)}}"
            loading="{{claimingTaskId === (item.taskId || item.id)}}"
          >领取奖励</button>
        </view>
      </block>
    </view>
  </scroll-view>
</view>
