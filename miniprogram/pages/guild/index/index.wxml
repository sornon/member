<custom-nav title="å®—é—¨å¤§å…" theme="dark"></custom-nav>
<view class="guild-page">
  <scroll-view scroll-y class="guild-scroll" enable-flex="true">
    <block wx:if="{{loading}}">
      <view class="state state--loading">å®—é—¨æƒ…æŠ¥è½½å…¥ä¸­...</view>
    </block>
    <block wx:elif="{{error}}">
      <view class="state state--error">{{error}}</view>
    </block>
    <view wx:else class="guild-content">
      <view wx:if="{{guild}}" class="card guild-card">
        <view class="guild-card__header">
          <view class="guild-avatar">
            <image
              wx:if="{{guild.icon}}"
              class="guild-avatar__image"
              src="{{guild.icon}}"
              mode="aspectFill"
            ></image>
            <text wx:else class="guild-avatar__placeholder">ğŸ¯</text>
          </view>
          <view class="guild-card__info">
            <view class="guild-card__title">{{guild.name || 'æœªå‘½åå®—é—¨'}}</view>
            <view class="guild-card__meta">èŒä½ï¼š{{membershipRoleLabel}}</view>
            <view class="guild-card__stats">
              <text>æˆå‘˜ {{guild.memberCountText || guild.memberCount || 0}}{{guild.memberCapacityText ? '/' + guild.memberCapacityText : ''}}</text>
              <text>æˆ˜åŠ› {{guild.powerText || guild.power || 0}}</text>
            </view>
          </view>
          <view class="guild-card__actions">
            <button
              class="btn btn--primary"
              size="mini"
              disabled="{{!teamBattleEnabled}}"
              bindtap="handleTeamBattle"
            >å›¢é˜Ÿè®¨ä¼</button>
            <button
              class="btn btn--ghost"
              size="mini"
              bindtap="handleQuickDonate"
              loading="{{donating}}"
              disabled="{{donating}}"
            >ä¸€é”®æçŒ®</button>
          </view>
        </view>
        <view class="guild-notice">
          <view class="guild-notice__title">å®—é—¨å…¬å‘Š</view>
          <view class="guild-notice__content">{{guild.manifesto || 'æš‚æ— å®—é—¨å…¬å‘Š'}}</view>
        </view>
        <view class="guild-card__metrics">
          <view class="metric">
            <text class="metric__label">å®—é—¨ç­‰çº§</text>
            <text class="metric__value">Lv. {{guild.level || 1}}</text>
          </view>
          <view class="metric">
            <text class="metric__label">å®—é—¨è´¡çŒ®</text>
            <text class="metric__value">{{guild.contributionText || '0'}}</text>
          </view>
          <view class="metric" wx:if="{{membership}}">
            <text class="metric__label">æˆ‘çš„è´¡çŒ®</text>
            <text class="metric__value">{{formatNumber(membership.contributionTotal || membership.contribution || 0)}}</text>
          </view>
        </view>
        <view class="guild-shortcuts">
          <view
            class="shortcut"
            bindtap="handleNavigate"
            data-url="/pages/guild/members/index"
            data-require-guild="true"
          >
            <text class="shortcut__icon">ğŸ‘¥</text>
            <text class="shortcut__label">æˆå‘˜ç®¡ç†</text>
          </view>
          <view
            class="shortcut"
            bindtap="handleNavigate"
            data-url="/pages/guild/tasks/index"
            data-require-guild="true"
          >
            <text class="shortcut__icon">ğŸ—’ï¸</text>
            <text class="shortcut__label">å®—é—¨ä»»åŠ¡</text>
          </view>
          <view
            class="shortcut"
            bindtap="handleNavigate"
            data-url="/pages/guild/boss/index"
            data-require-guild="true"
          >
            <text class="shortcut__icon">ğŸ‰</text>
            <text class="shortcut__label">Boss è®¨ä¼</text>
          </view>
          <view
            class="shortcut"
            bindtap="handleNavigate"
            data-url="/pages/guild/logs/index"
            data-require-guild="true"
          >
            <text class="shortcut__icon">ğŸ“œ</text>
            <text class="shortcut__label">å®—é—¨æ—¥å¿—</text>
          </view>
          <view
            class="shortcut"
            bindtap="handleNavigate"
            data-url="/pages/guild/attributes/index"
            data-require-guild="true"
          >
            <text class="shortcut__icon">âœ¨</text>
            <text class="shortcut__label">å®—é—¨å±æ€§</text>
          </view>
        </view>
      </view>

      <view wx:else class="card guild-empty">
        <text class="guild-empty__title">å°šæœªåŠ å…¥å®—é—¨</text>
        <text class="guild-empty__desc">åˆ›å»ºæˆ–åŠ å…¥å®—é—¨ï¼Œè§£é”å›¢é˜Ÿè®¨ä¼ã€å®—é—¨ä»»åŠ¡ç­‰é«˜çº§ç©æ³•ã€‚</text>
        <button class="btn btn--primary" bindtap="handleCreateGuild">åˆ›å»ºå®—é—¨</button>
      </view>

      <view class="card guild-list">
        <view class="section-header">
          <view class="section-header__title">å…¨éƒ¨å®—é—¨</view>
          <button
            class="btn btn--link"
            size="mini"
            bindtap="loadGuildList"
            loading="{{guildListLoading}}"
            disabled="{{guildListLoading}}"
          >åˆ·æ–°</button>
        </view>
        <block wx:if="{{guildListLoading}}">
          <view class="empty">å®—é—¨åˆ—è¡¨åŠ è½½ä¸­...</view>
        </block>
        <block wx:elif="{{guildListError}}">
          <view class="empty">{{guildListError}}</view>
        </block>
        <block wx:elif="{{guildList.length === 0}}">
          <view class="empty">æš‚æ— å®—é—¨ï¼Œå¿«å»åˆ›å»ºå§</view>
        </block>
        <block wx:else>
          <block wx:for="{{guildList}}" wx:key="id">
            <view class="guild-list__item">
              <view class="guild-list__avatar">
                <image
                  wx:if="{{item.hasCustomAvatar}}"
                  class="guild-list__avatar-image"
                  src="{{item.avatarUrl}}"
                  mode="cover"
                ></image>
                <text wx:else class="guild-list__avatar-placeholder">ğŸ¯</text>
                <image
                  wx:if="{{item.avatarFrame}}"
                  class="guild-list__avatar-frame"
                  src="{{item.avatarFrame}}"
                  mode="scaleToFill"
                ></image>
              </view>
              <view class="guild-list__body">
                <view class="guild-list__title">{{item.name}}</view>
                <view class="guild-list__meta">
                  <text>ç­‰çº§ Lv.{{item.level || 1}}</text>
                  <text>è´¡çŒ® {{item.contributionText || formatNumber(item.contribution || item.contributionTotal || 0)}}</text>
                </view>
                <view class="guild-list__meta">
                  <text>æˆå‘˜ {{item.memberCountText || item.memberCount || 0}}{{item.memberCapacityText ? '/' + item.memberCapacityText : ''}}</text>
                  <text>æˆ˜åŠ› {{item.powerText || item.power || 0}}</text>
                </view>
                <view class="guild-list__manifesto">{{item.manifesto || 'æš‚æœªå¡«å†™å®—é—¨å®£è¨€ã€‚'}}</view>
              </view>
              <button
                class="btn btn--link"
                size="mini"
                data-id="{{item.id}}"
                bindtap="handleViewGuild"
              >æŸ¥çœ‹</button>
            </view>
          </block>
        </block>
      </view>

      <view class="card guild-leaderboard">
        <view class="section-header">
          <view class="section-header__title">å®—é—¨æ’è¡Œæ¦œ</view>
        </view>
        <block wx:if="{{leaderboard.length === 0}}">
          <view class="empty">æš‚æ— æ’è¡Œæ•°æ®</view>
        </block>
          <block wx:else>
            <block wx:for="{{leaderboard}}" wx:key="id">
              <view class="leaderboard-item">
                <view class="leaderboard-rank">{{index + 1}}</view>
                <view class="leaderboard-avatar">
                  <image
                    wx:if="{{item.hasCustomAvatar}}"
                    class="leaderboard-avatar__image"
                    src="{{item.avatarUrl}}"
                    mode="cover"
                  ></image>
                  <text wx:else class="leaderboard-avatar__placeholder">ğŸ¯</text>
                  <image
                    wx:if="{{item.avatarFrame}}"
                    class="leaderboard-avatar__frame"
                    src="{{item.avatarFrame}}"
                    mode="scaleToFill"
                ></image>
              </view>
              <view class="leaderboard-body">
                <view class="leaderboard-name">{{item.name}}</view>
                <view class="leaderboard-meta">æˆå‘˜ {{item.memberCountText || item.memberCount || 0}} Â· æˆ˜åŠ› {{item.powerText || item.power || 0}}</view>
                <view wx:if="{{item.titleImage || item.titleName}}" class="leaderboard-title">
                  <image
                    wx:if="{{item.titleImage}}"
                    class="leaderboard-title__image"
                    src="{{item.titleImage}}"
                    mode="heightFix"
                  ></image>
                  <text wx:if="{{item.titleName}}" class="leaderboard-title__text">{{item.titleName}}</text>
                </view>
              </view>
              <button
                class="btn btn--link"
                size="mini"
                data-id="{{item.id}}"
                bindtap="handleViewGuild"
              >è¯¦æƒ…</button>
            </view>
          </block>
        </block>
      </view>
    </view>
  </scroll-view>

  <view
    wx:if="{{donationDialogVisible}}"
    class="donation-dialog__mask"
    catchtouchmove="noop"
    bindtap="handleCloseDonationDialog"
  >
    <view class="donation-dialog" catchtap="noop">
      <view class="donation-dialog__header">
        <view>
          <view class="donation-dialog__title">ä¸€é”®æçŒ®</view>
          <view class="donation-dialog__subtitle">é€‰æ‹©åˆé€‚çš„çµçŸ³æ•°é‡ï¼ŒåŠ©åŠ›å®—é—¨å‘å±•</view>
        </view>
        <text class="donation-dialog__close" bindtap="handleCloseDonationDialog">Ã—</text>
      </view>
      <view class="donation-options">
        <view
          wx:for="{{donationOptions}}"
          wx:key="amount"
          class="donation-option {{donationSelectedAmount === item.amount ? 'donation-option--active' : ''}}"
          data-amount="{{item.amount}}"
          bindtap="handleSelectDonation"
        >
          <text class="donation-option__value">{{item.label}}</text>
          <text class="donation-option__hint">å¿«é€Ÿè´¡çŒ® Â· ç¨³æ­¥æå‡</text>
        </view>
      </view>
      <view class="donation-dialog__actions">
        <button class="btn btn--ghost" size="mini" bindtap="handleCloseDonationDialog">ç¨åå†æ</button>
        <button
          class="btn btn--primary"
          size="mini"
          loading="{{donating}}"
          disabled="{{donating}}"
          bindtap="handleConfirmDonation"
        >ç«‹å³æçŒ®</button>
      </view>
    </view>
  </view>
</view>
