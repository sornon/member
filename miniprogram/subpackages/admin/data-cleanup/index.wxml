<custom-nav title="数据清理" theme="dark"></custom-nav>
<view class="cleanup-page">
  <view class="intro-card">
    <view class="intro-title">清理删除会员遗留数据</view>
    <view class="intro-desc">该操作会扫描多项会员相关数据，移除已被删除会员遗留的记录，避免异常数据影响现有会员。</view>
    <view class="intro-note">操作仅针对无效成员记录，不会改动当前有效会员的数据。建议在非营业高峰时段执行。</view>
    <button
      class="cleanup-button primary"
      bindtap="handleScanTap"
      loading="{{loading && loadingAction === 'scan'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'scan' ? '扫描中…' : '扫描待清理数据'}}
    </button>
    <button
      wx:if="{{preview && preview.items.length}}"
      class="cleanup-button danger"
      bindtap="handleCleanupTap"
      loading="{{loading && loadingAction === 'cleanup'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'cleanup' ? '清理中…' : '确认清理'}}
    </button>
  </view>

  <view wx:if="{{preview}}" class="preview-card">
    <view class="preview-header">
      <view class="preview-title">扫描结果</view>
      <view wx:if="{{previewAt}}" class="preview-time">{{previewAt}}</view>
    </view>
    <view wx:if="{{preview.total > 0}}" class="preview-summary">发现 {{preview.total}} 条待清理记录</view>
    <view wx:else class="preview-summary muted">未发现待清理数据</view>
    <view wx:if="{{preview.items.length}}" class="preview-list">
      <view wx:for="{{preview.items}}" wx:key="key" class="preview-item">
        <view class="preview-name">
          <text class="preview-collection">{{item.collection}}</text>
          <text class="preview-label">{{item.label}}</text>
        </view>
        <view class="preview-field">索引字段：{{item.indexes}}</view>
        <view class="preview-desc">数据功能：{{item.description}}</view>
        <view class="preview-reason">清理原因：{{item.reason}}</view>
      </view>
    </view>
    <view wx:else class="preview-empty">未发现孤立数据，当前无需清理。</view>
  </view>

  <view wx:if="{{result}}" class="result-card">
    <view class="result-header">
      <view class="result-title">清理结果</view>
      <view wx:if="{{finishedAt}}" class="result-time">{{finishedAt}}</view>
    </view>
    <view class="result-summary">共清理 {{result.totalRemoved}} 条记录</view>
    <view class="result-members">当前有效会员：{{result.memberCount}} 人</view>
    <view wx:if="{{result.details.length}}" class="detail-list">
      <view wx:for="{{result.details}}" wx:key="key" class="detail-item">
        <view class="detail-name">{{item.label}}</view>
        <view class="detail-count">{{item.count}}</view>
      </view>
    </view>
    <view wx:else class="detail-empty">未发现需要清理的数据，系统状态良好。</view>
    <view wx:if="{{result.errors.length}}" class="error-block">
      <view class="error-title">部分数据未能成功清理：</view>
      <view wx:for="{{result.errors}}" wx:key="index" class="error-item">{{item}}</view>
    </view>
  </view>

  <view class="intro-card">
    <view class="intro-title">消费修为纠正</view>
    <view class="intro-desc">扫描历史消费产生的修为并集中回滚，确保只有充值行为能够提升修为。</view>
    <view class="intro-note">建议先执行扫描评估影响范围，确认后再进行回滚操作。</view>
    <button
      class="cleanup-button primary"
      bindtap="handleSpendScanTap"
      loading="{{loading && loadingAction === 'scanSpend'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'scanSpend' ? '扫描中…' : '扫描异常修为'}}
    </button>
    <button
      wx:if="{{spendPreview && spendPreview.members.length}}"
      class="cleanup-button danger"
      bindtap="handleSpendCleanupTap"
      loading="{{loading && loadingAction === 'cleanupSpend'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'cleanupSpend' ? '修正中…' : '执行修正'}}
    </button>
  </view>

  <view wx:if="{{spendPreview}}" class="preview-card">
    <view class="preview-header">
      <view class="preview-title">异常修为扫描结果</view>
      <view wx:if="{{spendPreviewAt}}" class="preview-time">{{spendPreviewAt}}</view>
    </view>
    <view wx:if="{{spendPreview.memberCount > 0}}" class="preview-summary">
      发现 {{spendPreview.memberCount}} 位会员，涉及 {{spendPreview.totalTransactions}} 笔交易，累计消费 {{spendPreview.totalAmountLabel}}，应回滚修为 {{spendPreview.totalExperienceLabel}}，预计实际回滚 {{spendPreview.totalExperienceDeductedLabel}}
    </view>
    <view wx:else class="preview-summary muted">未发现消费修为异常</view>
    <view wx:if="{{spendPreview.members.length}}" class="preview-list">
      <view wx:for="{{spendPreview.members}}" wx:key="memberId" class="preview-item">
        <view class="preview-name">
          <text class="preview-label">{{item.displayName}}</text>
          <text class="preview-collection">{{item.memberId}}</text>
        </view>
        <view class="preview-field">交易：{{item.transactionCount}} 笔 · 消费 {{item.totalAmountLabel}}</view>
        <view class="preview-field">回滚修为：{{item.experienceToRevertLabel}} · 预计实际回滚 {{item.experienceDeductedLabel}}</view>
        <view class="preview-field">当前修为：{{item.experienceBeforeLabel}} → 修正后 {{item.experienceAfterLabel}}</view>
        <view wx:if="{{item.lastTransactionAtLabel}}" class="preview-field">最近异常消费：{{item.lastTransactionAtLabel}}</view>
      </view>
    </view>
    <view wx:else class="preview-empty">暂无会员需要处理。</view>
  </view>

  <view wx:if="{{spendResult}}" class="result-card">
    <view class="result-header">
      <view class="result-title">消费修为修正结果</view>
      <view wx:if="{{spendFinishedAt}}" class="result-time">{{spendFinishedAt}}</view>
    </view>
    <view class="result-summary">实际回滚修为 {{spendResult.totalExperienceDeductedLabel}}，涉及 {{spendResult.memberCount}} 位会员，处理 {{spendResult.totalTransactions}} 笔交易</view>
    <view class="result-members">累计消费金额：{{spendResult.totalAmountLabel}}</view>
    <view wx:if="{{spendResult.members.length}}" class="preview-list">
      <view wx:for="{{spendResult.members}}" wx:key="memberId" class="preview-item">
        <view class="preview-name">
          <text class="preview-label">{{item.displayName}}</text>
          <text class="preview-collection">{{item.memberId}}</text>
        </view>
        <view class="preview-field">交易：{{item.transactionCount}} 笔 · 消费 {{item.totalAmountLabel}}</view>
        <view class="preview-field">应回滚：{{item.experienceToRevertLabel}} · 实际回滚 {{item.experienceDeductedLabel}}</view>
        <view class="preview-field">修为：{{item.experienceBeforeLabel}} → {{item.experienceAfterLabel}}</view>
        <view wx:if="{{item.lastTransactionAtLabel}}" class="preview-field">最近异常消费：{{item.lastTransactionAtLabel}}</view>
      </view>
    </view>
    <view wx:else class="detail-empty">未处理任何会员，可能已无异常修为。</view>
    <view wx:if="{{spendResult.errors.length}}" class="error-block">
      <view class="error-title">部分数据未能成功修正：</view>
      <view wx:for="{{spendResult.errors}}" wx:key="index" class="error-item">{{item}}</view>
    </view>
  </view>

  <view class="intro-card">
    <view class="intro-title">清理测试账号</view>
    <view class="intro-desc">扫描带有“测试”标签的账号，并在确认后批量删除账号及关联数据，便于定期清理体验版或开发版产生的记录。</view>
    <view class="intro-note">删除操作不可恢复，请确认这些测试账号不再需要保留。</view>
    <button
      class="cleanup-button primary"
      bindtap="handleTestScanTap"
      loading="{{loading && loadingAction === 'scanTest'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'scanTest' ? '扫描中…' : '扫描测试账号'}}
    </button>
    <button
      wx:if="{{testPreview && testPreview.memberCount > 0}}"
      class="cleanup-button danger"
      bindtap="handleTestCleanupTap"
      loading="{{loading && loadingAction === 'cleanupTest'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'cleanupTest' ? '清理中…' : '确认清理测试账号'}}
    </button>
  </view>

  <view wx:if="{{testPreview}}" class="preview-card">
    <view class="preview-header">
      <view class="preview-title">测试账号扫描结果</view>
      <view wx:if="{{testPreviewAt}}" class="preview-time">{{testPreviewAt}}</view>
    </view>
    <view wx:if="{{testPreview.memberCount > 0}}" class="preview-summary">
      发现 {{testPreview.memberCount}} 个测试账号，关联 {{testPreview.total}} 条数据
    </view>
    <view wx:else class="preview-summary muted">未发现需要处理的测试账号</view>
    <view wx:if="{{testPreview.items.length}}" class="preview-list">
      <view wx:for="{{testPreview.items}}" wx:key="key" class="preview-item">
        <view class="preview-name">
          <text class="preview-collection">{{item.collection}}</text>
          <text class="preview-label">{{item.label}}</text>
        </view>
        <view class="preview-field">索引字段：{{item.indexes}}</view>
        <view class="preview-desc">数据功能：{{item.description}}</view>
        <view class="preview-reason">清理原因：{{item.reason}}</view>
      </view>
    </view>
    <view wx:else class="preview-empty">未发现关联数据，当前无需清理。</view>
  </view>

  <view wx:if="{{testResult}}" class="result-card">
    <view class="result-header">
      <view class="result-title">测试账号清理结果</view>
      <view wx:if="{{testFinishedAt}}" class="result-time">{{testFinishedAt}}</view>
    </view>
    <view class="result-summary">共清理 {{testResult.totalRemoved}} 条测试账号相关数据</view>
    <view class="result-members">删除测试账号：{{testResult.memberCount}} 个</view>
    <view wx:if="{{testResult.details.length}}" class="detail-list">
      <view wx:for="{{testResult.details}}" wx:key="key" class="detail-item">
        <view class="detail-name">{{item.label}}</view>
        <view class="detail-count">{{item.count}}</view>
      </view>
    </view>
    <view wx:else class="detail-empty">未发现可清理的测试账号，系统保持整洁。</view>
    <view wx:if="{{testResult.errors.length}}" class="error-block">
      <view class="error-title">部分测试账号数据未能成功清理：</view>
      <view wx:for="{{testResult.errors}}" wx:key="index" class="error-item">{{item}}</view>
    </view>
  </view>

  <view class="intro-card">
    <view class="intro-title">清理战斗记录与衍生数据</view>
    <view class="intro-desc">该操作会扫描系统内所有 PVE / PVP 战斗产生的记录，包括战报、赛季档案与排行榜缓存，帮助在必要时重置战斗环境。</view>
    <view class="intro-note">清理动作将同步移除战斗相关的派生缓存。建议在停服或维护时执行，并确认不会影响现有运营数据。</view>
    <button
      class="cleanup-button primary"
      bindtap="handleBattleScanTap"
      loading="{{loading && loadingAction === 'scanBattle'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'scanBattle' ? '扫描中…' : '扫描战斗记录'}}
    </button>
    <button
      wx:if="{{battlePreview && battlePreview.items.length}}"
      class="cleanup-button danger"
      bindtap="handleBattleCleanupTap"
      loading="{{loading && loadingAction === 'cleanupBattle'}}"
      disabled="{{loading}}"
    >
      {{loading && loadingAction === 'cleanupBattle' ? '清理中…' : '确认清理战斗记录'}}
    </button>
  </view>

  <view wx:if="{{battlePreview}}" class="preview-card">
    <view class="preview-header">
      <view class="preview-title">战斗记录扫描结果</view>
      <view wx:if="{{battlePreviewAt}}" class="preview-time">{{battlePreviewAt}}</view>
    </view>
    <view wx:if="{{battlePreview.total > 0}}" class="preview-summary">发现 {{battlePreview.total}} 条战斗相关数据</view>
    <view wx:else class="preview-summary muted">未发现需处理的战斗记录</view>
    <view wx:if="{{battlePreview.items.length}}" class="preview-list">
      <view wx:for="{{battlePreview.items}}" wx:key="key" class="preview-item">
        <view class="preview-name">
          <text class="preview-collection">{{item.collection}}</text>
          <text class="preview-label">{{item.label}}</text>
        </view>
        <view class="preview-field">索引字段：{{item.indexes}}</view>
        <view class="preview-desc">数据功能：{{item.description}}</view>
        <view class="preview-reason">清理原因：{{item.reason}}</view>
      </view>
    </view>
    <view wx:else class="preview-empty">当前战斗记录无需清理。</view>
  </view>

  <view wx:if="{{battleResult}}" class="result-card">
    <view class="result-header">
      <view class="result-title">战斗记录清理结果</view>
      <view wx:if="{{battleFinishedAt}}" class="result-time">{{battleFinishedAt}}</view>
    </view>
    <view class="result-summary">共清理 {{battleResult.totalRemoved}} 条战斗相关数据</view>
    <view wx:if="{{battleResult.memberCount}}" class="result-members">受影响会员：{{battleResult.memberCount}} 人</view>
    <view wx:if="{{battleResult.details.length}}" class="detail-list">
      <view wx:for="{{battleResult.details}}" wx:key="key" class="detail-item">
        <view class="detail-name">{{item.label}}</view>
        <view class="detail-count">{{item.count}}</view>
      </view>
    </view>
    <view wx:else class="detail-empty">未发现需要清理的战斗记录，系统状态良好。</view>
    <view wx:if="{{battleResult.errors.length}}" class="error-block">
      <view class="error-title">部分战斗数据未能成功清理：</view>
      <view wx:for="{{battleResult.errors}}" wx:key="index" class="error-item">{{item}}</view>
    </view>
  </view>
</view>
