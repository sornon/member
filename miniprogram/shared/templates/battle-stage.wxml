<template name="battle-stage">
  <view class="battle-stage">
    <video
      class="battle-video"
      src="{{backgroundVideo}}"
      autoplay
      loop
      muted
      controls="{{false}}"
      show-center-play-btn="{{false}}"
      enable-progress-gesture="{{false}}"
      object-fit="cover"
    ></video>
    <view class="battle-fallback"></view>
    <view class="battle-content" wx:if="{{!loading && player && opponent}}">
      <view class="battle-scoreboard">
        <view
          class="actor-card attacker-card {{attackerKey === 'player' ? 'actor-player' : 'actor-opponent'}}"
        >
          <view class="actor-header">
            <view class="actor-avatar">
              <image
                class="actor-avatar__image"
                src="{{attackerKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
                mode="aspectFill"
              ></image>
              <image
                wx:if="{{attackerKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                class="actor-avatar__frame"
                src="{{attackerKey === 'player' ? player.avatarFrame : opponent.avatarFrame}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="actor-details">
              <view class="actor-name">
                {{attackerKey === 'player' ? (player && player.name || '我方') : (opponent && opponent.name || '对手')}}
              </view>
              <view
                class="actor-title"
                wx:if="{{attackerKey === 'player'
                  ? (player && (player.titleImage || player.titleName))
                  : (opponent && (opponent.titleImage || opponent.titleName))}}"
              >
                <image
                  wx:if="{{attackerKey === 'player' ? player.titleImage : opponent.titleImage}}"
                  class="actor-title__image"
                  src="{{attackerKey === 'player' ? player.titleImage : opponent.titleImage}}"
                  mode="heightFix"
                ></image>
                <text
                  wx:else
                  class="actor-title__text"
                >
                  {{attackerKey === 'player' ? player.titleName : opponent.titleName}}
                </text>
              </view>
            </view>
          </view>
          <view class="actor-meta">
            战力 {{attackerKey === 'player'
              ? ((player && player.combatPower) || '???')
              : ((opponent && opponent.combatPower) || '???')}}
          </view>
          <view class="hp-track">
            <view
              class="hp-progress {{attackerKey === 'player' ? 'hp-player' : 'hp-opponent'}}"
              style="width: {{hpState[attackerKey] ? hpState[attackerKey].percent : 0}}%"
            ></view>
          </view>
          <view class="hp-text">
            {{hpState[attackerKey] ? hpState[attackerKey].current : 0}} /
            {{hpState[attackerKey] ? hpState[attackerKey].max : 0}}
          </view>
        </view>
        <view
          class="actor-card defender-card {{defenderKey === 'player' ? 'actor-player' : 'actor-opponent'}}"
        >
          <view class="actor-header">
            <view class="actor-avatar">
              <image
                class="actor-avatar__image"
                src="{{defenderKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
                mode="aspectFill"
              ></image>
              <image
                wx:if="{{defenderKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                class="actor-avatar__frame"
                src="{{defenderKey === 'player' ? player.avatarFrame : opponent.avatarFrame}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="actor-details">
              <view class="actor-name">
                {{defenderKey === 'player' ? (player && player.name || '我方') : (opponent && opponent.name || '对手')}}
              </view>
              <view
                class="actor-title"
                wx:if="{{defenderKey === 'player'
                  ? (player && (player.titleImage || player.titleName))
                  : (opponent && (opponent.titleImage || opponent.titleName))}}"
              >
                <image
                  wx:if="{{defenderKey === 'player' ? player.titleImage : opponent.titleImage}}"
                  class="actor-title__image"
                  src="{{defenderKey === 'player' ? player.titleImage : opponent.titleImage}}"
                  mode="heightFix"
                ></image>
                <text
                  wx:else
                  class="actor-title__text"
                >
                  {{defenderKey === 'player' ? player.titleName : opponent.titleName}}
                </text>
              </view>
            </view>
          </view>
          <view class="actor-meta">
            战力 {{defenderKey === 'player'
              ? ((player && player.combatPower) || '???')
              : ((opponent && opponent.combatPower) || '???')}}
          </view>
          <view class="hp-track">
            <view
              class="hp-progress {{defenderKey === 'player' ? 'hp-player' : 'hp-opponent'}}"
              style="width: {{hpState[defenderKey] ? hpState[defenderKey].percent : 0}}%"
            ></view>
          </view>
          <view class="hp-text">
            {{hpState[defenderKey] ? hpState[defenderKey].current : 0}} /
            {{hpState[defenderKey] ? hpState[defenderKey].max : 0}}
          </view>
        </view>
      </view>

      <view class="battle-avatars">
        <view
          class="avatar-wrapper attacker {{attackerKey}} {{currentAction.actor === attackerKey ? 'is-attacking' : ''}} {{currentAction.target === attackerKey ? 'is-hit' : ''}}"
        >
          <view class="avatar-inner">
            <image
              class="actor-portrait"
              src="{{attackerKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
              mode="widthFix"
            ></image>
          </view>
        </view>
        <view
          class="avatar-wrapper defender {{defenderKey}} {{currentAction.actor === defenderKey ? 'is-attacking' : ''}} {{currentAction.target === defenderKey ? 'is-hit' : ''}}"
        >
          <view class="avatar-inner">
            <image
              class="actor-portrait"
              src="{{defenderKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
              mode="widthFix"
            ></image>
          </view>
        </view>
      </view>

      <view class="battle-log">
        <view class="log-title">战斗瞬息</view>
        <view class="log-list">
          <view class="log-item" wx:for="{{displayedLogs}}" wx:key="id">{{item.text}}</view>
        </view>
      </view>

      <view class="battle-controls">
        <button class="control-button" type="default" size="mini" bindtap="handleSkip" disabled="{{skipLocked}}">
          {{skipButtonText}}
        </button>
        <button class="control-button" type="primary" size="mini" bindtap="handleExit" wx:if="{{battleFinished}}">返回</button>
      </view>
    </view>
    <view wx:if="{{loading}}" class="battle-loading">灵气汇聚中...</view>
    <view wx:elif="{{error}}" class="battle-loading">{{error}}</view>

    <view wx:if="{{battleFinished}}" class="battle-result-overlay">
      <view class="result-card {{resultClass}}">
        <view class="result-title">{{resultTitle}}</view>
        <view class="result-subtitle">{{resultSubtitle}}</view>
        <view class="result-summary">耗时 {{resultRounds}} 回合</view>
      </view>
    </view>
  </view>
</template>
