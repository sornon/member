<template name="battle-stage">
  <view class="battle-stage">
    <video
      class="battle-video"
      src="{{backgroundVideo}}"
      autoplay
      loop
      muted
      controls="{{false}}"
      show-center-play-btn="{{false}}"
      enable-progress-gesture="{{false}}"
      object-fit="cover"
    ></video>
    <view class="battle-fallback"></view>
    <view class="battle-content" wx:if="{{!loading && player && opponent}}">
      <view class="battle-scoreboard">
        <view
          class="actor-card attacker-card {{attackerKey === 'player' ? 'actor-player' : 'actor-opponent'}}"
        >
          <view class="actor-card__header">
            <view class="actor-card__avatar">
              <image
                class="actor-card__avatar-image"
                src="{{attackerKey === 'player' ? (player && player.avatar || '') : (opponent && opponent.avatar || '')}}"
                mode="cover"
              ></image>
              <image
                wx:if="{{attackerKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                class="actor-card__avatar-frame"
                src="{{attackerKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="actor-card__info">
              <view class="actor-name">
                {{attackerKey === 'player' ? (player && player.name || '我方') : (opponent && opponent.name || '对手')}}
              </view>
              <view
                wx:if="{{attackerKey === 'player' ? ((player && player.titleImage) || (player && player.titleName)) : ((opponent && opponent.titleImage) || (opponent && opponent.titleName))}}"
                class="actor-title"
              >
                <image
                  wx:if="{{attackerKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  class="actor-title__image"
                  src="{{attackerKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  mode="heightFix"
                ></image>
                <text
                  wx:elif="{{attackerKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}"
                  class="actor-title__text"
                >
                  {{attackerKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}
                </text>
              </view>
            </view>
          </view>
          <view class="actor-meta">
            战力 {{attackerKey === 'player'
              ? ((player && player.combatPower) || '???')
              : ((opponent && opponent.combatPower) || '???')}}
          </view>
          <view class="hp-track">
            <view
              class="hp-progress {{attackerKey === 'player' ? 'hp-player' : 'hp-opponent'}}"
              style="{{hpState[attackerKey] ? hpState[attackerKey].progressStyle : ''}}"
            ></view>
          </view>
          <view class="hp-text">
            {{hpState[attackerKey] ? hpState[attackerKey].current : 0}} /
            {{hpState[attackerKey] ? hpState[attackerKey].max : 0}}
          </view>
        </view>
        <view
          class="actor-card defender-card {{defenderKey === 'player' ? 'actor-player' : 'actor-opponent'}}"
        >
          <view class="actor-card__header">
            <view class="actor-card__avatar">
              <image
                class="actor-card__avatar-image"
                src="{{defenderKey === 'player' ? (player && player.avatar || '') : (opponent && opponent.avatar || '')}}"
                mode="cover"
              ></image>
              <image
                wx:if="{{defenderKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                class="actor-card__avatar-frame"
                src="{{defenderKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="actor-card__info">
              <view class="actor-name">
                {{defenderKey === 'player' ? (player && player.name || '我方') : (opponent && opponent.name || '对手')}}
              </view>
              <view
                wx:if="{{defenderKey === 'player' ? ((player && player.titleImage) || (player && player.titleName)) : ((opponent && opponent.titleImage) || (opponent && opponent.titleName))}}"
                class="actor-title"
              >
                <image
                  wx:if="{{defenderKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  class="actor-title__image"
                  src="{{defenderKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  mode="heightFix"
                ></image>
                <text
                  wx:elif="{{defenderKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}"
                  class="actor-title__text"
                >
                  {{defenderKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}
                </text>
              </view>
            </view>
          </view>
          <view class="actor-meta">
            战力 {{defenderKey === 'player'
              ? ((player && player.combatPower) || '???')
              : ((opponent && opponent.combatPower) || '???')}}
          </view>
          <view class="hp-track">
            <view
              class="hp-progress {{defenderKey === 'player' ? 'hp-player' : 'hp-opponent'}}"
              style="{{hpState[defenderKey] ? hpState[defenderKey].progressStyle : ''}}"
            ></view>
          </view>
          <view class="hp-text">
            {{hpState[defenderKey] ? hpState[defenderKey].current : 0}} /
            {{hpState[defenderKey] ? hpState[defenderKey].max : 0}}
          </view>
        </view>
      </view>

      <view class="battle-avatars">
        <view
          class="avatar-wrapper attacker {{attackerKey}} {{currentAction.actor === attackerKey ? 'is-attacking' : ''}} {{currentAction.target === attackerKey ? 'is-hit' : ''}} {{currentMotion.isBasicAttack && currentAction.actor === attackerKey ? 'motion-basic-attack' : ''}} {{currentMotion.isCritical && currentAction.actor === attackerKey ? 'motion-critical' : ''}} {{currentMotion.isBasicAttack && currentAction.target === attackerKey ? (currentMotion.targetDodged ? 'motion-dodged' : 'motion-hit') : ''}}"
        >
          <view class="floating-text-layer">
            <view
              wx:for="{{floatingTexts[attackerKey] || []}}"
              wx:key="id"
              class="floating-text {{'floating-' + item.type}}"
            >
              {{item.text}}
            </view>
          </view>
          <view class="avatar-inner">
            <image
              class="actor-portrait"
              src="{{attackerKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
              mode="widthFix"
            ></image>
          </view>
        </view>
        <view
          class="avatar-wrapper defender {{defenderKey}} {{currentAction.actor === defenderKey ? 'is-attacking' : ''}} {{currentAction.target === defenderKey ? 'is-hit' : ''}} {{currentMotion.isBasicAttack && currentAction.actor === defenderKey ? 'motion-basic-attack' : ''}} {{currentMotion.isCritical && currentAction.actor === defenderKey ? 'motion-critical' : ''}} {{currentMotion.isBasicAttack && currentAction.target === defenderKey ? (currentMotion.targetDodged ? 'motion-dodged' : 'motion-hit') : ''}}"
        >
          <view class="floating-text-layer">
            <view
              wx:for="{{floatingTexts[defenderKey] || []}}"
              wx:key="id"
              class="floating-text {{'floating-' + item.type}}"
            >
              {{item.text}}
            </view>
          </view>
          <view class="avatar-inner">
            <image
              class="actor-portrait"
              src="{{defenderKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
              mode="widthFix"
            ></image>
          </view>
        </view>
      </view>

      <view class="battle-controls">
        <button class="control-button" type="default" size="mini" bindtap="handleSkip" disabled="{{skipLocked}}">
          {{skipButtonText}}
        </button>
        <button class="control-button" type="primary" size="mini" bindtap="handleExit" wx:if="{{battleFinished}}">返回</button>
      </view>
    </view>
    <view wx:if="{{loading}}" class="battle-loading">灵气汇聚中...</view>
    <view wx:elif="{{error}}" class="battle-loading">{{error}}</view>

    <view wx:if="{{battleFinished}}" class="battle-result-overlay">
      <view class="result-card {{resultClass}}">
        <view class="result-title">{{resultTitle}}</view>
        <view class="result-subtitle">{{resultSubtitle}}</view>
        <view class="result-summary">耗时 {{resultRounds}} 回合</view>
      </view>
    </view>
  </view>
</template>
