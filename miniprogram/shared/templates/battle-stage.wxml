<template name="battle-stage">
  <view class="battle-stage">
    <video
      class="battle-video"
      src="{{backgroundVideo}}"
      autoplay
      loop
      muted
      controls="{{false}}"
      show-center-play-btn="{{false}}"
      enable-progress-gesture="{{false}}"
      object-fit="cover"
    ></video>
    <view class="battle-fallback"></view>
    <view class="battle-content" wx:if="{{!loading && player && opponent}}">
      <view class="battle-scoreboard">
        <view
          class="actor-card attacker-card {{attackerKey === 'player' ? 'actor-player' : 'actor-opponent'}}"
        >
          <view class="actor-card__header">
            <view class="actor-card__avatar">
              <view class="actor-card__avatar-inner">
                <image
                  class="actor-card__avatar-image"
                  src="{{attackerKey === 'player' ? (player && player.avatar || '') : (opponent && opponent.avatar || '')}}"
                  mode="cover"
                ></image>
              </view>
              <image
                wx:if="{{attackerKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                class="actor-card__avatar-frame"
                src="{{attackerKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="actor-card__info">
              <view class="actor-name">
                {{attackerKey === 'player' ? (player && player.name || '我方') : (opponent && opponent.name || '对手')}}
              </view>
              <view
                wx:if="{{attackerKey === 'player' ? ((player && player.titleImage) || (player && player.titleName)) : ((opponent && opponent.titleImage) || (opponent && opponent.titleName))}}"
                class="actor-card__title"
              >
                <image
                  wx:if="{{attackerKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  class="actor-card__title-image"
                  src="{{attackerKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  mode="heightFix"
                ></image>
                <text
                  wx:elif="{{attackerKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}"
                  class="actor-card__title-text"
                >
                  {{attackerKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}
                </text>
              </view>
            </view>
          </view>
          <view class="actor-meta">
            战力 {{attackerKey === 'player'
              ? ((player && player.combatPower) || '???')
              : ((opponent && opponent.combatPower) || '???')}}
          </view>
          <view class="track-row">
            <view class="track-title">HP</view>
            <view class="hp-track">
              <view
                class="hp-progress {{attackerKey === 'player' ? 'hp-player' : 'hp-opponent'}}"
                style="{{hpState[attackerKey] ? hpState[attackerKey].progressStyle : ''}}"
              ></view>
              <view class="track-label hp-label">
                {{hpState[attackerKey] ? hpState[attackerKey].current : 0}} /
                {{hpState[attackerKey] ? hpState[attackerKey].max : 0}}
              </view>
            </view>
          </view>
          <view class="track-row">
            <view class="track-title">MP</view>
            <view class="resource-track">
              <view
                class="resource-progress {{attackerKey === 'player' ? 'resource-player' : 'resource-opponent'}}"
                style="{{resourceState[attackerKey] ? resourceState[attackerKey].progressStyle : ''}}"
              ></view>
              <view class="track-label resource-label">
                {{resourceState[attackerKey] ? resourceState[attackerKey].current : 0}} /
                {{resourceState[attackerKey] ? resourceState[attackerKey].max : 0}}
              </view>
            </view>
          </view>
        </view>
        <view
          class="actor-card defender-card {{defenderKey === 'player' ? 'actor-player' : 'actor-opponent'}}"
        >
          <view class="actor-card__header">
            <view class="actor-card__avatar">
              <view class="actor-card__avatar-inner">
                <image
                  class="actor-card__avatar-image"
                  src="{{defenderKey === 'player' ? (player && player.avatar || '') : (opponent && opponent.avatar || '')}}"
                  mode="cover"
                ></image>
              </view>
              <image
                wx:if="{{defenderKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                class="actor-card__avatar-frame"
                src="{{defenderKey === 'player' ? (player && player.avatarFrame) : (opponent && opponent.avatarFrame)}}"
                mode="scaleToFill"
              ></image>
            </view>
            <view class="actor-card__info">
              <view class="actor-name">
                {{defenderKey === 'player' ? (player && player.name || '我方') : (opponent && opponent.name || '对手')}}
              </view>
              <view
                wx:if="{{defenderKey === 'player' ? ((player && player.titleImage) || (player && player.titleName)) : ((opponent && opponent.titleImage) || (opponent && opponent.titleName))}}"
                class="actor-card__title"
              >
                <image
                  wx:if="{{defenderKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  class="actor-card__title-image"
                  src="{{defenderKey === 'player' ? (player && player.titleImage) : (opponent && opponent.titleImage)}}"
                  mode="heightFix"
                ></image>
                <text
                  wx:elif="{{defenderKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}"
                  class="actor-card__title-text"
                >
                  {{defenderKey === 'player' ? (player && player.titleName) : (opponent && opponent.titleName)}}
                </text>
              </view>
            </view>
          </view>
          <view class="actor-meta">
            战力 {{defenderKey === 'player'
              ? ((player && player.combatPower) || '???')
              : ((opponent && opponent.combatPower) || '???')}}
          </view>
          <view class="track-row">
            <view class="track-title">HP</view>
            <view class="hp-track">
              <view
                class="hp-progress {{defenderKey === 'player' ? 'hp-player' : 'hp-opponent'}}"
                style="{{hpState[defenderKey] ? hpState[defenderKey].progressStyle : ''}}"
              ></view>
              <view class="track-label hp-label">
                {{hpState[defenderKey] ? hpState[defenderKey].current : 0}} /
                {{hpState[defenderKey] ? hpState[defenderKey].max : 0}}
              </view>
            </view>
          </view>
          <view class="track-row">
            <view class="track-title">MP</view>
            <view class="resource-track">
              <view
                class="resource-progress {{defenderKey === 'player' ? 'resource-player' : 'resource-opponent'}}"
                style="{{resourceState[defenderKey] ? resourceState[defenderKey].progressStyle : ''}}"
              ></view>
              <view class="track-label resource-label">
                {{resourceState[defenderKey] ? resourceState[defenderKey].current : 0}} /
                {{resourceState[defenderKey] ? resourceState[defenderKey].max : 0}}
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="battle-round-display" wx:if="{{currentRound}}">第{{currentRound}}回合</view>

      <view class="battle-avatars">
        <view
          class="avatar-wrapper attacker {{attackerKey}} {{controlledState && controlledState[attackerKey] ? 'is-controlled' : ''}} {{attackActor === attackerKey ? 'attack-active' : ''}} {{attackActor === attackerKey && attackPhase ? 'attack-phase-' + attackPhase : ''}} {{attackActor === attackerKey && attackMotion === 'crit' ? 'attack-motion-crit' : ''}} {{attackTarget === attackerKey && attackPhase ? 'target-under-attack' : ''}} {{attackTarget === attackerKey && targetReaction === 'hit' ? 'is-hit' : ''}} {{attackTarget === attackerKey && targetReaction === 'dodge' ? 'is-dodging' : ''}}"
        >
          <view class="floating-text-layer">
            <view
              wx:if="{{attackIndicator && attackIndicator.visible && attackIndicator.side === attackerKey}}"
              class="attack-indicator {{attackIndicator.status === 'leaving' ? 'attack-indicator--leaving' : 'attack-indicator--show'}} {{attackIndicator.qualityKey ? 'attack-indicator--quality-' + attackIndicator.qualityKey : ''}}"
            >
              {{attackIndicator.text || '普攻'}}
            </view>
            <view
              wx:for="{{floatingTexts[attackerKey] || []}}"
              wx:key="id"
              class="floating-text {{'floating-' + item.type}}"
              style="{{item.color ? 'color: ' + item.color + ';' : ''}}"
            >
              {{item.text}}
            </view>
          </view>
          <view class="avatar-inner">
            <image
              class="actor-portrait"
              src="{{attackerKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
              mode="widthFix"
            ></image>
          </view>
        </view>
        <view
          class="avatar-wrapper defender {{defenderKey}} {{controlledState && controlledState[defenderKey] ? 'is-controlled' : ''}} {{attackActor === defenderKey ? 'attack-active' : ''}} {{attackActor === defenderKey && attackPhase ? 'attack-phase-' + attackPhase : ''}} {{attackActor === defenderKey && attackMotion === 'crit' ? 'attack-motion-crit' : ''}} {{attackTarget === defenderKey && attackPhase ? 'target-under-attack' : ''}} {{attackTarget === defenderKey && targetReaction === 'hit' ? 'is-hit' : ''}} {{attackTarget === defenderKey && targetReaction === 'dodge' ? 'is-dodging' : ''}}"
        >
          <view class="floating-text-layer">
            <view
              wx:if="{{attackIndicator && attackIndicator.visible && attackIndicator.side === defenderKey}}"
              class="attack-indicator {{attackIndicator.status === 'leaving' ? 'attack-indicator--leaving' : 'attack-indicator--show'}} {{attackIndicator.qualityKey ? 'attack-indicator--quality-' + attackIndicator.qualityKey : ''}}"
            >
              {{attackIndicator.text || '普攻'}}
            </view>
            <view
              wx:for="{{floatingTexts[defenderKey] || []}}"
              wx:key="id"
              class="floating-text {{'floating-' + item.type}}"
              style="{{item.color ? 'color: ' + item.color + ';' : ''}}"
            >
              {{item.text}}
            </view>
          </view>
          <view class="avatar-inner">
            <image
              class="actor-portrait"
              src="{{defenderKey === 'player' ? (player && player.portrait || '') : (opponent && opponent.portrait || '')}}"
              mode="widthFix"
            ></image>
          </view>
        </view>
      </view>

      <view class="battle-controls">
        <button class="control-button" type="default" size="mini" bindtap="handleSkip" disabled="{{skipLocked}}">
          {{skipButtonText}}
        </button>
        <button class="control-button" type="primary" size="mini" bindtap="handleExit" wx:if="{{battleFinished}}">返回</button>
      </view>
    </view>
    <view wx:if="{{loading}}" class="battle-loading">灵气汇聚中...</view>
    <view wx:elif="{{error}}" class="battle-loading">{{error}}</view>

    <view wx:if="{{battleFinished}}" class="battle-result-overlay">
      <view class="result-card {{resultClass}}">
        <view class="result-title">{{resultTitle}}</view>
        <view class="result-subtitle">{{resultSubtitle}}</view>
        <view class="result-summary">耗时 {{resultRounds}} 回合</view>
      </view>
    </view>
  </view>
</template>
