# 管理员代理登录功能部署指引

本指引适用于首次上线或升级管理员“上身”代理登录功能的环境，请按顺序完成以下步骤以避免云函数报错。

## 1. 云数据库准备
1. 登录微信云开发控制台，切换到对应的环境。
2. 在【数据库】中新建以下集合，并保持名称与代码一致：
   - `adminProxySessions`
   - `adminProxyLogs`
3. 建议将两张集合的权限规则设置为“仅创建者可读写”或遵循团队既有的安全规则。

> 若未提前创建集合，云函数会尝试自动创建；如当前环境的数据库权限禁止自动建表，将抛出“请前往云开发控制台手动创建该集合”的错误，此时需手动创建后重试。

## 2. 云函数与公共模块部署
1. 在本地更新代码后，分别部署以下云函数：
   - `admin`
   - `member`
2. 若公共模块 `common-config` 有改动（包括新增集合常量），需要重新上传 Node.js Layer 并在上述云函数中重新关联最新版本。

## 3. 小程序端发布
1. 重新构建并上传小程序代码，确保管理员会员详情页的“上身”按钮与会员首页的代理退出按钮同步更新。
2. 按照团队流程完成提审与发布。

## 4. 验证清单
1. 管理员进入【会员详情】页面，确认普通会员与测试账号显示“上身”按钮，管理员/开发者账号不显示。
2. 点击“上身”后，页面应自动跳转到会员首页且底部工具栏出现退出代理图标。
3. 在代理模式下执行充值、资料修改等操作，确认行为记录与会员本人一致。
4. 点击退出图标后应恢复管理员身份，并在数据库集合 `adminProxyLogs` 中看到对应的开始、操作、结束日志记录。

完成以上步骤后，即可在生产环境稳定使用管理员代理登录功能。

## 5. 常见问题排查

### 5.1 调用 `admin` 云函数报错 `document with _id ... does not exist`

- **现象**：管理员点击“上身”后返回 `functions execute fail`，错误详情包含 `document.get:fail document with _id ... does not exist`。
- **原因**：旧版本云函数在查询代理会话时未忽略已删除的文档，若管理员此前没有活跃会话会触发该错误。
- **解决办法**：部署本仓库最新的 `admin` 云函数代码，函数会自动把缺失的文档视为无有效会话，不再报错。

### 5.2 退出代理后“上身”按钮消失

- **现象**：管理员点击底部退出图标恢复身份后，再次进入会员详情页时找不到“上身”按钮。
- **原因**：旧版小程序未及时清理全局 `proxySession` 状态，导致页面误判仍处于代理模式。
- **解决办法**：重新上传并发布最新版本的小程序代码，更新后退出代理会同时清空全局代理状态，按钮即可恢复显示。
