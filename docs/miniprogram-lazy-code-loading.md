# 小程序按需/用时注入优化方案

## 背景

小程序首屏启动阶段除了下载代码包外，代码注入与初始化也会显著影响总耗时与内存占用。项目在基础库 2.11.1+ 环境下可以通过「按需注入」与「用时注入」减少启动时同时注入的脚本体积，避免未访问页面和组件的无谓加载。

## 方案

1. **启用按需注入**：`app.json` 增加 `lazyCodeLoading: "requiredComponents"`，让基础库仅注入当前页面声明的组件及脚本，延迟未访问页面、分包与插件的注入。
2. **为导航栏开启用时注入**：
   - 新增轻量占位组件 `custom-nav-placeholder`，只包含导航高度占位与简化样式。
   - 在所有引用 `custom-nav` 的页面 JSON 中声明 `componentPlaceholder`，首屏渲染先使用占位组件，渲染结束后再异步注入真正的自定义导航栏。
3. **配合页面声明收敛**：占位组件路径与映射已自动写入页面配置，后续如需新增页面或组件，请在对应 JSON 中保持相同模式，避免误回退为同步注入。

## 验证要点

- 使用基础库 2.20.1+ 或真机测试，确保导航栏在首屏阶段以占位样式呈现，注入完成后恢复原有交互。
- 检查 `componentPlaceholder` 配置是否与页面的 `usingComponents` 同步，避免路径拼写错误导致组件找不到。
- 对调试版本注意清理未使用的全局组件声明，确保按需注入能覆盖更多页面。
