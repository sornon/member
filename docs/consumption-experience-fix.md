# 消费修为异常修复方案

## 背景
- 现有实现中，会员在完成菜单消费、扫码扣费或余额支付时，系统会按金额同步增加修为值。
- 正确规则应为：只有充值行为才能增加修为，消费行为仅产生灵石奖励并扣减余额。
- 历史数据中存在大量消费场景产生的修为，需要提供一次性清洗工具供管理员修正。

> **术语对齐**
> - **充值**：指会员钱包余额的正向入账，包括会员自行发起的微信充值以及管理员在后台的手动发放，两种场景都需要累计修为。
> - **消费**：指会员在点餐页面确认订单、扫码扣费、管理员后台代扣等余额支出行为，仅影响余额与灵石奖励，不应增加修为。

## 目标
1. 封堵全部消费路径上的修为增长逻辑，确保后续数据不会继续累积错误修为。
2. 为管理员后台新增“消费修为纠正”能力：
   - 支持扫描并预览受影响会员、交易数量、可回收修为等指标；
   - 支持一键纠正，批量回滚消费产生的修为，并标记已处理的交易；
   - 清洗过程需幂等，可反复执行，不影响已纠正的数据。

## 方案概述
### 0. 实现复查
- **充值路径**：会员自助充值（`cloudfunctions/wallet.completeRecharge`）与管理员手动充值（`cloudfunctions/admin.rechargeMember`）均通过 `calculateExperienceGain` 累计修为，并在成功后调用 `syncMemberLevel` 同步境界。
- **消费路径**：余额支付（`cloudfunctions/wallet.payWithBalance`）、扫码扣费（`wallet.confirmChargeOrder`）以及管理员强制扣费（`cloudfunctions/admin.forceChargeOrder`）均已固定返回 `experienceGain = 0`，同时写入 `spendExperienceFixed=true` 防止重复清洗。

### 1. 后端逻辑调整
- **菜单订单确认 (`cloudfunctions/menuOrder`)**：移除消费确认时的修为增量，仅保留余额扣减、灵石赠送与权益核销，新增 `spendExperienceFixed` 标记记录该笔消费已遵循新规则。
- **管理员强制扣费 (`cloudfunctions/admin`)**：移除扣费流程中的修为增量，并同步写入 `spendExperienceFixed` 标记。
- **会员余额扣费 (`cloudfunctions/wallet`)**：移除余额支付与扫码扣费流程中的修为增量，同步追加 `spendExperienceFixed` 标记，防止新交易被清洗任务重复处理。

### 2. 历史数据清洗
- 在管理员云函数中新增动作：
  - `previewFixSpendExperience`：统计 `walletTransactions` 中 `type=spend` 且未设置 `spendExperienceFixed` 的交易，聚合至会员维度，计算潜在回收修为。
  - `fixSpendExperience`：按会员逐一处理，遍历待纠正交易，打标 `spendExperienceFixed=true` 并累计可回收修为；在事务中回退会员修为（不低于 0），更新 `updatedAt`，并在成功后调用 `syncMemberLevel` 重新计算境界。
- 结果中返回会员列表（含姓名、消费金额、回收修为、修正前后修为对比、最近消费时间）及汇总指标，便于前端展示。
- 若某会员当前修为不足以回退全部金额，则仅回退实际可扣减的修为并记录差值，保证幂等。
- 清洗成功后会自动同步会员战力与权益：
  - 重新计算 PVE 档案，将境界、经验阈值与属性摘要刷新到最新水平，并回收因降级产生的多余属性点（优先扣减未分配点数，不足部分按属性轮询回收已分配点）。
  - 依据当前等级顺序裁剪 `claimedLevelRewards` 与 `deliveredLevelRewards`，同时刷新 `pve/profile` 缓存，避免会员保留高阶等级奖励或突破奖励；若未来重新升级，可重新领取对应奖励。

### 3. 管理员前端页面
- 在「数据清理」页面追加“消费修为纠正”卡片，支持扫描与执行两个按钮。
- 展示扫描结果与执行结果，包括：
  - 受影响会员数量、消费总额、错误修为总量、涉及的交易数；
  - 具体会员条目列表，显示姓名/ID、交易数、消费金额（元）、待回收修为、当前修为、修正后修为、最近异常消费时间。
- 扫描结果存在时显示确认弹窗，避免误操作；执行完成后刷新列表并展示 toast。

## 管理员操作流程
1. 登录小程序管理员后台，进入「数据清理」页面，找到“消费修为纠正”卡片。
2. 点击“扫描异常修为”触发 `previewFixSpendExperience`：
   - 前端调用云函数扫描 `walletTransactions` 集合中未打标的消费流水，聚合统计潜在影响；
   - 页面显示受影响会员明细及回滚前后修为预估，便于提前评估影响范围。
3. 确认扫描结果无误后点击“执行修正”，弹窗确认后调用 `fixSpendExperience`：
   - 云函数按会员逐一回滚修为并打标历史消费流水；
   - 完成后页面展示实际回滚数据及可能出现的失败记录，管理员可据此追踪问题。
4. 若后续新增历史脏数据，可重复执行扫描与修正；已打标的流水不会被重复处理，确保操作幂等。

## 接口返回结构
- `previewFixSpendExperience`
  - `memberCount`：涉及会员数量；
  - `totalTransactions`：待处理消费流水数量；
  - `totalAmount`：消费总额（分）；
  - `totalExperience`：理论可回滚修为；
  - `totalExperienceDeducted`：考虑会员当前修为后预计可回滚的修为；
  - `members[]`：逐会员明细，包含消费金额、修为前后对比、最近异常消费时间等字段。
- `fixSpendExperience`
  - 字段含义同上，`summary.errors` 提供未能成功修正的记录，便于后续补救。

## 数据与安全考虑
- 清洗流程对每位会员使用事务保证余额/修为一致性，且在扣减修为后调用 `syncMemberLevel`，确保境界状态与权益同步。
- 所有被处理的消费交易会写入 `spendExperienceFixed=true` 与时间/操作者标记，重复执行时将被自动忽略，实现幂等。
- 新消费交易在写入时即附带 `spendExperienceFixed=true`，无需等待清洗即可与旧数据区分。
- 清洗完成后追加一次 PVE 档案刷新，确保境界、属性点、突破状态与回退后的修为一致。
- 通过裁剪等级奖励/突破奖励的领取记录，避免会员降级后继续占有高阶权益，防止后续再次升级时重复领取。

## 验证
- 单元测试覆盖受限，采用手动验证：
  1. 创建测试会员并模拟充值、消费，确认消费后修为不再变化；
  2. 人为写入旧版消费交易，执行扫描与清洗，验证修为被回滚且交易被打标；
  3. 再次执行扫描，应提示无待处理数据；
  4. 观察会员境界、灵石、余额均与预期一致。
