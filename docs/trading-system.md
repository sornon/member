# 交易行系统设计与部署指南

## 一、设计目标

交易行的核心目标是在玩家之间建立装备流通渠道，强化灵石作为通用货币的价值承载能力，形成“产出 → 消费 → 价值回收”的闭环。系统遵循以下原则：

1. **纯玩家交易**：所有挂单均由玩家发起与成交，系统不提供回收或托管功能，确保价格完全由市场决定。
2. **多样化定价**：同时支持「一口价」与「拍卖」两种模式，满足不同装备稀缺度与交易习惯。
3. **货币循环**：通过交易手续费、竞拍保证金等机制回收部分灵石，防止货币过度膨胀，并将燃烧的灵石沉入系统池以维持价值。
4. **公平与安全**：挂单、出价、结算均使用原子化事务处理，装备在交易期间被暂存，防止重复使用或异常复制。
5. **即时反馈**：小程序首页提供显著入口和余额概览，便于玩家快速查看市场动态。

## 二、功能概览

### 1. 装备上架
- 玩家在首页右上角点击「交易行」，进入交易页后可选择纳戒中的可售装备进行上架。
- 上架需选择出售方式：
  - **一口价**：设定固定价格，玩家支付灵石即可立即购入。
  - **拍卖**：设定起拍价，可选最小加价幅度与一口价；系统默认依据比例给出最低加价下限。
- 装备上架后从原纳戒移除并冻结，挂单到期或被取消时自动退回。

### 2. 出售与竞价
- 市场列表展示在售挂单，包含模式、当前价格、剩余时间与出价次数。
- 拍卖支持实时出价：
  - 出价时将扣除相应灵石并记录锁定流水；若被更高出价超过则即时退还。
  - 若设置了一口价，任一玩家可直接买断，系统会先返还当前最高出价者的保证金，再完成买断结算。
- 一口价装备直接扣除灵石并成交。

### 3. 结算与回收
- 成交时自动结算：
  - 买家扣除灵石（或转化竞拍保证金）。
  - 卖家获得灵石收益，系统按 `TRADING_CONFIG.feeRate` 抽取燃烧手续费并记录在统计表，成为灵石回收渠道。
  - 装备转移至买家纳戒。
- 拍卖挂单到期后若存在有效出价则自动判定胜出，否则退回装备并标记为过期。

### 4. 数据指标
- 交易首页展示累计成交笔数、成交额及燃烧灵石量，帮助运营团队快速观察经济走势。

## 三、数据结构与云函数

### 1. 新增云函数 `trading`
负责所有交易相关逻辑，主要 action：

| Action | 功能说明 |
| --- | --- |
| `dashboard` | 返回余额、市场挂单、我的挂单、我的出价与统计数据 |
| `sellable` | 查询可上架的装备列表 |
| `createListing` | 上架装备，创建挂单并冻结装备 |
| `cancelListing` | 卖家取消挂单，退回装备及保证金 |
| `buyNow` | 立即购买一口价或设有买断价的拍卖挂单 |
| `placeBid` | 拍卖出价，扣除保证金并更新最高出价 |

交易云函数依赖以下集合（如不存在会自动创建）：

- `tradeListings`：挂单信息，记录售卖模式、价格、出价历史、状态等。
- `tradeBids`：竞拍记录及保证金流水，状态包含 active、refunded、won 等。
- `tradeOrders`：成交订单，存储买卖双方、售价、手续费等用于运营分析。
- `tradeMetrics`：交易全局统计（成交额、手续费、成交笔数）。
- `stoneTransactions`：沿用既有灵石流水集合，新增类型 `tradeBidLock`、`tradeBidRefund`、`tradePurchase`、`tradeIncome` 等。

### 2. 数据流转
1. **上架**：
   - 校验装备合法性（排除新手赠送装备），通过 `_.pull` 从 `members.pveProfile.equipment.inventory` 中移除。
   - 写入 `tradeListings`，记录冻结的装备快照。
2. **出价**：
   - 校验余额与最小加价幅度，扣除灵石并写入 `tradeBids`。
   - 若存在更高出价，原最高出价者立即退款并更新流水类型。
3. **结算**：
   - 一口价购买或拍卖到期会调用统一的 `completeSale`，在事务内完成扣款、手续费燃烧、装备转移、订单记录等步骤。
4. **到期处理**：
   - `dashboard` 请求会触发 `settleExpiredListings`，自动轮询到期挂单并执行成交或退货逻辑。

## 四、前端体验

- 首页新增右上角「交易行」入口，快速跳转交易页。
- 交易页包含三个分页：市场、我的挂单、我的出价，统一使用卡片式视觉展示。
- 上架弹窗支持装备选择、模式切换、价格与时长设置，并给出时长范围提示（默认 24~168 小时）。
- 详情弹窗提供出价历史、剩余时间、一键买断/出价/取消操作。

## 五、经济循环设计

1. **手续费燃烧**：每笔成交按配置比例（默认 5%）抽取，累计写入 `tradeMetrics.totalFee`，可用于后续运营分析或活动投放。
2. **保证金冻结**：竞拍期间占用灵石余额，防止刷价；若被超越立即返还，胜出后自动转化为成交款。
3. **实时指标**：页面展示成交额、成交笔数、燃烧灵石，帮助玩家感知市场活跃度，同时为运营提供监控入口。
4. **挂单限制**：每名玩家默认最多同时上架 10 件装备，防止刷屏与恶意操纵市场。
5. **时间限制**：可配置最小/最大挂单时长，降低长时间冻结资产的风险。

## 六、部署步骤

1. **同步代码**
   - 拉取最新代码并确认包含 `cloudfunctions/trading` 与 `miniprogram/pages/trading` 等目录。

2. **云函数部署**
   - 在微信开发者工具中选择 `trading` 云函数，执行「上传并部署：云端安装依赖」。
   - 若使用 CI/CD，可在命令行执行 `npm install`（云端自动安装）后通过 `tcb` CLI 部署。

3. **数据库集合**
   - 在云开发控制台创建以下集合（若已自动创建可跳过）：
     - `tradeListings`
     - `tradeBids`
     - `tradeOrders`
     - `tradeMetrics`
   - 确保集合拥有默认读写权限（推荐“仅创建者可写，所有人可读”，再配合云函数执行自定义校验）。

4. **权限配置**
   - 交易云函数依赖 `common-config`、`admin-proxy` 层，需确保相关 Node.js 公共模块已上传（项目默认包含 `nodejs-layer`）。

5. **小程序前端**
   - 在微信开发者工具中构建并预览，验证首页入口、交易页加载、上架/出价/买断流程是否正常。
   - 若环境存在缓存，可通过首页右上角菜单清理缓存后重新登录。

6. **运营校验**
   - 通过数据库或 `tradeMetrics` 文档确认指标写入。
   - 试运行一笔一口价与一笔拍卖，验证灵石流水：买家扣款、卖家到账、手续费燃烧、竞拍退款等是否正确。

## 七、后续扩展建议

- **批量上架**：支持一次选择多件同类装备，优化重度玩家体验。
- **筛选与排序**：提供按装备槽位、稀有度、价格区间筛选，增强市场可用性。
- **成交历史面板**：将 `tradeOrders` 做可视化展示，帮助玩家洞察价格趋势。
- **提醒系统**：接入订阅消息，提醒玩家竞拍被超越或商品售出，提升互动频率。

通过上述设计，交易行在满足玩家自由交易需求的同时，引入手续费燃烧和保证金机制，既能促进装备与灵石的循环流通，也为运营提供足够的监控与调节杠杆。
