# 宗门属性系统设计与实现

本文档描述宗门属性的整体规则、数据结构、接口与前端展现。宗门属性由全部战斗属性组成，用以为宗门成员提供长期成长空间，并与宗门贡献打通。

## 玩法规则

- **属性来源**：所有 `combat-system` 中的战斗属性均纳入宗门属性列表（生命、攻击、防御、暴击、终伤等）。
- **贡献换点**：宗门总贡献每增加 `1000` 点获得 1 个宗门属性升级点，仅由宗主分配用于提升某个属性的上限。
- **初始状态**：新宗门所有属性上限为 0，成员属性等级也为 0。
- **上限分配**：宗主使用升级点后，只会解锁对应属性的更高上限（每点 +1 级），全宗门共享上限；单项上限封顶 10 级。
- **成员升级**：成员使用个人宗门贡献升级自身宗门属性，等级不得超过宗门上限；个人贡献消耗不会影响历史贡献统计。
- **成长幅度**：每级附加值基于属性特性配置，示例：
  - 生命上限：+2% 基础生命
  - 物理/法术攻击：+1.8% 基础攻击
  - 终伤加成/减免、暴击率：+1% 绝对值
  - 元素易伤：每级 -1%（降低易伤）

## 数据结构

### `guilds` 集合

新增字段（兼容旧数据，默认缺省时视为 0）：

```json
{
  "guildAttributes": {
    "caps": { "maxHp": 0, "physicalAttack": 0, ... },
    "pointsSpent": 0,
    "updatedAt": Date
  }
}
```

- `caps`：按属性记录宗门上限。
- `pointsSpent`：累计已消耗升级点（= caps 总和），用于快速计算可用点数。

### `guildMembers` 集合

新增字段：

```json
{
  "guildAttributes": {
    "levels": { "maxHp": 0, "physicalAttack": 0, ... },
    "spentContribution": 0
  }
}
```

- `levels`：成员在各属性上的个人等级。
- `spentContribution`：用于属性升级的个人贡献消耗，避免影响历史贡献与排行榜。

## 接口

所有接口沿用 `cloudfunctions/guild`，须携带有效的宗门操作票据。

| Action | 说明 | 权限 | 请求体 | 响应要点 |
| --- | --- | --- | --- | --- |
| `attributes.overview` | 获取宗门属性总览、上限、个人等级、贡献余额 | 宗门成员 | `ticket`, `signature` | `catalog`（属性列表与成长描述）、`caps`、`levels`、`points`、`contribution`、`maxLevel` |
| `attributes.upgradeCap` | 消耗升级点提升指定属性上限 +1 | 仅宗主 | `key`, `ticket`, `signature` | 更新后的同上结构，校验可用点数与最大上限 |
| `attributes.upgradeLevel` | 成员消耗个人贡献提升自身属性等级 +1 | 宗门成员 | `key`, `ticket`, `signature` | 更新后的同上结构，校验宗门上限与个人贡献余额 |

### 计算公式

- 可用升级点：`floor(contributionTotal / 1000) - sum(caps)`，不足为 0。
- 成员升级消耗：`120 + 40 * (目标等级 - 1)` 贡献值，扣减 `spentContribution` 但不影响 `contributionTotal`。
- 每级加成：由 `GUILD_ATTRIBUTE_GROWTH_CONFIG` 定义，数值属性按比例取默认战斗面板计算，百分比类属性直接使用绝对增量。

## 前端展现

- 新增页面：`/packages/guild/attributes/index`，从宗门大厅快捷入口访问。
- 主要信息：
  - 宗门可用升级点、个人贡献余额、下一个升级点所需贡献。
  - 按属性卡片展示名称、描述、上限/当前等级、每级收益、消耗提示。
- 操作入口：
  - 宗主可在卡片上使用“提升上限”按钮（有可用点且未达上限）。
  - 任意成员使用“升级”按钮，需满足个人贡献与宗门上限条件。
- 页面沿用 `custom-nav`，支持下拉刷新与票据自动续期。

## 注意事项

- 旧数据缺少 `guildAttributes` 字段时自动视为 0，不影响其他宗门功能。
- 所有写操作均在云函数内校验票据与权限，失败返回对应错误码。
- 个人贡献消耗仅记入 `spentContribution`，排行榜仍使用历史贡献。
