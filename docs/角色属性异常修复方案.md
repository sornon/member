# “剩余属性点”异常累加问题排查与修复方案

## 问题概述
- 账号：酒隐之茄（管理员账号）。
- 现象：每次进入/点击“角色”页面时，界面显示的“剩余属性点”都会额外增加 35 点，并可无限累加。
- 背景：此前曾使用管理员能力直接修改过成员资料以及 `members` 集合中的字段。

## 排查结论
1. 小程序端在打开角色页面时，会调用 `ensurePveProfile` 拉取并规范化角色档案；该函数会根据外部加成（`avatarAttributeBonus`）自动同步额外的属性点。【F:cloudfunctions/pve/index.js†L6699-L6750】
2. 规范化流程会先通过 `normalizeProfile` → `normalizeAttributes` 构造一份“干净”的属性对象，但该函数未把 `avatarBonusPoints` 字段保留下来，导致每次读取后该字段都会被置空。【F:cloudfunctions/pve/index.js†L6865-L7339】
3. 因为 `attrs.avatarBonusPoints` 每次都变成 `0`，`ensurePveProfile` 会认为“头像加成尚未应用”，于是把 `extras.avatarAttributeBonus`（当前为 35）再一次累加到 `attributePoints`，形成无限叠加现象。【F:cloudfunctions/pve/index.js†L6712-L6721】

## 已实施修复方案
1. **补齐属性字段持久化链路**
   - `buildDefaultAttributes` 现已默认写入 `avatarBonusPoints: 0`，避免初始化档案缺少字段。【F:cloudfunctions/pve/index.js†L6793-L6814】
   - `normalizeAttributes` 会优先保留已有的 `avatarBonusPoints`，并回落到默认值，实现“读取-写回”过程中的值守恒。【F:cloudfunctions/pve/index.js†L7314-L7356】
2. **完善摘要同步，保障前端读取一致**
   - `refreshAttributeSummary` 已将 `attributes.avatarBonusPoints` 同步到 `attributeSummary.avatarBonusPoints`，使小程序端在校验加成是否生效时能够直接读取到最新值。【F:cloudfunctions/pve/index.js†L8127-L8172】
3. **兼容性说明**
   - 新增字段均为数值型并限定为非负整数，不会影响既有的属性计算流程；
   - 对缺失字段的历史数据会在首次读取时由规范化逻辑补齐，避免出现额外的写入压力。

## 后续数据修复与验证步骤
1. **定位受影响账号**
   - 统计 `members` 集合中 `pveProfile.attributes.attributePoints` 显著高于等级上限（>应有值 + 头像加成）的记录；
   - 结合审计日志确认是否存在管理员账号手动改库的历史。
2. **回收超发属性点**
   - 读取角色的 `attributePoints`、`avatarBonusPoints` 与成员 `extras.avatarAttributeBonus`，计算应保留的剩余点数；
   - 将 `attributePoints` 回写为 `max(应保留, 0)`，并同步写入 `avatarBonusPoints = extras.avatarAttributeBonus`。
3. **校验流程**
   - 重新进入角色页面，确认剩余属性点与头像加成显示稳定；
   - 切换页面或重新登录验证数值不再增长；
   - 手动进行一次属性点分配与洗点操作，确认字段在写回后仍被保留。
4. **上线前检查**
   - 在测试环境导入带有头像加成的历史档案，覆盖“读取-写回”与“加成变更”两条路径；
   - 补充单元测试覆盖 `normalizeAttributes` 对扩展字段的守恒，以及 `refreshAttributeSummary` 结果结构的断言；
   - 对管理员工具及脚本梳理，避免再次出现直接清空字段的操作。

## 进一步的防护建议
- **后台校验**：在成员加成变更入口添加校验，禁止出现负值或一次性大幅修改；
- **审计告警**：为管理员的手动改库行为增加日志告警，及时提示潜在风险；
- **回归脚本**：新增数据巡检脚本，定期核对 `attributePoints` 与 `avatarBonusPoints` 的关系，提前预警异常。
