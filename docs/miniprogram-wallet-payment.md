# 小程序钱包支付功能启用指南

本文档详细说明如何在微信小程序中启用并验证钱包（微信支付）功能，确保支付能力从申请、配置到上线全流程可用。

## 一、前置条件确认

1. **主体资质**
   - 小程序已完成企业或个体工商户主体认证，并通过《小程序信息安全及内容管理规范》审核。
   - 拥有同主体的微信支付商户号（MchID）。若尚未申请，可前往[微信商户平台](https://pay.weixin.qq.com)开通企业商户账号。

2. **账号权限**
   - 微信支付商户平台和小程序平台均需具有管理员权限的账号，便于后续配置关联。
   - 确认具备 SSL 证书、备案信息等上线前必备材料。

3. **开发与测试资源**
   - 后端服务支持 HTTPS（TLS 1.2 及以上）并可处理回调。
   - 具备 UAT/测试环境、预发布环境和生产环境的 API 域名及服务器资源。

## 二、开通并关联微信支付

1. 登录「微信公众平台」>「小程序后台」>「微信支付」，点击「开通」，填写商户信息申请开通。
2. 进入「微信支付商户平台」>「产品中心」>「APPID 关联设置」，将目标小程序的 `AppID` 与商户号绑定。
3. 在商户平台确认关联状态为「已关联」。若有多个商户号，需确认主商户号与服务商之间的分账/代收逻辑。

## 三、配置支付相关信息

### 1. 支付目录与回调
- 在「商户平台」>「产品中心」>「开发配置」中设置：
  - **支付授权目录**：至少添加 `https://<域名>/` 以及支付页面所在目录。例如 `https://api.example.com/pay/`。
  - **JSAPI 安全域名**：在小程序后台「开发」>「开发管理」>「开发设置」添加。
  - **支付结果通知 URL（回调地址）**：配置为后端接收支付结果通知的 HTTPS 地址。

### 2. API 密钥与证书
- 在「商户平台」>「账户中心」>「API 安全」中：
  - 设置 **APIv3 密钥**（32 位）。妥善保存并同步给后端服务。
  - 下载并安装 **商户 API 证书**（包括 `apiclient_cert.pem`、`apiclient_key.pem`），用于敏感信息加解密。
  - 如仍使用 APIv2，需要设置 APIv2 密钥并注意升级计划。

#### APIv3 证书与密钥在云函数中的部署步骤
1. **准备材料**：在本地保管好以下文件与信息：
   - APIv3 密钥（32 字符）；
   - 商户私钥 `apiclient_key.pem`；
   - 商户证书序列号（可在证书详情中查看或使用 `openssl x509 -noout -serial` 提取）；
   - 微信支付平台证书 `platform_cert.pem`（可通过平台证书下载工具获取，用于通知验签）。

2. **登录云开发控制台**：访问 [微信云开发控制台](https://tcb.cloud.tencent.com)，切换到与小程序绑定的环境 `cloud1-8gyoxq651fcc92c2`。

3. **设置环境变量**：
   - 进入「云函数」> 选择 `wallet` 与 `wallet-pay-notify` 两个函数 > 「环境变量」。
   - 分别新增或更新以下键值对（所有键名区分大小写）：

     | 变量名 | 含义 | 建议值/格式 |
     | --- | --- | --- |
     | `WECHAT_PAY_API_V3_KEY` | APIv3 密钥 | 32 位纯文本 |
     | `WECHAT_PAY_SERIAL_NO` | 商户证书序列号 | 16 进制字符串（不含冒号） |
    | `WECHAT_PAY_PRIVATE_KEY` | 商户私钥内容 | 将 `apiclient_key.pem` 全量粘贴，可保留换行；若复制的是 `\n` 转义形式程序会自动还原，勿额外包裹引号 |
    | `WECHAT_PAY_PLATFORM_CERT` | 微信支付平台证书内容 | 同样完整粘贴 PEM 内容，支持 Base64 或带 `\n` 转义的格式 |
     | `WECHAT_PAY_API_KEY`（可选） | APIv2 密钥 | 若需兼容 v2 接口则填写 |

   - 若运行在服务商模式，还需设置：`WECHAT_PAY_SERVICE_PROVIDER_MODE=true`、`WECHAT_PAY_SUB_MCHID=<子商户号>`、`WECHAT_PAY_SP_APPID=<服务商/特约小程序 AppID>`。

4. **上传并部署代码**：在开发者工具或 VSCode 插件中右键 `wallet`、`wallet-pay-notify` 目录选择「上传并部署：云端运行」；或在控制台点击「立即部署」。

5. **验证配置是否生效**：
   - 在云函数日志中搜索 `wallet` 首次启动日志，确认已读取到商户号、证书序列号等信息（日志会隐藏敏感字段，只保留长度与末尾片段）。
   - 发起 0.01 元真机测试，确认返回的 `package` 含有 `prepay_id=` 前缀且支付通知能正常解密。
   - 若出于安全需要将证书以 Base64 形式存放，只要内容可还原为标准 `-----BEGIN …-----` 包裹的 PEM，程序会自动解码；若通过控制台粘贴时自动添加了英文引号，部署前请移除引号避免签名失败。
   - 通过集合 `walletTransactions` 或调用 `wallet` 云函数返回值，核对 `paymentParams.apiVersion` 与 `paymentParams.mode`：`v3` 代表使用 APIv3，`v2` 代表走云函数内置的 `cloudPay.unifiedOrder`；`service-provider` 表示服务商模式，`direct` 表示直连模式。

> **安全提示**：证书私钥与密钥均属于敏感信息，仅应通过环境变量或云开发密钥管理功能保存，避免写入代码仓库。证书轮换后记得同步更新 `WECHAT_PAY_SERIAL_NO` 和 `WECHAT_PAY_PRIVATE_KEY`。

### 3. 分账、退款等附加能力
- 如需开通分账、退款、支付后开票等能力，需在「产品中心」中逐项申请并完成协议签署。

## 四、后端服务开发

1. **统一下单接口**
   - 使用微信支付 v3 `POST /pay/transactions/jsapi` 接口。
   - 必须在服务端完成签名，返回参数 `prepay_id`。

2. **参数返回给小程序前端**
   - 服务端根据 `prepay_id` 生成 `timeStamp`、`nonceStr`、`package`、`signType`、`paySign` 等字段。
   - 将这些字段通过 HTTPS API 返回给小程序端。

3. **回调处理**
   - 接收 `POST` 到回调 URL 的支付通知，使用平台证书验证签名并解密报文。
   - 完成业务处理（订单状态更新、库存扣减）后返回成功应答。

4. **安全措施**
   - 所有敏感信息使用微信支付提供的 `RSA/OAEP` 加密。
   - 定期轮换 API 密钥和证书，落地日志及审计策略。

## 五、小程序前端开发

1. 引入 `wx.requestPayment` 接口。
2. 在用户发起支付前校验订单状态、金额、用户登录态，调用后端统一下单接口。
3. 获取服务端返回的支付参数后调用：

```javascript
wx.requestPayment({
  timeStamp,
  nonceStr,
  package: `prepay_id=${prepayId}`,
  signType: 'RSA',
  paySign,
  success: (res) => {/* 支付成功处理 */},
  fail: (err) => {/* 支付失败处理 */}
});
```

4. 在 `success` 回调中轮询或查询订单状态，以商户系统为准。

## 六、测试与验收

1. **沙箱测试**：
   - 使用微信支付提供的沙箱环境进行接口联调，确保签名、回调等流程正确。

2. **真机测试**：
   - 在体验版或预发布环境下，使用真实微信号进行少量支付测试，确认支付限额、退款流程。

3. **异常场景验证**：
   - 包括取消支付、支付超时、回调失败重试、重复通知幂等性处理。

4. **日志与监控**：
   - 接入商户平台的支付成功/失败通知，设置告警；对接 Prometheus/ELK 等监控系统。

## 七、上线与运维

1. 在小程序后台提交支付相关页面的发布审核。
2. 审核通过后正式发布版本，监控支付成功率及异常。
3. 定期复核商户号权限、余额及结算账户，及时处理退款、对账。
4. 若涉及多商户/分账，完善对账系统与财务流程。

## 八、常见问题排查

| 问题 | 可能原因 | 处理建议 |
| ---- | -------- | -------- |
| 支付授权目录校验失败 | 目录未以 `/` 结尾或未备案 | 按要求填写完整 HTTPS 目录并备案 |
| `requestPayment` 返回 `fail` | 参数签名错误或 AppID 与商户号未关联 | 检查签名逻辑，确认 AppID 与商户号绑定状态 |
| 回调未触发 | 通知 URL 不可访问或证书异常 | 确保回调地址公网可访问，并配置正确证书 |
| 退款失败 | 未开通退款权限或超出可退金额 | 在商户平台开通退款权限，核对订单金额 |

## 九、资料与参考

- [微信支付开发者文档](https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)

