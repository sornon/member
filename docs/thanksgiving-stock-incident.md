# 感恩节库存回填事件复盘（提交审核后库存由 2 变 13）

## 现象
- 11 月感恩节活动 `bhkBargainStock` 集合原本 `stockRemaining` 仅剩 2（已售 13 张）。
- 提交小程序审核并触发审核机访问后，库存文档被重置，`stockRemaining`/`totalStock` 回落到默认配置（15），导致页面重新出现 13 个可售名额。
- 重置操作未留下告警或错误日志，存在低概率重复发生的风险。

## 原因分析
- `cloudfunctions/activities/index.js` 中两处读取库存文档（初始化与支付确认事务）使用了 `stockRef.get().catch(() => null)`：
  - 任何读取异常（包括权限不足、限流或短暂的连接失败）都会被当作“库存不存在”处理。
  - 后续逻辑会调用 `stockRef.set({ data: doc })` 重新写入默认库存（15），并覆盖 `sold` 与 `stockRemaining`。在审核机权限有限或并发异常时即可触发。
- 审核时云函数首次读取可能因权限校验返回错误，被误判为“未初始化”，从而强制重建库存文档，间接恢复到 15 席，形成 13 个“新增”席位。

## 解决方案
- 对库存文档的读取增加错误分类：
  - 仅在确认为“文档不存在”（`not exist`/`not found` 等关键字）时才允许初始化；
  - 其他错误直接抛出并写入云函数错误日志，避免自动回填库存。
- 在事务校验阶段同样应用上述策略，防止并发扣减过程中因短暂异常而重置库存。
- 立即核对数据库：将 `bhkBargainStock` 的 `stockRemaining`/`sold` 调整回真实值（审核前剩余 2，已售 13），并检查是否有重复发放的权益或订单。

## 回滚与监控建议
- 若再遇到异常库存，先暂停活动入口，核对 `bhkBargainRecords`、订单与权益，确认真实售卖数量后再手动修正 `bhkBargainStock`。
- 建议为活动云函数开启错误告警，将“库存初始化失败”/“库存加载失败”相关日志接入通知，便于快速发现类似问题。
