# 感恩节 · BHK56 限量品鉴会砍价页设计与实现说明

## 目标与定位
- **活动编号**：`479859146924a70404e4f40e1530f51d`。
- **主题风格**：黑金主色 + 感恩节暖调，突出奢华、限量与倒计时紧迫感。
- **核心玩法**：转盘砍价 + 会员（修仙境界）加成 + 分享助力追加抽奖，底价隐藏（实付触达 998 时提示“你太幸运了！已经拿到最终底价，抓紧下单吧！”）。

## 关键交互流程
1. **入口跳转**：活动列表点击该 ID 时直接跳转独立页面 `/pages/activities/bhk-bargain/index`，其余活动保持原详情页逻辑。
2. **落地信息**：Banner 展示标题、倒计时、余票、地点与价格方案。基础数据来自活动云函数（若数据库缺失则使用内置兜底），地点可点击调起腾讯地图导航。
3. **价格与权益**：展示原价与当前价、隐藏底价提示、权益亮点；规则浮层提供砍价/售票约束，权益文案突出“原价 ¥3500，拼手气拿到惊爆价”。
4. **砍价转盘**：
   - 默认 3 次抽奖；依据当前修仙境界（realmOrder）逐阶加成：炼气 +1、筑基 +4、结丹 +4 并解锁神之一手，以此类推（化神 +5、炼虚 +6...）。
  - 转盘结果实时扣减票价并弹出结果 overlay，砍到隐藏底价（998）时提示“你太幸运了！已经拿到最终底价，抓紧下单吧！”。
  - 未触达底价时，结果弹层会给出随机鼓励词（如“好友助力价格还能更低”），引导继续分享助力。
5. **分享助力**：
   - 分享按钮调起微信分享；“记录好友助力”模拟好友帮砍：每次随机减免并追加 1 次抽奖，最多 6 次。
   - 助力记录展示头像、昵称与减免金额，形成社交证明。
6. **购票引导**：底部固定栏展示实时票价与库存；若仍有砍价次数则购票前提示确认，避免误操作。

## 数据与后端
- `cloudfunctions/activities/index.js` 内置 **BHK56 兜底活动** 与 `bargainConfig`：
- 价格区间：¥3500 → （隐藏底价 998，UI 不展示）；默认抽奖 3 次；修仙境界额外抽奖 = `realmOrder`（炼气 +1、筑基 +4、结丹 +4，依次递增且结丹起解锁神之一手）；助力封顶 6 次；倒计时至 2025-12-01 24:00（北京时间）。
  - 配置字段包括转盘区间、助力减免范围、会员加成阈值、余票 15 张、封面/背景图、礼遇文案等；内置地址已更新为“北京市朝阳区百子湾路16号4号楼B座102”，并附带经纬度（39.8943, 116.5146）供前端打开腾讯地图。
  - 兜底数据同时注入活动列表与详情接口，确保数据库缺失时仍可访问。
  - 新增抽奖接口 `bargainStatus` / `bargainSpin` / `bargainAssist`：抽奖逻辑与随机数在后端完成，返还落点索引与实际减免；若抽奖将低于 998，
    则调整减免金额至刚好触达底价，并要求前端落在“???” 槽位，同时仅回传 `floorReached` 标识而不暴露具体底价，避免金额与落点不一致。
  - 用户砍价进度持久化到 `bhkBargainRecords`（按 openid 分片存储），记录当前票价、已减金额、剩余次数、助力记录等，刷新页面不会丢失进度。

## 前端实现要点
- 新增页面：`pages/activities/bhk-bargain/index`，采用 `custom-nav` 自定义头部，深色系 + 金色点缀的模块化布局（Banner、价格卡、转盘、分享、规则、底部购买）。
- 状态管理：
  - 砍价状态包含 `currentPrice`、`totalDiscount`、`remainingSpins`、`helperRecords` 等。底价不在接口透出，云函数返回布尔 `floorReached` 用于提示“已触底”。
- 倒计时按秒刷新，落地时计算剩余时间；库存与底价/砍价状态实时联动。
- 会员加成：由后端依据 `realmOrder` 判定，规则为“当前境界序号即额外抽奖次数”（炼气 +1、筑基 +4、结丹 +4 并解锁神之一手，化神 +5...），前端直接渲染云函数返回的加成与境界名称。
- 分享与助力：
  - `onShareAppMessage`/`onShareTimeline` 定向至专属页面路径，附带封面图。
  - “记录好友助力”调用后端 `bargainAssist`，由云函数随机减免并追加抽奖次数，同时累积助力记录与剩余抽奖次数的持久化。
- 规则浮层：汇总隐藏底价策略、境界加成、助力上限、库存限制等关键信息，减轻用户疑惑。

## 设计对照需求
- 头部 Banner、倒计时与余票提示、雪茄价值展示、砍价/助力/购买流程、规则说明等均按需求文案落地。
- 修仙等级（境界）被用于砍价次数加成，与现有等级体系接口复用，便于后续根据 `level-plan` 微调阈值或奖励。

## 部署与初始化
1. **更新云函数**：在微信云开发控制台或本地 CI 发布 `cloudfunctions/activities`，确保最新的砍价接口（`bargainStatus` / `bargainSpin` / `bargainAssist`）生效。
2. **创建持久化集合**：在云开发数据库中新建集合 **`bhkBargainRecords`**（权限建议“仅创建者可读写”）。云函数已内置 `createCollection` 兜底，并在集合已存在时报错 `ResourceUnavailable.ResourceExist/-501001` 时自动跳过，重复发布不会再中断；若首次调用环境无建表权限，仍建议先在控制台手动创建以避免缺表报错。
3. **静态资源**：若使用自定义封面或头像占位，可按示例上传到云存储的 `background/cover-20251102.jpg`、`avatar/default.png` 路径，或在配置中替换为现有资源。

## 已知问题与修复记录
- **境界奖励未解锁（化神期用户显示未认证）**：活动云函数仅直接读取 `members` 集合内的原始字段，缺少对 `levelId` 所关联等级数据的回填，导致高阶会员只保存了 `levelId`/`levelName` 而无完整 `level.realmName`，从而计算 `realmOrder` 失败，接口返回 `type: none`、`realmName: ''`。已在 `resolveMemberBoost` 中补充等级文档兜底加载与 `levelName` 回退，确保化神及以上会员正确识别境界并解锁境界奖励/神之一手。
- **境界奖励未随境界提升刷新**：老用户在境界提升后沿用之前的砍价档案，`bhkBargainRecords` 中的 `memberBoost/realmBonusTotal` 仍保留旧值，导致界面已显示正确境界但奖励区块仍为“未解锁”。现有逻辑在读取历史档案时会以最新境界重新赋值 `memberBoost`，对比 `realmBonusTotal` 后自动补齐新增的境界奖励并同步到 `remainingSpins`，确保化神、大乘等高阶境界即时解锁对应奖励/神之一手。
- **境界奖励补齐后未落盘导致抽奖次数不足**：老档案虽然会根据境界补齐剩余次数，但未及时写回数据库，事务内的抽奖接口仍读取旧值，基础 3 次用完后会报“抽奖次数不足”。现在读取旧档案时会检测境界加成差异并立即持久化 `remainingSpins`、`realmBonusRemaining/Total` 与 `divineHandRemaining`，确保转盘接口使用升级后的次数，避免误判。
- **砍价页模板节点未闭合导致编译失败**：`bhk-turntable` 区块的卡片容器与转盘主体被拆成了两个同级节点，末尾多出一层 `</view>`，导致 WXML 解析器持续报 "expect end-tag `block`, near `view`" 并在渲染层抛出 `__route__ is not defined`。已将转盘头部与转盘主体同置于 `bhk-card bhk-turntable` 容器内，并校验所有 `view` 节点闭合，编译恢复正常。
- **跑马灯期间价格提前跳变**：抽奖接口返回后立刻调用 `applySession` 会立即刷新票价，使得跑马灯尚未停下价格就发生变化，视觉上与落点动画不一致。现改为待跑马灯落在目标槽位后再刷新会话数据（包括价格、次数、境界加成状态），保持动画与数据展示同步。
