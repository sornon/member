# PVE 副本与数值体系说明

为配合会员体系的数值化运营，小程序新增了“秘境试炼”模块，提供 RPG 式的 PVE 玩法。该模块覆盖属性成长、装备收集、技能抽卡与副本挑战，帮助运营团队在会员活动中引入持续性的成长线。

## 核心概念

### 角色属性

- **等级与境界**：角色等级与会员境界完全同步，共 100 级。充值产生的修为值决定境界，境界决定基础属性；秘境挑战不会掉落修为，因此无法在副本内升级。
- **基础属性**：气血、攻击、防御、身法、灵运、暴击率、暴击伤害。角色初始化时使用炼气一阶的基础档位。
- **属性点**：会员每提升 1 级会额外获得 `3 + floor(等级 / 3)` 点属性点，部分副本奖励也会掉落属性点；属性点可在秘境中自由分配到气血、攻击、防御、身法、灵运五项基础属性。

#### 基础属性成长公式

设角色当前等级为 `L (1 ≤ L ≤ 100)`，各项基础属性按以下线性公式增长：

- 气血：`HP(L) = 1200 + 180 × (L - 1)`
- 攻击：`ATK(L) = 120 + 12 × (L - 1)`
- 防御：`DEF(L) = 80 + 9 × (L - 1)`
- 身法：`SPD(L) = 60 + 3 × (L - 1)`
- 灵运：`LUK(L) = 10 + 1 × (L - 1)`
- 暴击率：`CR(L) = 0.05 + 0.002 × (L - 1)`
- 暴击伤害：`CD(L) = 1.5 + 0.015 × (L - 1)`

> 服务端会对百分比属性按四位小数（暴击率）或两位小数（暴击伤害）保留，其余属性取整。该公式与会员境界保持一致，确保充值→修为→等级→基础属性的一致链路。

#### 属性影响说明

- **气血**：决定开场生命值，并与技能护盾叠加后作为总生命池参与战斗。【F:cloudfunctions/pve/index.js†L1121-L1207】【F:cloudfunctions/pve/index.js†L1688-L1699】
- **攻击**：参与基础伤害计算，公式为 `max(5, 攻击 − 敌方防御 × 0.35)`；暴击与额外伤害都会在此基础上叠加。【F:cloudfunctions/pve/index.js†L1723-L1753】【F:cloudfunctions/pve/index.js†L1782-L1796】
- **防御**：按同样的 `max(5, 敌方攻击 − 防御 × 0.35)` 公式减少敌方伤害，越高越能缓解被击压力。【F:cloudfunctions/pve/index.js†L1723-L1724】【F:cloudfunctions/pve/index.js†L1799-L1807】
- **身法**：决定首回合的出手顺序，`player.speed ≥ enemy.speed` 时玩家先手；高速搭配技能还能提高闪避收益。【F:cloudfunctions/pve/index.js†L1688-L1723】
- **灵运**：提升暴击概率（额外加成为 `min(0.25, 灵运 × 0.0025)`）、触发额外震荡伤害的几率（`min(0.2, 灵运 × 0.002)`）以及闪避与掉落/灵石奖励的加成。【F:cloudfunctions/pve/index.js†L1688-L1699】【F:cloudfunctions/pve/index.js†L1784-L1793】【F:cloudfunctions/pve/index.js†L1823-L1827】【F:cloudfunctions/pve/index.js†L1835-L1844】
- **暴击率 / 暴击伤害**：直接参与暴击判断与暴击倍率，最终暴击率封顶 85%，暴击伤害至少 1.2 倍。【F:cloudfunctions/pve/index.js†L1784-L1788】
- **技能与装备加成**：装备提供固定或精炼后的属性加成，技能既有加法也有乘法增益；所有加成会在基础属性和训练属性之上统一汇总。【F:cloudfunctions/pve/index.js†L1226-L1294】

### 装备体系

- 装备分为 **武器**、**护具**、**饰品** 三个槽位，每件装备带有固定属性加成及稀有度标签（常见、稀有、史诗、传说）。
- 玩家默认拥有一套入门装备，后续可通过副本掉落或运营投放获取更高品质装备。
- 重复获取相同装备会提升“精炼等级”，在云函数中按装备系数放大加成。

### 技能体系

- 技能以卡牌形式存在，按稀有度划分为常见/稀有/史诗/传说，并可通过“抽取灵技”获得。
- 技能提供攻击加成、护盾、闪避等多种效果，同时可叠加到装备后的最终战力。
- 抽到重复技能会自动提升技能等级（上限 5 级），对应地增强加成或附加效果。

### 秘境副本

- 当前内置四个标识性副本（灵芽傀儡、炽火幽灵、渊狱巨灵、缚时织者），覆盖不同阶段的战力需求与掉落。
- 战斗流程采用回合制模拟，综合考虑攻击、防御、暴击、闪避等参数，产出详细战报与奖励。
- 奖励包含灵石、属性点以及随机装备/技能掉落，并自动写入灵石流水；修为仅能通过充值等会员消费场景提升。

## 前端交互

- 首页底部导航新增“秘境”入口，跳转至 `/pages/pve/pve` 页面。
- 页面包含以下模块：
  - **角色属性**：展示战力、修为进度、属性明细，并提供手动/自动分配属性点。
  - **装备总览**：显示当前穿戴与背包装备，可一键切换。
  - **技能与抽卡**：查看已装备技能、背包技能，支持抽取新技能。
- **秘境对手**：列出可挑战副本、推荐战力与基础奖励。
- **战斗记录**：展示最近战斗战报与技能抽卡历史。

### 战斗计算要点

1. **最终属性汇总**：角色的最终属性为“基础属性 + 训练加点 + 装备加成 + 技能加成”，其中技能加成包含加法与倍率两部分，计算完成后用于战力与回合模拟。【F:cloudfunctions/pve/index.js†L1121-L1207】【F:cloudfunctions/pve/index.js†L1226-L1294】
2. **出手与伤害**：
   - 先手由身法决定，身法高者率先行动。【F:cloudfunctions/pve/index.js†L1688-L1723】
   - 玩家基础伤害 `basePlayerDamage = max(5, 攻击 − 敌防 × 0.35)`，再乘以 0.85~1.15 的浮动系数并叠加技能附加伤害；暴击概率为 `clamp(暴击率 + min(0.25, 灵运 × 0.0025), 0, 0.85)`，暴击时再乘暴击伤害系数。【F:cloudfunctions/pve/index.js†L1723-L1753】【F:cloudfunctions/pve/index.js†L1782-L1796】
   - 敌方伤害遵循 `max(5, 敌攻 − 防御 × 0.35)` 与 0.9~1.15 浮动，暴击概率与倍率取自敌方配置。【F:cloudfunctions/pve/index.js†L1723-L1724】【F:cloudfunctions/pve/index.js†L1799-L1807】
   - 闪避概率由技能提供的闪避值与灵运附加 `min(0.15, 灵运 × 0.001)` 叠加，最高 50%。【F:cloudfunctions/pve/index.js†L1688-L1699】
3. **幸运与额外效果**：灵运还会带来 20% 封顶的额外震荡伤害机会，以及提升掉落与灵石奖励的 Luck Bonus（掉落加成为 `min(0.2, 灵运 × 0.0015)`，灵石加成为 `min(0.3, 灵运 × 0.003)`）。【F:cloudfunctions/pve/index.js†L1784-L1793】【F:cloudfunctions/pve/index.js†L1835-L1844】【F:cloudfunctions/pve/index.js†L1823-L1825】
4. **奖励结算**：胜利时按配置发放灵石、属性点和掉落，灵石奖励会乘以 Luck Bonus，失败或平局不会发放修为；所有秘境战斗均返回 `exp: 0`，并额外提示“修为不可提升”。【F:cloudfunctions/pve/index.js†L1810-L1827】【F:cloudfunctions/pve/index.js†L2079-L2098】【F:cloudfunctions/pve/index.js†L1536-L1541】

## 云函数接口

新增 `pve` 云函数，核心动作如下：

| 动作 | 说明 |
| ---- | ---- |
| `profile` | 获取当前会员的 PVE 数值、装备、技能与副本列表，若缺失会自动初始化默认配置。 |
| `battle` | 挑战指定副本，返回战斗结果、奖励以及更新后的角色状态。 |
| `drawSkill` | 执行一次技能抽卡，返回抽取结果并更新技能背包。 |
| `equipSkill` | 装备/卸下技能，自动校验槽位数量。 |
| `equipItem` | 更换装备槽位。 |
| `allocatePoints` | 分配属性点，按服务端定义的步进值更新属性。 |

所有动作均会同步写回 `members` 表的 `pveProfile` 字段，并在需要时记录灵石流水（`stoneTransactions`）。

## 部署提示

1. 在云开发控制台创建或更新 `pve` 云函数，上传 `cloudfunctions/pve` 目录并安装依赖。
2. 重新上传小程序前端代码，确保新增页面、服务与配置生效。
3. 如需重置老用户数据，可在运营后台执行一次 `pve` 云函数的 `profile` 动作，或在数据库中删除 `pveProfile` 字段后重新进入页面。

通过上述体系，会员可在日常消费或活动中持续提升“战力”，运营侧可结合副本掉落、抽卡概率和任务奖励设计更丰富的玩法。
