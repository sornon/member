# PVE 副本与数值体系说明

为配合会员体系的数值化运营，小程序新增了“秘境试炼”模块，提供 RPG 式的 PVE 玩法。该模块覆盖属性成长、装备收集、技能抽卡与副本挑战，帮助运营团队在会员活动中引入持续性的成长线。

## 核心概念

### 角色属性

- **基础属性**：气血、攻击、防御、身法、灵运、暴击率、暴击伤害。初始化时会给予一套入门数值。
- **属性点**：通关副本或角色升级后获得。属性点可自由分配到气血、攻击、防御、身法、灵运五项基础属性，提升对应的数值。
- **成长曲线**：角色等级上限为 60 级，升级所需修为值随等级逐步递增（120 起，每级 +80）。每次升级额外获得 3~23 点属性点（随等级提升而增加）。

### 装备体系

- 装备分为 **武器**、**护具**、**饰品** 三个槽位，每件装备带有固定属性加成及稀有度标签（常见、稀有、史诗、传说）。
- 玩家默认拥有一套入门装备，后续可通过副本掉落或运营投放获取更高品质装备。
- 重复获取相同装备会提升“精炼等级”，在云函数中按装备系数放大加成。

### 技能体系

- 技能以卡牌形式存在，按稀有度划分为常见/稀有/史诗/传说，并可通过“抽取灵技”获得。
- 技能提供攻击加成、护盾、闪避等多种效果，同时可叠加到装备后的最终战力。
- 抽到重复技能会自动提升技能等级（上限 5 级），对应地增强加成或附加效果。

### 秘境副本

- 当前内置四个标识性副本（灵芽傀儡、炽火幽灵、渊狱巨灵、缚时织者），覆盖不同阶段的战力需求与掉落。
- 战斗流程采用回合制模拟，综合考虑攻击、防御、暴击、闪避等参数，产出详细战报与奖励。
- 奖励包含修为（用于升级）、灵石、属性点以及随机装备/技能掉落，并自动写入灵石流水。

## 前端交互

- 首页底部导航新增“秘境”入口，跳转至 `/pages/pve/pve` 页面。
- 页面包含以下模块：
  - **角色属性**：展示战力、修为进度、属性明细，并提供手动/自动分配属性点。
  - **装备总览**：显示当前穿戴与背包装备，可一键切换。
  - **技能与抽卡**：查看已装备技能、背包技能，支持抽取新技能。
  - **秘境对手**：列出可挑战副本、推荐战力与基础奖励。
  - **战斗记录**：展示最近战斗战报与技能抽卡历史。

## 云函数接口

新增 `pve` 云函数，核心动作如下：

| 动作 | 说明 |
| ---- | ---- |
| `profile` | 获取当前会员的 PVE 数值、装备、技能与副本列表，若缺失会自动初始化默认配置。 |
| `battle` | 挑战指定副本，返回战斗结果、奖励以及更新后的角色状态。 |
| `drawSkill` | 执行一次技能抽卡，返回抽取结果并更新技能背包。 |
| `equipSkill` | 装备/卸下技能，自动校验槽位数量。 |
| `equipItem` | 更换装备槽位。 |
| `allocatePoints` | 分配属性点，按服务端定义的步进值更新属性。 |

所有动作均会同步写回 `members` 表的 `pveProfile` 字段，并在需要时记录灵石流水（`stoneTransactions`）。

## 部署提示

1. 在云开发控制台创建或更新 `pve` 云函数，上传 `cloudfunctions/pve` 目录并安装依赖。
2. 重新上传小程序前端代码，确保新增页面、服务与配置生效。
3. 如需重置老用户数据，可在运营后台执行一次 `pve` 云函数的 `profile` 动作，或在数据库中删除 `pveProfile` 字段后重新进入页面。

通过上述体系，会员可在日常消费或活动中持续提升“战力”，运营侧可结合副本掉落、抽卡概率和任务奖励设计更丰富的玩法。
