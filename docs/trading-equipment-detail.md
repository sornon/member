# 交易中心装备详情持久化复盘

## 背景
交易中心的商品依赖玩家 `inventoryId` 在角色养成档案中查找装备资料。前端最初仅在本地缓存 `PveService.profile()` 的结果，一旦装备被上架，后端会从角色背包移除对应条目。刷新页面后，缓存失效且背包不再包含该装备，界面只能回退到占位文案“神秘装备”，并且失去了属性明细。

## 问题分析
- **后端设计缺口**：`tradeListings` 文档里的 `itemSnapshot` 只保留 `itemId`、`refine` 等基础字段，未存储任何展示用信息。
- **前端依赖易失缓存**：列表渲染始终通过背包缓存查找详情，刷新或重新进入页面后无法恢复。
- **数据同步流程断层**：上架流程未把选中装备的详情透传给后端，因此服务器即使想做兜底也缺乏数据来源。

## 改造方案
1. **前端提交详情快照**：
   - 在上架确认时提取所选装备的中文名、图标、品质、属性摘要等信息，并通过 `inventoryDetail` 一并提交。
   - 列表渲染时优先合并 `item.detail` 中的快照，再回退到角色档案缓存，确保刷新后仍能显示完整属性。
2. **后端持久化详情**：
   - 云函数校验 `inventoryId` 后，将客户端快照经字符串/数组清洗后写入 `itemSnapshot.detail`。
   - 所有返回的列表结构都会把快照与基础字段合并，供前端直接使用，无需依赖角色背包。
3. **复盘记录**：
   - 编写本文档，明确交易模块在涉及背包迁移时必须将展示所需数据一并持久化，避免再次出现刷新丢失信息的情况。

## 后续建议
- 评估是否需要在服务端自行装饰装备（例如引用共享装备库），以减少对客户端快照的依赖。
- 为交易链路补齐回归用例：创建挂单、刷新页面、查看详情，确保 UI 文案和属性完整可见。
