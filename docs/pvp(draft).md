# PVP 系统与分享传播功能设计（用于 Codex 开发）

## 一、现有代码与项目进度评估

通过分析仓库 sornon/member 的代码和文档，项目目前已经实现了完整的**会员体系**（注册、充值、等级成长、任务与优惠券、权益管理、预订、钱包与灵石账户、虚拟形象等），并搭建了 RPG 式的**PVE 副本体系**，包括基础属性计算、装备系统、技能卡牌抽取与战斗模拟。文档中详细说明了六维属性映射、装备稀有度、技能结构与品质梯度，以及秘境副本和奖励机制；云函数 pve 提供了角色资料、战斗、抽卡、装备管理等接口 。目前仓库 **没有 PVP 相关代码**，也没有成员间互动或排行榜功能，因此在现有基础上引入 PVP 系统将是一个全新的模块。

现有系统提供的数据模型和云函数已具备以下特点：
* **角色面板完备**：六维属性可映射到 HP、攻击、防御、速度、命中/闪避、暴击等战斗参数 。
* **装备与技能可自由组合**：装备库和技能库定义了品质、成长、触发条件与元素联动 。
* **战斗模拟已有框架**：PVE 战斗采用回合制模拟，具备命中判定、暴击、增减伤、生存/平局规则等 。
* **任务与奖励引擎**：任务系统支持签到、拉新、消费返券等多种任务，奖励可以发放优惠券、积分或虚拟物品。

⠀
基于这些基础，PVP 系统可以复用角色数据、战斗公式和任务引擎，只需新增匹配、对战、排行榜与社交分享相关逻辑。

## 二、PVP 系统设计目标

为了激发会员的胜负欲并促进用户自传播，PVP 功能需要兼顾公平性、成长动力与分享性。设计目标包括：
1. **竞争性**：提供实时或异步的对战体验，让会员与其他玩家比较战力，获得胜负反馈，并赋予胜者积分或奖励。
2. **阶梯式激励**：构建可持续的积分/段位体系，分段奖励可配置，既鼓励竞技也避免高压；采用多级目标和进度条，符合游戏化理论中“多层奖励和难度控制”的建议 。
3. **双向互动与社交裂变**：支持邀请好友对战、分享战报/排名至微信群，邀请双方均可领取礼包，形成裂变传播链条 。
4. **虚拟奖励驱动消费**：PVP 奖励以虚拟物品为主（称号、头像框、灵石等），搭配实体消费权益（如折扣券、限时礼包），通过任务系统控制成本并引导店内消费。
5. **数据安全与防刷**：所有对战结算需由云函数模拟并签名，防止伪造战报；匹配及分享接口要限制频率、防止刷分或刷任务。

⠀
## 三、功能模块设计

### 1. 基础数据模型
| **数据集合/字段** | **作用** | **设计要点** |
|:-:|:-:|:-:|
| pvpProfile | 每个会员一条，记录当前段位、积分、胜负场次、历史最高排名、赛季时间戳、最近对战时间等 | 初始化时基于 pveProfile 派生基础战力；积分和段位可配置；提供升级记录与退段保护。 |
| pvpSeason | 存储当前赛季配置（开始/结束时间、赛季奖励、段位阈值、赛季任务） | 便于运营周期性重置与奖励发放。 |
| pvpMatches | 记录对战过程、参赛双方、战斗日志、结果、积分变化等 | 战斗日志包括双方装备、技能、随机种子以供审计；支持回放功能。 |
| pvpLeaderboard | 存储每周/每赛季排行榜缓存结果（排名、会员ID、段位、积分） | 便于高并发读取；异步任务定时更新。 |
| pvpInvites | 记录邀请挑战的发起者、接受者、状态和过期时间 | 用于分享卡片和双向奖励判定。 |
### 2. 云函数接口

创建新的云函数 pvp，提供以下动作（Action）：
| **动作名称** | **说明** | **关键参数** | **备注** |
|:-:|:-:|:-:|:-:|
| profile | 获取或初始化当前会员的 PVP 资料（包括段位、积分、赛季信息） | memberId | 若不存在则创建默认 pvpProfile；同步 pveProfile 战力。 |
| matchRandom | 随机匹配一名实力相近的玩家并模拟战斗，返回结果与积分变化 | memberId | 匹配算法按积分区间、等级和最近匹配时间过滤；使用 pve 模块的战斗模拟器并固定随机种子。 |
| matchFriend | 与指定好友对战，支持邀请链接/邀请码对局 | memberId, targetId, seed | 若双方均在线，实时返回结果；否则采用异步模拟。 |
| battleReplay | 根据 matchId 获取战斗过程与回放数据 | matchId | 用于前端回放或分享。 |
| getLeaderboard | 获取当前段位/积分排行榜，可分日榜、周榜、赛季榜 | type, limit | 读取 pvpLeaderboard 缓存。 |
| claimSeasonReward | 赛季结束后领取对应段位奖励 | memberId | 限制领取一次；写入 pvpProfile 标记。 |
| sendInvite | 生成 PVP 邀请（携带随机种子、过期时间），返回分享卡所需参数 | memberId, channel | channel 表示分享渠道（群聊/好友）；云函数保存 pvpInvites 并返回 inviteId。 |
| acceptInvite | 接受邀请挑战并模拟战斗，更新双方结果 | memberId, inviteId | 校验邀请有效性与过期时间；奖励双向发放。 |
所有战斗结算必须在服务端完成，并生成签名哈希返回前端，以防止前端篡改结果。

### 3. 匹配与段位规则
1. **积分与段位结构**：参考传统竞技场，将段位分为铜、银、金、白金、钻石、宗师等，区间分配积分范围。例如铜段 0–999 分，银段 1000–1999 分……高段可以再细分星级。每次胜利获得基础积分（如 +30），失败扣减（如 -20），连胜/连败提供额外加成/保护。
2. **赛季制**：每个赛季建议 1–3 个月，赛季结束时重置积分并发放赛季奖励；保留历史最高段位供展示。赛季任务可结合 PVE 活动或店内消费，完成后额外加分。
3. **匹配算法**：按积分区间、最近几场胜负关系、会员等级、进入时间等维度综合匹配，确保匹配到实力相近的对手，缩短等待时间。若超过一定时长，可放宽区间或匹配机器人（基于固定战力配置的 AI）。
4. **战斗方式**：复用 PVE 战斗逻辑，不需要实时帧同步；所有技能、装备按当前数据计算，使用随机种子保证双方战报一致；控制 15 回合内分出胜负，超时判定为平局，双方各得少量积分。
5. **天梯护盾**：为避免高段玩家匹配失败导致快速掉段，可设计保护机制：当积分处于该段位的下限区间时，第一次失败不扣分，第二次才扣；或通过消耗积分保护卡维持段位。

⠀
### 4. 玩法与任务设计

**4.1 日常/每周任务**
* **PVP 初体验奖励**：首次完成 PVP 匹配并生成战报即可领取灵石或抽卡券，提高入门意愿。
* **每日三战**：每日参与 3 场竞技可得签到积分，鼓励稳定活跃；胜利额外奖励积分或优惠券。
* **连胜任务**：设置连胜档位（2 连胜、4 连胜、7 连胜），完成后获得虚拟称号或限时称号框，激发胜负欲。
* **邀请对战**：邀请好友完成对局，邀请人与被邀请人各获奖励，奖励内容可通过后台配置；鼓励用户分享和拉新 。
* **观战分享**：观战他人比赛并分享战报截图到微信群可获得小奖励；利用用户好奇心传播游戏。

⠀
**4.2 阶梯式奖励**

根据积分/段位设置阶梯奖励，参考会员阶梯体系，完成以下条件即可领取：
1. **升段奖励**：每次升段发送灵石、抽卡券或专属称号，奖励仅发一次；鼓励冲段。
2. **段位结算奖励**：赛季结算时按段位发放礼包，包括优惠券、实体折扣券、限定外观等，结合成本控制。 提到多级奖励能够持续驱动用户。
3. **连胜礼包**：连胜达到特定场次可领取对应礼包，若连败则重置，增强刺激性。

⠀
### 5. 社交分享与裂变设计
1. **战报分享卡片**：对战结束后自动生成分享卡（含双方昵称、战斗结果、关键伤害数据、个人段位），用户可一键分享到微信群或朋友圈；点击卡片可跳转到小程序 PVP 页面或观看回放。
2. **邀请链接/邀请码**：sendInvite 返回邀请链接和二维码，用户分享给好友即可快速进入挑战；同时自动携带邀请人 ID，用于发放双向奖励。
3. **分享排行榜**：每周或赛季初期自动推送排行榜前十名单，可带有闪耀边框或特殊标识，用户点击后可查看完整榜单；榜单页面提供分享按钮，促进炫耀传播。
4. **邀请助战**：引入“助战”功能，被邀请的好友在自己的回合对目标造成一次额外打击或提供 buff，完成助战后双方都获奖励；使用分享链接召唤助战，可以提高分享的趣味性和互动性。
5. **分享冷却与风控**：为防止刷分享任务，系统记录每个会员每天的分享次数和有效点击，超过上限则不再计入奖励；分享点击必须由新访客触发才有效。 强调要针对不同分享形式设置任务门槛，避免频繁刷任务。

⠀
### 6. 防刷与安全机制
* **战斗结果签名**：服务端战斗模拟完成后，生成结果摘要（如 MD5 签名）返回给前端；前端上传的战报必须包含签名并由云函数校验，避免篡改。
* **限时匹配**：同一账号在短时间内重复匹配同一对手会降低积分收益，防止双方串分。
* **邀请校验**：pvpInvites 表记录邀请状态与过期时间，未接受前不可重复领取奖励；超过有效期后自动失效。
* **异常检测**：定期扫描异常战斗日志，如短时间大量战斗或胜率异常，自动标记并需要人工审核。
* **数据统计**：埋点记录每次匹配、胜负、分享、领奖等事件，供 BI 分析与风控算法迭代。

⠀
### 7. 小程序前端设计与交互
1. **PVP 入口**：在底部导航或首页入口增加“竞技场”按钮，显示当前段位与积分；入口未解锁时可提示达到某等级/完成新手任务开启。
2. **匹配界面**：点击“随机匹配”后进入匹配等待动画，显示匹配提示及预计等待时间；匹配成功后切换至战斗页面。
3. **战斗呈现**：沿用 PVE 的回合制战斗 UI，提供回合数、双方血条、技能释放动画；可加入弹幕效果显示暴击/闪避提示；战斗结束后展示胜负及积分变化。
4. **排行榜页面**：分页显示前 100 名玩家，点击头像查看对方 PVP 面板（装备、技能、胜负场次）；有搜索框可查好友排名；每个排名条目提供“挑战”按钮快速发起好友挑战。
5. **邀请分享**：在战斗结算和排行榜页面提供“挑战好友”、“分享战报”按钮，点击后调用 sendInvite 云函数，生成分享卡片或二维码，并通过微信分享 API 推送到群聊或好友会话。
6. **赛季结算提示**：赛季结束前一周在首页推送倒计时提示，鼓励冲刺排名；赛季结束后弹窗引导领取赛季奖励并查看新赛季规则。

⠀
## 四、任务拆分与验证标准

为便于在 Codex 中落地开发，建议将 PVP 功能拆分为以下任务卡片（可依次或并行提交），每个任务需在 AGENTS.md 中指定质量标准并附带接口说明：
1. **任务 1：数据模型与云函数骨架**
   * 创建 pvpProfile, pvpSeason, pvpMatches, pvpLeaderboard, pvpInvites 集合及其索引；
   * 新增 pvp 云函数目录，定义 profile, matchRandom, matchFriend, battleReplay 等动作的入口函数（返回占位数据）。
   * 编写单元测试确保集合初始化及基本校验逻辑正确（≥70% 覆盖率）。
2. **任务 2：匹配与战斗模拟**
   * 实现随机匹配算法和指定好友匹配逻辑，复用 pve 模块的战斗模拟函数；
   * 战斗结果由服务端计算并记录到 pvpMatches；返回战报摘要和积分变化；
   * 单元测试覆盖不同段位匹配规则、胜负结算和连胜保护机制。
3. **任务 3：排行榜与赛季**
   * 实现 getLeaderboard、claimSeasonReward 动作，编写定时任务刷新排行榜缓存；
   * 设计赛季配置文档和奖励模板，可在后台更新；
   * 编写 E2E 测试验证赛季重置、段位奖励发放和排行榜展示。
4. **任务 4：社交邀请与分享**
   * 实现 sendInvite、acceptInvite 云函数，生成分享卡片所需参数（邀战链接、随机种子、过期时间、签名）；
   * 更新小程序前端：新增分享按钮、生成海报/小程序卡片、处理邀请链接跳转；
   * 防刷验证：限制每日邀请次数，校验邀请来源并分配双向奖励。
5. **任务 5：前端页面与交互**
   * 新增 /pages/pvp/index、/pages/pvp/leaderboard、/pages/pvp/battle 等页面；
   * 页面逻辑包含匹配动画、战斗展示、战报回放、排行榜滚动、赛季提示等；
   * 通过 E2E 测试（Playwright/Cypress）验证核心闭环：匹配→战斗→分享→查看排行榜→领取奖励。
6. **任务 6：监控与风控**
   * 在云函数中加入请求签名验证、防重放和速率限制；
   * 增加异常战斗检测脚本，自动标记可疑账号；
   * 埋点上报 pvp_match, pvp_win, pvp_loss, pvp_share, pvp_invite 等事件，记录用户行为供数据分析。

⠀
每个任务卡片应遵循项目的 AGENTS.md 中的工程规范，并在提交 PR 时附带测试报告、数据库迁移脚本和变更说明。

### 参考依据
* **分享任务与双向激励**：Woshipm 关于小程序裂变的实践指出，分享物料可以包括文字、H5 网页、图文或小程序卡片，邀请双方都应获得奖励，配合阶梯任务设计以促进持续分享 。
* **游戏化设计原则**：WishMobile 在“游戏化策略”文章中强调，要设置清晰目标与多层次奖励，控制难度曲线，结合社交竞争与进度提示，从数据分析中优化玩法 。PVP 系统的段位、连胜任务与赛季制度均体现了这些原则。
* **技能与战斗框架**：当前技能系统重构方案定义了品质梯度、元素联动和战斗操作流程，可直接用作 PVP 的战斗模拟基础 。