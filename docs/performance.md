# 接口性能优化方案

## 背景

早期版本将改名记录、头像解锁、等级奖励等持续累积的数据直接挂载在 `members` 文档上。随着用户活跃度提升，这些数组字段会不断增长，导致：

- 单个会员文档体积膨胀，`get` 操作延迟增加；
- 实时监听与页面初始化需要传输大量冗余数据，影响首屏体验；
- 更新任一增长字段时需要写入整个文档，增加冲突概率。

## 优化措施

1. **拆分增长型数据**
   - 新增 `memberExtras` 集合存储 `avatarUnlocks` 与 `claimedLevelRewards` 等扩展字段，文档 `_id` 与会员 `openid` 对齐，便于直查。
   - 新增 `memberTimeline` 集合记录改名日志等事件流水，按需分页查询，默认仅加载最近记录。
   - 新增 `memberPveHistory` 集合承载 `battleHistory` 与 `skillHistory`，默认保留最近 15 / 30 条记录，避免频繁战斗导致 `members` 文档膨胀。
2. **懒加载 + 归一化**
   - `member` 云函数在装载档案时合并 `memberExtras` 数据并补齐默认值，同时迁移历史字段，保持接口兼容。
   - 实时监听同时关注 `members` 与 `memberExtras` 两个集合，一旦扩展数据更新即可触发页面刷新。
3. **后台操作同步**
   - 管理端更新会员信息时分别写入基础档案与扩展集合，并把改名行为追加到 `memberTimeline`，确保审计链完整。
4. **部署辅助**
   - `bootstrap` 云函数新增对 `memberExtras`、`memberTimeline` 集合的初始化，避免遗漏。

## 效果

- 单次会员资料查询的文档体积显著下降，接口响应时间与带宽开销同步减少。
- 改名、头像解锁等高频增长场景不再拖慢基础档案读取，页面渲染更加流畅。
- PVE 战斗与技能日志迁移至独立集合后，实时订阅仅需监听精简的 `members` 档案，大幅减少每次同步的 JSON 体积。
- 扩展数据独立存储，后续可按需新增索引或冷热分层，便于长期运维。

## 后续建议

- 为 `memberTimeline` 设计按类型的过期策略（如只保留最近一年记录），进一步控制存储成本。
- 若未来扩展更多成长数据，可参考同样的拆分模式，将其纳入独立集合并在接口层做聚合。
